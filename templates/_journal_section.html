<style>
    .journal-container { display: flex; gap: 25px; align-items: flex-start; }
    /* FIX: Sticky Left Column */
    .session-list-column {
        flex: 0 0 450px;
        /* Keeps the list pinned to the screen while you scroll the long report on the right */
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
    }

    /* FIX: Uncapped Right Column */
    .session-detail-column {
        flex: 1 1 auto;
        /* Removing max-height/overflow here eliminates the nested "double" scrollbar */
        padding-right: 15px;
    }
    .detail-tabs-container { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ccc; }
    .detail-tab-button { padding: 8px 16px; cursor: pointer; border: none; background-color: transparent; color: #555; border-bottom: 2px solid transparent; font-size: 15px; }
    .detail-tab-button.active { color: #83b4c5; border-bottom-color: #83b4c5; font-weight: 600; }
    .detail-tab-content { display: none; }
    .detail-tab-content.active { display: block; } /* REVERT: Simple display for tab content */

    /* (CSS removed: Alignment handled via inline Flexbox properties below) */

    /* Controls visibility based on mode */
    .view-mode { display: block; } /* REVERT: Simple display for view mode */
    .edit-mode-form { display: none; }
    .is-editing .view-mode, .is-adding .view-mode { display: none; }
    .is-editing .edit-mode-form, .is-adding .edit-mode-form { display: block; }

    /* Hide summary tab button in edit/add modes */
    .is-editing .detail-tab-button[data-tab="summary"],
    .is-adding .detail-tab-button[data-tab="summary"] { display: none; }

    /* Hide report tab button in edit/add modes */
    .is-editing .detail-tab-button[data-tab="report"],
    .is-adding .detail-tab-button[data-tab="report"] { display: none; }

    /* Hide old sky tab button in view mode */
    .detail-tab-button[data-tab="sky"] { display: none; }


    /* Report Preview Styles */
    .report-preview-container {
        background-color: #525659;
        padding: 20px;
        border-radius: 4px;
        text-align: center;
    }
    .report-iframe {
        width: 100%;
        max-width: 210mm;
        /* FIX: Height is now handled by JS auto-resize */
        min-height: 800px;
        border: none;
        background-color: white;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
        display: block;
        margin: 0 auto;
    }
    .report-toolbar {
        margin-bottom: 15px;
        display: flex;
        justify-content: flex-end;
        max-width: 210mm;
        margin-left: auto;
        margin-right: auto;
    }

    /* Other styles remain the same */
    .summary-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 20px; text-align: center; padding: 15px; background-color: #e9ecef; border-radius: 6px; margin-bottom: 25px; }
    .summary-box .stat-value { font-size: 1.4em; font-weight: 600; color: #343a40; display: block; }
    .summary-box .stat-label { font-size: 0.8em; color: #6c757d; text-transform: uppercase; }
    .detail-grid { display: grid; grid-template-columns: max-content 1fr; gap: 12px 20px; align-items: flex-start; }
    .detail-grid > dt { font-weight: 600; color: #495057; }
    .detail-grid > dd { margin: 0; color: #212529; }
    .notes-block { margin-top: 8px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; white-space: pre-wrap; min-height: 60px; }
    .session-list-column h4, .session-detail-column h4 { font-size: 1.2em; font-weight: 600; margin-top: 0; margin-bottom: 0; color: #343a40; }

    /* Form specific styles */
    .edit-mode-form .form-group input,
    .edit-mode-form .form-group textarea,
    .edit-mode-form .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
    .edit-mode-form .form-group textarea { min-height: 100px; }

    .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75em; }
    .history-header .inline-button { font-size: 13px; padding: 6px 12px; margin-right: 0; }
    .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; }
    .detail-header .action-button-group { margin: 0; display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-end; }
    .form-group.full-width { flex-basis: 100%; }
    .form-group.full-width label { width: auto; }

    .session-history-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85em; }
    .session-history-table th, .session-history-table td { border: 1px solid #dde; padding: 6px 8px; text-align: left; vertical-align: middle; }
    .session-history-table th { background-color: #e9ecef; font-weight: 600; }
    .session-history-table tr.clickable-session-row:hover { background-color: #e6f7ff; cursor: pointer; }
    .session-history-table tr.current-session-item { background-color: #cfe2ff !important; font-weight: bold; }
    .session-history-table td.col-date, .session-history-table th.col-date { width: 120px; }
    .session-history-table td.col-integ, .session-history-table th.col-integ { width: 100px; text-align: center; }
    .session-history-table td.col-rating, .session-history-table th.col-rating { width: 100px; text-align: center; }

    /* Styles for the Journal Project View */
    .project-header-clickable {
        cursor: pointer;
        transition: background-color 0.2s;
        background-color: #f0f2f5;
        border-top: 2px solid #d1d9e6 !important;
    }
    .project-header-clickable:hover {
        background-color: #dbe4f0 !important;
    }
    .current-project-item {
        background-color: #cfe2ff !important;
        border-left: 4px solid #0056b3;
    }
    .journal-project-stat-box {
        padding: 12px; background-color: #e9ecef; border-radius: 6px; text-align: center; margin-bottom: 15px;
    }
    .journal-project-stat-value { font-size: 1.4em; font-weight: 600; color: #343a40; display: block; }
    .journal-project-stat-label { font-size: 0.75em; color: #6c757d; text-transform: uppercase; }
    .journal-project-notes-section {
        margin-top: 15px; padding: 15px; border: 1px solid #dee2e6; border-radius: 6px; background-color: #fff;
    }
    .journal-project-notes-section h3 {
        font-size: 1.1em; margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px;
    }
    .journal-project-container {
        display: flex; flex-direction: column; gap: 15px;
    }

    /* FIX: Constrain images in notes (View & Edit modes) */
    trix-editor figure, trix-editor figure.attachment, .trix-content figure.attachment, .project-notes-section figure.attachment {
        max-width: 100% !important;
        width: auto !important;
        margin: 0 auto 1em auto;
    }

    trix-editor img, .trix-content img, .notes-block img, .notes-content img, .project-notes-section img {
        max-width: 100% !important;
        max-height: 400px !important;
        height: auto !important;
        width: auto !important;
        border-radius: 4px;
        display: block;
        object-fit: contain;
    }

    /* FIX: Hide Trix metadata (filenames) - High Specificity for Edit Mode */
    trix-editor .attachment__caption, trix-editor .attachment__name, trix-editor .attachment__size,
    .trix-content .attachment__caption, .trix-content .attachment__name, .trix-content .attachment__size,
    .attachment__caption, .attachment__name, .attachment__size {
        display: none !important;
        visibility: hidden !important; /* Extra measure to ensure invisibility */
    }
</style>

<div class="journal-container">
    <div class="session-list-column">
        <div class="history-header">
            <h4>Session History:</h4>
            <div style="display: flex; gap: 8px;">
                <button type="button" class="inline-button" style="padding: 6px 12px; font-size: 13px;" onclick="setupAddProjectMode()">Add New Project</button>
                <button type="button" class="inline-button" style="padding: 6px 12px; font-size: 13px;" onclick="setupAddMode()">Add New Session</button>
            </div>
        </div>
        <div class="table-wrapper" style="border-top: 1px solid #dee2e6;">
            <table class="session-history-table">
                <thead><tr><th class="col-date">Date & Location</th><th class="col-integ">Integ.</th><th class="col-rating">Rating</th></tr></thead>
                <tbody>
                {% for group in grouped_sessions %}
                    <tr>
                        <th colspan="3"
                            class="{{ 'project-header-clickable' if group.is_project else '' }} {{ 'current-project-item' if group.is_project and group.project_id|string == current_project_id|string else '' }}"
                            style="padding: 8px 5px; border-top: 1px solid #ddd;"
                            {% if group.is_project %}
                            {# Fix: Pass current location to prevent fallback to default #}
                            onclick="loadSessionViaAjax(event, '{{ url_for('graph_dashboard', object_name=object_name, tab='journal', project_id=group.project_id, location=header_location_name) }}', this)"
                            title="Click to view project details"
                            {% endif %}
                        >
                            {% if group.is_project %}{% set project_total_h = (group.total_integration_time / 60) | round(1) %}
                                Project: {{ group.project_name }}
                                {% if project_total_h > 0 %}<span style="font-weight: normal; color: #777; font-size: 0.9em; margin-left: 8px;">(Total: {{ project_total_h }}h)</span>{% endif %}
                            {% else %}{{ group.project_name }}{% endif %}
                        </th>
                    </tr>
                    {% for session_item in group.sessions %}
                        <tr class="clickable-session-row {{ 'current-session-item' if session_item.id|string == current_session_id|string else '' }}"
                            onclick="loadSessionViaAjax(event, '{{ url_for('graph_dashboard', object_name=object_name, session_id=session_item.id, location=session_item.location_name) }}&tab=journal', this)">
                            <td class="col-date">{{ session_item.date_utc | date_eu | default("-") }}<br><small style="color:#555;">{{ session_item.location_name | default("-") }}</small></td>
                            <td class="col-integ">{% set integ_min = session_item.calculated_integration_time_minutes %}{{ integ_min | round(0) if integ_min is number else '-' }} min</td>
                            <td class="col-rating">{{ session_item.session_rating_subjective | default("-") }}{% if session_item.session_rating_subjective %} ★{% endif %}</td>
                        </tr>
                    {% endfor %}
                {% endfor %}
                </tbody>
            </table>
        </div>
        <p id="journal-loading-indicator" style="display: none; text-align: center; color: #666; margin-top: 15px;">Loading history...</p>
    </div>

    <div class="session-detail-column">
        <div id="session-detail-wrapper" class="{{ 'is-editing' if request.args.get('edit') == 'true' else '' }}">

            {# --- VIEW MODE: SESSION SELECTED --- #}
            {% if selected_session_data %}
                {% set entry = selected_session_data_dict %}

                {# --- Macro to safely display a value or a dash, handling 'None' string explicitly --- #}
                {% macro display_safe_value(value) -%}
                    {% if value is number or (value is string and value|lower != 'none' and value|length > 0) -%}
                        {{ value }}
                    {% else -%}
                        -
                    {% endif -%}
                {% endmacro -%}

                <div class="detail-header view-mode">
                    <h4 id="detail-title">Details for Session: {{ entry.date_utc | date_eu }}</h4>
                    <div class="action-button-group">
                        <button type="button" class="inline-button" style="background-color:#ffc107; color:black;" onclick="setupEditMode()">Edit This Session</button>
                        <form action="{{ url_for('journal_duplicate', session_id=entry.id) }}" method="POST" style="display:inline; margin: 0;">
                            <button type="submit" class="inline-button" style="background-color:#17a2b8;" title="Create a copy of this session">Duplicate</button>
                        </form>
                        <form action="{{ url_for('journal_delete', session_id=entry.id) }}" method="POST" style="display:inline; margin: 0;" onsubmit="return confirm('Are you sure you want to delete this session permanently?');">
                            <button type="submit" class="inline-button" style="background-color:#dc3545;">Delete This Session</button>
                        </form>
                    </div>
                </div>

                {# --- View Tabs (Updated to match PDF structure) --- #}
                <div class="detail-tabs-container view-mode">
                    <button type="button" class="detail-tab-button active" data-tab="summary" onclick="showDetailTab('summary')">Summary</button>
                    <button type="button" class="detail-tab-button" data-tab="acq" onclick="showDetailTab('acq')">Equipment & Acquisition</button>
                    <button type="button" class="detail-tab-button" data-tab="outcome" onclick="showDetailTab('outcome')">Calibration & Outcome</button>
                    <button type="button" class="detail-tab-button" data-tab="report" onclick="showDetailTab('report')">Session Report</button>
                </div>

                <div class="view-mode">
                    <div id="summary-tab" class="detail-tab-content active">
                         <div class="summary-box">
                            <div class="stat"><span class="stat-value">{{ display_safe_value(entry.seeing_observed_fwhm) }}{% if entry.seeing_observed_fwhm and entry.seeing_observed_fwhm|lower != 'none' %}"{% endif %}</span><span class="stat-label">SEEING (FWHM)</span></div>
                            <div class="stat"><span class="stat-value">{{ display_safe_value(entry.guiding_rms_avg_arcsec) }}{% if entry.guiding_rms_avg_arcsec and entry.guiding_rms_avg_arcsec|lower != 'none' %}"{% endif %}</span><span class="stat-label">GUIDING (RMS)</span></div>
                            <div class="stat"><span class="stat-value">{{ display_safe_value(entry.sky_sqm_observed) }}</span><span class="stat-label">SKY QUALITY (SQM)</span></div>
                            <div class="stat">
                                <span class="stat-value">
                                    {% set mono_filters = ['L', 'R', 'G', 'B', 'Ha', 'OIII', 'SII'] %}
                                    {% set has_mono_data = namespace(found=false) %}
                                    {% for filt_key in mono_filters %}
                                        {% if entry['filter_' ~ filt_key ~ '_subs'] or entry['filter_' ~ filt_key ~ '_exposure_sec'] %}
                                            {% set has_mono_data.found = true %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if has_mono_data.found %}
                                        Multiple
                                    {% else %}
                                        {{ display_safe_value(entry.number_of_subs_light) }}x{{ display_safe_value(entry.exposure_time_per_sub_sec) }}s
                                    {% endif %}
                                </span><span class="stat-label">EXPOSURES</span>
                            </div>
                        </div>
                        <dl class="detail-grid">
                            <dt>Filter:</dt><dd>{{ display_safe_value(entry.filter_used_session) }}</dd>

                            {# Display Rig/Setup Details on Summary Tab #}
                            {% if entry.rig_name_snapshot %}
                                <dt>Rig Used:</dt><dd>{{ display_safe_value(entry.rig_name_snapshot) }}</dd>
                                <dt>Rig Specs:</dt>
                                <dd style="font-size: 0.9em; line-height: 1.4;">
                                    Telescope: {{ display_safe_value(entry.telescope_name_snapshot) }}<br>
                                    Camera: {{ display_safe_value(entry.camera_name_snapshot) }}<br>
                                    FL: {{ entry.rig_efl_snapshot | round(0) if entry.rig_efl_snapshot is number else '-' }} mm (f/{{ entry.rig_fr_snapshot | round(1) if entry.rig_fr_snapshot is number else '-' }})<br>
                                    Scale: {{ entry.rig_scale_snapshot | round(2) if entry.rig_scale_snapshot is number else '-' }}"/px
                                </dd>
                                {% if entry.telescope_setup_notes %}
                                    <dt>Setup Notes:</dt><dd>{{ display_safe_value(entry.telescope_setup_notes) }}</dd>
                                {% endif %}
                            {% else %}
                                <dt>Telescope Setup:</dt><dd>{{ display_safe_value(entry.telescope_setup_notes) }}</dd>
                            {% endif %}

                            {% if entry.session_image_file %}
                                <dt style="grid-column: 1 / -1;">Session Image:</dt>
                                <dd style="grid-column: 1 / -1; margin-top: 8px;">
                                    {% set image_username = current_user.username if not SINGLE_USER_MODE else 'default' %}
                                    <a href="{{ url_for('get_uploaded_image', username=image_username, filename=entry.session_image_file) }}" target="_blank" title="Click to view full size">
                                        <img src="{{ url_for('get_uploaded_image', username=image_username, filename=entry.session_image_file) }}" alt="Session Image" style="max-width: 100%; max-height: 400px; border-radius: 6px; border: 1px solid #ddd; display: block; object-fit: contain;">
                                    </a>
                                </dd>
                            {% endif %}
                        </dl>
                    </div>

                    {# --- UPDATED: EQUIPMENT & ACQUISITION Tab (Contains Sky, Rig, Guiding, and ACQ details) --- #}
                    <div id="acq-tab" class="detail-tab-content">
                        <h5 style="font-size: 1em; font-weight: 700; color: #495057; margin-bottom: 10px;">Statistics & Conditions</h5>
                        <dl class="detail-grid">
                            <dt>Seeing (FWHM):</dt><dd>{{ display_safe_value(entry.seeing_observed_fwhm) }}{% if entry.seeing_observed_fwhm and entry.seeing_observed_fwhm|lower != 'none' %}"{% endif %}</dd>
                            <dt>Guiding RMS:</dt><dd>{{ display_safe_value(entry.guiding_rms_avg_arcsec) }}{% if entry.guiding_rms_avg_arcsec and entry.guiding_rms_avg_arcsec|lower != 'none' %}"{% endif %}</dd>
                            <dt>SQM:</dt><dd>{{ display_safe_value(entry.sky_sqm_observed) }}</dd>
                            <dt>Transparency Scale:</dt><dd>{{ display_safe_value(entry.transparency_observed_scale) }}</dd>
                            <dt>Moon Illum/Sep:</dt><dd>{{ display_safe_value(entry.moon_illumination_session) }}% / {{ display_safe_value(entry.moon_angular_separation_session) }}°</dd>
                            <dt>Weather Notes:</dt><dd><div class="notes-block" style="min-height: auto;">{{ display_safe_value(entry.weather_notes) }}</div></dd>
                        </dl>

                        <div style="grid-column: 1 / -1; border-top: 1px solid #eee; margin-top: 15px; padding-top: 15px;"></div>

                        <h5 style="font-size: 1em; font-weight: 700; color: #495057; margin-bottom: 10px;">Equipment & Acquisition Details</h5>
                        <dl class="detail-grid">
                            {% if entry.rig_name_snapshot %}
                                <dt>Rig Used:</dt>
                                <dd>{{ display_safe_value(entry.rig_name_snapshot) }}</dd>
                                <dt>Telescope:</dt>
                                <dd>{{ display_safe_value(entry.telescope_name_snapshot) }}</dd>
                                {% if entry.reducer_name_snapshot %}
                                    <dt>Reducer/Ext.:</dt>
                                    <dd>{{ display_safe_value(entry.reducer_name_snapshot) }}</dd>
                                {% endif %}
                                <dt>Camera:</dt>
                                <dd>{{ display_safe_value(entry.camera_name_snapshot) }}</dd>
                                <dt>Rig Specs:</dt>
                                <dd style="font-size: 0.9em; line-height: 1.4;">
                                    FL/Ratio: {{ entry.rig_efl_snapshot | round(0) if entry.rig_efl_snapshot is number else '-' }} mm (f/{{ entry.rig_fr_snapshot | round(1) if entry.rig_fr_snapshot is number else '-' }})<br>
                                    Scale: {{ entry.rig_scale_snapshot | round(2) if entry.rig_scale_snapshot is number else '-' }}"/px<br>
                                    FOV: {{ entry.rig_fov_w_snapshot | round(1) if entry.rig_fov_w_snapshot is number else '-' }}' &times; {{ entry.rig_fov_h_snapshot | round(1) if entry.rig_fov_h_snapshot is number else '-' }}'
                                </dd>
                                <dt>Setup Notes:</dt><dd>{{ display_safe_value(entry.telescope_setup_notes) }}</dd>
                            {% else %}
                                <dt>Telescope Setup:</dt><dd>{{ display_safe_value(entry.telescope_setup_notes) }}</dd>
                            {% endif %}

                            <dt>Guiding Equipment:</dt><dd>{{ display_safe_value(entry.guiding_equipment) }}</dd>
                            <dt>Acquisition Sw:</dt><dd>{{ display_safe_value(entry.acquisition_software) }}</dd>
                            <dt>Dither Settings:</dt><dd>{{ display_safe_value(entry.dither_details) }}</dd>
                            <dt>Binning:</dt><dd>{{ display_safe_value(entry.binning_session) }}</dd>
                            <dt>Gain / Offset:</dt><dd>{{ display_safe_value(entry.gain_setting) }} / {{ display_safe_value(entry.offset_setting) }}</dd>
                            <dt>Camera Temp (Set/Avg):</dt><dd>{{ display_safe_value(entry.camera_temp_setpoint_c) }}°C / {{ display_safe_value(entry.camera_temp_actual_avg_c) }}°C</dd>
                            <dt>Filter:</dt><dd>{{ display_safe_value(entry.filter_used_session) }}</dd>
                            <dt>Sub Exposure:</dt><dd>{{ display_safe_value(entry.exposure_time_per_sub_sec) }}s</dd>
                            <dt># Light Subs:</dt><dd>{{ display_safe_value(entry.number_of_subs_light) }}</dd>
                        </dl>

                        {% set mono_filters = [('L', 'Luminance'), ('R', 'Red'), ('G', 'Green'), ('B', 'Blue'), ('Ha', 'H-alpha'), ('OIII', 'OIII'), ('SII', 'SII')] %}
                        {% set has_mono_data = namespace(found=false) %}
                        {% for filt_key, _ in mono_filters %}
                            {% if entry['filter_' ~ filt_key ~ '_subs'] or entry['filter_' ~ filt_key ~ '_exposure_sec'] %}
                                {% set has_mono_data.found = true %}
                            {% endif %}
                        {% endfor %}
                        {% if has_mono_data.found %}
                            <div class="form-section-title" style="margin-top:25px;">Monochrome Exposures</div>
                            <dl class="detail-grid">
                            {% for filt_key, filt_name in mono_filters %}
                                {% set subs = entry['filter_' ~ filt_key ~ '_subs'] %}
                                {% set exp = entry['filter_' ~ filt_key ~ '_exposure_sec'] %}
                                {% if subs or exp %}
                                    <dt>{{ filt_name }} ({{ filt_key }}):</dt>
                                    <dd>{{ display_safe_value(subs) }} subs x {{ display_safe_value(exp) }}s</dd>
                                {% endif %}
                            {% endfor %}
                            </dl>
                        {% endif %}
                    </div>

                    {# --- UPDATED: CALIBRATION & OUTCOME Tab (Contains Calibration and Notes/Rating) --- #}
                    <div id="outcome-tab" class="detail-tab-content">
                        <h5 style="font-size: 1em; font-weight: 700; color: #495057; margin-bottom: 10px;">Calibration Strategy</h5>
                        <dl class="detail-grid">
                            <dt>Darks:</dt><dd>{{ display_safe_value(entry.darks_strategy) }}</dd>
                            <dt>Flats:</dt><dd>{{ display_safe_value(entry.flats_strategy) }}</dd>
                            <dt>Bias/DarkFlats:</dt><dd>{{ display_safe_value(entry.bias_darkflats_strategy) }}</dd>
                        </dl>

                        <div style="grid-column: 1 / -1; border-top: 1px solid #eee; margin-top: 15px; padding-top: 15px;"></div>

                        <h5 style="font-size: 1em; font-weight: 700; color: #495057; margin-bottom: 10px;">Outcome & Reflections</h5>
                        <dl class="detail-grid">
                            <dt>Session Rating:</dt><dd>{{ entry.session_rating_subjective | default('-') }}{% if entry.session_rating_subjective %} ★{% endif %}</dd>
                            <dt>Notes:</dt><dd style="grid-column: 2 / 2;"><div class="notes-block">{{ entry.notes | default('-') | safe }}</div></dd>
                        </dl>
                    </div>

                    <div id="report-tab" class="detail-tab-content">
                        <div class="report-preview-container">
                            <div class="report-toolbar">
                                <a href="{{ url_for('download_csv', item_type='session', item_id=entry.id) }}" class="inline-button" style="background-color:#17a2b8; text-decoration:none; color:white; margin-right: 10px; display:inline-flex; align-items:center;">
                                    Download CSV
                                </a>
                                <button type="button" class="inline-button" style="background-color:#007bff;"
                                        onclick="downloadVisibleReport('Nova_Report_{{ object_name | replace(' ', '_') }}_{{ entry.date_utc }}.pdf', this, 'report-preview-frame')">
                                    Download PDF
                                </button>
                            </div>
                            <iframe id="report-preview-frame" data-src="{{ url_for('show_journal_report_page', session_id=entry.id) }}" class="report-iframe" onload="resizeIframe(this)"></iframe>
                        </div>
                    </div>
                </div>

            {# --- VIEW MODE: PROJECT SELECTED --- #}
            {% elif selected_project_data_journal %}
                <div id="journal-project-view-wrapper">
                    <div class="detail-header">
                        <h4 id="detail-title">Project: {{ selected_project_data_journal.name }}</h4>
                        <div class="action-button-group">
                            <button type="button" class="inline-button" style="background-color:#ffc107; color:black;" onclick="toggleJournalProjectEdit(true)">Edit Project</button>

                            <form action="{{ url_for('delete_project', project_id=selected_project_data_journal.id) }}" method="POST" style="display:inline; margin: 0;" onsubmit="return confirm('Are you sure you want to delete this project? Linked sessions will become standalone.');">
                                <input type="hidden" name="redirect_object" value="{{ object_name }}">
                                <button type="submit" class="inline-button" style="background-color:#dc3545;">Delete Project</button>
                            </form>
                        </div>
                    </div>

                    <div class="detail-tabs-container view-mode">
                        <button type="button" class="detail-tab-button project-tab-btn active" data-ptab="overview" onclick="showProjectTab('overview')">Overview</button>
                        <button type="button" class="detail-tab-button project-tab-btn" data-ptab="report" onclick="showProjectTab('report')">Project Report</button>
                    </div>

                    <div id="project-overview-tab" class="project-tab-content" style="display:block;">
                        <div id="journal-project-view-mode" class="journal-project-container">
                            <div style="display: flex; gap: 15px;">
                                <div style="flex: 1;">
                                    <div class="journal-project-stat-box">
                                        <span class="journal-project-stat-value">{{ total_integration_str_journal }}</span>
                                        <span class="journal-project-stat-label">Total Integration</span>
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <div class="journal-project-stat-box">
                                        <span class="journal-project-stat-value">{{ selected_project_data_journal.status }}</span>
                                        <span class="journal-project-stat-label">Status</span>
                                    </div>
                                </div>
                            </div>

                            <div class="journal-project-notes-section">
                                <h3>Goals & Status</h3>
                                <div class="notes-content">{{ project_journal_html_fields.goals | default('No goals defined.', true) | safe }}</div>
                            </div>

                            {% if selected_project_data_journal.final_image_file %}
                            <div style="margin-top: 10px; text-align: left;">
                                {% set image_username = current_user.username if not SINGLE_USER_MODE else 'default' %}
                                <a href="{{ url_for('get_uploaded_image', username=image_username, filename=selected_project_data_journal.final_image_file) }}" target="_blank">
                                    <img src="{{ url_for('get_uploaded_image', username=image_username, filename=selected_project_data_journal.final_image_file) }}"
                                         alt="Final Project Image"
                                         style="max-width: 100%; max-height: 400px; border-radius: 6px; border: 1px solid #ddd; display: block; object-fit: contain; margin: 0;">
                                </a>
                                <span class="journal-project-stat-label" style="margin-top:5px; display:block;">Final Image</span>
                            </div>
                            {% endif %}

                            <div class="journal-project-notes-section">
                                <h3>Project Story & Learnings</h3>
                                <div class="notes-content">{{ project_journal_html_fields.description | default('No description added.', true) | safe }}</div>
                            </div>

                            <div class="journal-project-notes-section">
                                <h3>Framing Notes</h3>
                                <div class="notes-content">{{ project_journal_html_fields.framing | default('No framing notes added.', true) | safe }}</div>
                            </div>

                            <div class="journal-project-notes-section">
                                <h3>Processing Notes</h3>
                                <div class="notes-content">{{ project_journal_html_fields.processing | default('No processing workflow recorded.', true) | safe }}</div>
                            </div>
                        </div>
                    </div>

                    <div id="project-report-tab" class="project-tab-content" style="display:none;">
                        <div class="report-preview-container">
                            <div class="report-toolbar">
                                <a href="{{ url_for('download_csv', item_type='project', item_id=selected_project_data_journal.id) }}" class="inline-button" style="background-color:#17a2b8; text-decoration:none; color:white; margin-right: 10px; display:inline-flex; align-items:center;">
                                    Download CSV
                                </a>
                                <button type="button" class="inline-button" style="background-color:#007bff;"
                                        onclick="downloadVisibleReport('Nova_Project_{{ selected_project_data_journal.name | replace(' ', '_') }}.pdf', this, 'project-report-frame')">
                                    Download PDF
                                </button>
                            </div>
                            <iframe id="project-report-frame" data-src="{{ url_for('show_project_report_page', project_id=selected_project_data_journal.id) }}" class="report-iframe" onload="resizeIframe(this)"></iframe>
                        </div>
                    </div>

                    {# --- EDIT MODE: PROJECT (Unchanged, just kept in correct nesting) --- #}
                    <div id="journal-project-edit-mode" style="display:none;">
                       <form id="journal-project-edit-form" method="POST"
                              action="{{ url_for('project_detail', project_id=selected_project_data_journal.id, next=url_for('graph_dashboard', object_name=object_name, tab='journal', project_id=selected_project_data_journal.id, location=header_location_name)) }}"
                              enctype="multipart/form-data">

                            <div class="detail-header">
                                <h4 style="margin:0;">Editing Project</h4>
                                <div class="action-button-group">
                                    <button type="submit" class="inline-button" style="background-color:#28a745;">Save Project</button>
                                    <button type="button" class="inline-button" style="background-color:#6c757d;" onclick="toggleJournalProjectEdit(false)">Cancel</button>
                                </div>
                            </div>

                            <div class="journal-project-notes-section">
                                <h3>Metadata</h3>
                                <div class="form-group"><label for="project-name">Project Name:</label><input type="text" id="project-name" name="name" value="{{ selected_project_data_journal.name }}" required></div>
                                <input type="hidden" name="target_object_id" value="{{ object_name }}">
                                <div class="form-group"><label for="project-status">Status:</label>
                                    <select id="project-status" name="status">
                                        {% for status_option in project_statuses %}
                                        <option value="{{ status_option }}" {% if status_option == selected_project_data_journal.status %}selected{% endif %}>{{ status_option }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="journal-project-notes-section">
                                <div class="form-group trix-editor-container"><label>Goals & Status:</label>
                                    <input type="hidden" id="goals-hidden-journal" name="goals" value="{{ project_journal_html_fields.goals | safe }}">
                                    <trix-editor input="goals-hidden-journal" id="goals-editor-journal" style="min-height: 100px;"></trix-editor>
                                </div>
                            </div>

                            <div class="journal-project-notes-section">
                                <div class="form-group full-width">
                                    <h3>Final Image</h3>
                                    {% if selected_project_data_journal.final_image_file %}
                                        <p style="font-size:13px;">Current file: <code>{{ selected_project_data_journal.final_image_file }}</code></p>
                                        <label style="color: #c0392b; cursor: pointer;"><input type="checkbox" name="delete_final_image" value="1"> Delete Current Image</label>
                                        <hr class="detail-separator">
                                    {% endif %}
                                    <label for="final_image">Upload New Final Image (optional, max 5MB)</label>
                                    <input type="file" id="final_image" name="final_image" accept="image/jpeg, image/png, image/gif">
                                </div>
                            </div>

                            <div class="journal-project-notes-section">
                                <div class="form-group trix-editor-container"><label>Project Story & Learnings:</label>
                                    <input type="hidden" id="description-hidden-journal" name="description_notes" value="{{ project_journal_html_fields.description | e }}">
                                    <trix-editor input="description-hidden-journal" id="description-editor-journal" style="min-height: 150px;"></trix-editor>
                                </div>
                            </div>

                            <div class="journal-project-notes-section">
                                <div class="form-group trix-editor-container"><label>Framing Notes:</label>
                                    <input type="hidden" id="framing-hidden-journal" name="framing_notes" value="{{ project_journal_html_fields.framing | e }}">
                                    <trix-editor input="framing-hidden-journal" id="framing-editor-journal" style="min-height: 150px;"></trix-editor>
                                </div>
                            </div>

                            <div class="journal-project-notes-section">
                                <div class="form-group trix-editor-container"><label>Processing Notes:</label>
                                    <input type="hidden" id="processing-hidden-journal" name="processing_notes" value="{{ project_journal_html_fields.processing | e }}">
                                    <trix-editor input="processing-hidden-journal" id="processing-editor-journal" style="min-height: 150px;"></trix-editor>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

            {% else %}
                <div class="detail-header view-mode">
                    <h4 id="detail-title">No session selected</h4>
                </div>
                <p class="view-mode" style="color: #6c757d; margin-top: 20px;">Select a session or project from the list on the left to view details, or click 'Add New Session'.</p>
            {% endif %}

            {# --- ADD FORM (PROJECT) --- #}
            <div id="journal-project-add-mode" style="display:none;">
               <form id="journal-project-add-form" method="POST" action="{{ url_for('add_project_from_journal') }}">
                    <input type="hidden" name="current_location" value="{{ header_location_name }}">
                    <div class="detail-header">
                        <h4 style="margin:0;">Add New Project</h4>
                        <div class="action-button-group">
                            <button type="submit" class="inline-button" style="background-color:#28a745;">Create Project</button>
                            <button type="button" class="inline-button" style="background-color:#6c757d;" onclick="cancelForm()">Cancel</button>
                        </div>
                    </div>
                    <input type="hidden" name="target_object_id" value="{{ object_name }}">

                    <div class="journal-project-notes-section">
                        <h3>Metadata</h3>
                        <div class="form-group"><label for="new-project-name-add">Project Name:</label><input type="text" id="new-project-name-add" name="name" required placeholder="e.g., M31 Broadband" style="width:100%;"></div>
                        <div class="form-group"><label for="new-project-status-add">Status:</label>
                            <select id="new-project-status-add" name="status" style="width:100%;">
                                <option value="In Progress" selected>In Progress</option>
                                <option value="On Hold">On Hold</option>
                                <option value="Completed">Completed</option>
                                <option value="Abandoned">Abandoned</option>
                            </select>
                        </div>
                    </div>

                    <div class="journal-project-notes-section">
                        <div class="form-group trix-editor-container"><label>Goals & Status:</label>
                            <input type="hidden" id="goals-hidden-add" name="goals">
                            <trix-editor input="goals-hidden-add" id="goals-editor-add" style="min-height: 100px; background-color: #fff;"></trix-editor>
                        </div>
                    </div>
               </form>
            </div>

            {# --- EDIT/ADD FORM (SESSION) --- #}
            <form id="journal-detail-form" class="edit-mode-form" method="POST" action="" enctype="multipart/form-data">
                 <div class="detail-header">
                    <h4 id="form-detail-title">Edit Session</h4>
                    <div class="action-button-group">
                        <button id="form-submit-button" type="submit" form="journal-detail-form" class="inline-button">Save Changes</button>
                        <button id="form-cancel-button" type="button" class="inline-button" style="background-color:#6c757d;" onclick="cancelForm()">Cancel</button>
                    </div>
                </div>
                <input type="hidden" name="target_object_id" value="{{ object_name }}">
                <input type="hidden" name="session_id" value="{{ selected_session_data.id if selected_session_data else '' }}">
                <div class="form-row">
                    <div class="form-group"><label for="session_date">Session Date:</label><input type="date" id="session_date" name="session_date" onchange="updateMoonData()" value="{{ today_date }}"></div>
                    <div class="form-group"><label for="location_name">Location:</label><select id="location_name" name="location_name" onchange="updateMoonData()">{% for loc in available_locations %}<option value="{{ loc.name }}" data-lat="{{ loc.lat }}" data-lon="{{ loc.lon }}" data-tz="{{ loc.timezone }}">{{ loc.name }}{{ ' (Inactive)' if not loc.active else '' }}</option>{% endfor %}</select></div>
                </div>
                <div class="form-group full-width"><label for="project_selection">Link to Project (Optional)</label><select name="project_selection" id="project_selection" onchange="toggleNewProjectField()"><option value="standalone">-- Standalone Session --</option>{% for project in all_projects %}<option value="{{ project.id }}">{{ project.name }}</option>{% endfor %}<option value="new_project">-- Create New Project --</option></select></div>
                <div class="form-group full-width" id="new_project_name_group" style="display: none;"><label for="new_project_name">New Project Name:</label><input type="text" name="new_project_name" id="new_project_name" placeholder="e.g., M31 Galaxy - 2025"></div>
                <div id="form-sky-tab">
                    <div class="form-section-title">Sky Conditions (Observed)</div>
                    <div class="form-row"><div class="form-group"><label>Seeing (FWHM, arcsec):</label><input type="number" step="0.01" name="seeing_observed_fwhm"></div><div class="form-group"><label>Transparency Scale:</label><input type="text" name="transparency_observed_scale" placeholder="e.g., Good (4/5), Clear"></div></div>
                    <div class="form-row"><div class="form-group"><label>SQM Reading:</label><input type="number" step="0.01" name="sky_sqm_observed"></div><div class="form-group"> </div></div>
                    <div class="form-group"><label>Weather Notes:</label><textarea name="weather_notes"></textarea></div>
                    <div class="form-row"><div class="form-group"><label>Moon Illumination (%):</label><input type="number" step="0.1" id="moon_illumination_session" name="moon_illumination_session" placeholder="Auto-fills on date/loc change"></div><div class="form-group"><label>Moon Angular Separation (°):</label><input type="number" step="0.1" id="moon_angular_separation_session" name="moon_angular_separation_session" placeholder="Auto-fills on date/loc change"></div></div>
                    <div class="form-section-title">Equipment & Guiding</div>
                    <div class="form-group"><label for="rig-selector-edit">Select a Rig (Optional - Overwrites notes below)</label><select id="rig-selector-edit" name="rig_id_snapshot"><option value="">-- Manually Enter Below --</option>{% for rig in available_rigs %}<option value="{{ rig.rig_id }}">{{ rig.rig_name }}</option>{% endfor %}</select></div>
                    <div class="form-group"><label>Telescope Setup Notes:</label><textarea id="telescope_setup_notes" name="telescope_setup_notes" rows="3"></textarea></div>
                    <div class="form-group"><label>Guiding Equipment:</label><input type="text" name="guiding_equipment" placeholder="e.g., OAG + ASI174MM"></div>
                    <div class="form-group"><label>Guiding RMS (avg, arcsec):</label><input type="number" step="0.01" name="guiding_rms_avg_arcsec"></div>
                </div>
                <div id="form-acq-tab">
                    <div class="form-section-title">Acquisition Details</div>
                    <div class="form-group"><label>Acquisition Software:</label><input type="text" name="acquisition_software" placeholder="e.g., N.I.N.A."></div>
                    <div class="form-group"><label>Dither Settings:</label><input type="text" name="dither_details" placeholder="e.g., Yes, 3px every 2 subs"></div>
                    <div class="form-row">
                        <div class="form-group"><label>Sub Exposure (sec):</label><input type="number" name="exposure_time_per_sub_sec" min="0" oninput="triggerAllMaxSubsCalculations()"></div>
                        <div class="form-group"><label># Light Subs <span id="max-subs-main" style="font-weight:normal; color:#17a2b8; font-size:0.85em;"></span>:</label><input type="number" name="number_of_subs_light" min="0" oninput="triggerAllMaxSubsCalculations()"></div>
                    </div>
                    <div class="form-row"><div class="form-group"><label>Gain:</label><input type="number" name="gain_setting"></div><div class="form-group"><label>Offset:</label><input type="number" name="offset_setting"></div></div>
                    <div class="form-row"><div class="form-group"><label>Camera Temp Setpoint (°C):</label><input type="number" step="0.1" name="camera_temp_setpoint_c"></div><div class="form-group"><label>Camera Temp Actual Avg (°C):</label><input type="number" step="0.1" name="camera_temp_actual_avg_c"></div></div>
                    <div class="form-group"><label>Binning:</label><input type="text" name="binning_session" placeholder="e.g., 1x1"></div>
                    <div class="form-group"><label>Filter Used (if broadband/single):</label><input type="text" name="filter_used_session" placeholder="e.g., L-Pro, None"></div>
                    <div class="form-section-title" style="margin-top:20px;">Monochrome Filter Exposures</div>
                    {% set mono_filters = [('L', 'Luminance'), ('R', 'Red'), ('G', 'Green'), ('B', 'Blue'), ('Ha', 'H-alpha'), ('OIII', 'OIII'), ('SII', 'SII')] %}
                    {% for filt_key, filt_name in mono_filters %}
                    <div class="form-row">
                        <div class="form-group" style="flex: 0 0 200px; align-self: center;"><label style="margin-bottom:0;">{{ filt_name }} ({{ filt_key }}):</label></div>
                        <div class="form-group"><label># Subs <span id="max-subs-{{ filt_key }}" style="font-weight:normal; color:#17a2b8; font-size:0.85em;"></span>:</label><input type="number" name="filter_{{ filt_key }}_subs" min="0" step="1" placeholder="Count" oninput="triggerAllMaxSubsCalculations()"></div>
                        <div class="form-group"><label>Exp (sec/sub):</label><input type="number" name="filter_{{ filt_key }}_exposure_sec" min="0" step="1" placeholder="Seconds" oninput="triggerAllMaxSubsCalculations()"></div>
                    </div>
                    {% endfor %}
                </div>
                <div id="form-outcome-tab">
                    <div class="form-section-title">Calibration Strategy</div>
                    <div class="form-group"><label>Darks:</label><input type="text" name="darks_strategy" placeholder="e.g., Library match, Taken post-session"></div>
                    <div class="form-group"><label>Flats:</label><input type="text" name="flats_strategy" placeholder="e.g., Morning sky, Panel"></div>
                    <div class="form-group"><label>Bias / Dark Flats:</label><input type="text" name="bias_darkflats_strategy" placeholder="e.g., Library match"></div>
                    <div class="form-section-title">Outcome & Reflections</div>
                    <div class="form-group"><label>Session Rating (1-5 ★):</label><input type="number" min="1" max="5" name="session_rating_subjective"></div>
                    <div class="form-group">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 5px;">
                            <label style="margin-bottom: 0;">General Notes, Problems, Learnings:</label>

                            <input type="file" id="asiair_log_input" style="display: none;" accept=".txt,.log">
                            <button type="button" class="inline-button" style="font-size: 11px; padding: 3px 8px; background-color: #83b4c5;" onclick="document.getElementById('asiair_log_input').click()">
                                BETA: Import Log (ASIAIR / PHD2)
                            </button>
                        </div>
                        <input type="hidden" id="journal-notes-hidden" name="general_notes_problems_learnings">
                        <trix-editor input="journal-notes-hidden" id="journal-notes-editor" style="min-height: 120px; height: auto; background-color: #fff;"></trix-editor>
                    </div>
                    {% if selected_session_data and selected_session_data.session_image_file %}<div class="form-group full-width"><label>Current Image:</label><div style="display: flex; align-items: center; gap: 15px;"><span style="font-family: monospace; font-size: 13px;">{{ selected_session_data.session_image_file }}</span><label style="color: #c0392b; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; white-space: nowrap;"><input type="checkbox" name="delete_session_image" value="1"> Delete Image</label></div></div>{% endif %}
                    <div class="form-group full-width"><label for="session_image">Upload New or Replace Image (optional, max 5MB)</label><input type="file" id="session_image" name="session_image" accept="image/jpeg, image/png, image/gif"></div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // --- NATIVE PRINT: ROBUST & CLEAN PDF GENERATION ---
    async function downloadVisibleReport(defaultFilename, buttonElement, iframeId) {
        const iframe = document.getElementById(iframeId);
        if (!iframe || !iframe.contentWindow) {
             alert("Report frame not found.");
             return;
        }

        const buttonOriginalText = buttonElement.textContent;
        buttonElement.textContent = "Preparing Print View...";
        buttonElement.disabled = true;

        try {
            const doc = iframe.contentWindow.document;
            const contentDiv = doc.getElementById('report-content');
            const appendedContainer = doc.getElementById('appended-session-reports');

            // 1. FETCH & APPEND SESSIONS (If project report and not already loaded)
            const sessionRows = doc.querySelectorAll('.session-data-row');

            if (sessionRows.length > 0 && appendedContainer && appendedContainer.children.length === 0) {
                // Fetch Helper
                const fetchReport = async (url) => {
                    try { const response = await fetch(url); return await response.text(); }
                    catch (e) { console.error("Failed load: " + url); return null; }
                };

                for (let i = 0; i < sessionRows.length; i++) {
                    const reportUrl = sessionRows[i].dataset.reportUrl;
                    buttonElement.textContent = `Merging Session ${i+1}/${sessionRows.length}...`;
                    if (!reportUrl) continue;

                    const htmlContent = await fetchReport(reportUrl);
                    if (htmlContent) {
                        const parser = new DOMParser();
                        const sessionDoc = parser.parseFromString(htmlContent, 'text/html');
                        const sessionContent = sessionDoc.getElementById('report-content');

                        if (sessionContent) {
                            // A. Inject Session CSS (Only once) to fix column layouts
                            if (i === 0) {
                                sessionDoc.querySelectorAll('style').forEach(s => {
                                    const newStyle = doc.createElement('style');
                                    newStyle.textContent = s.textContent;
                                    doc.head.appendChild(newStyle);
                                });
                            }

                            // B. Create Wrapper with FORCED PAGE BREAK
                            const wrapper = doc.createElement('div');
                            wrapper.className = 'session-appendix-wrapper';
                            // CSS 'break-before: page' handles the magic automatically
                            wrapper.style.breakBefore = 'page';
                            wrapper.style.pageBreakBefore = 'always';
                            wrapper.style.marginTop = '20px';

                            // C. Add Clean Title
                            const title = doc.createElement('h3');
                            title.innerText = `APPENDIX: SESSION ${i+1}`;
                            title.style.color = '#888';
                            title.style.borderBottom = '1px solid #eee';
                            title.style.paddingBottom = '5px';
                            title.style.marginBottom = '15px';
                            wrapper.appendChild(title);

                            // D. Append Content (Stripping Duplicate Headers)
                            Array.from(sessionContent.children).forEach(child => {
                                if (child.classList.contains('header-table') ||
                                    child.classList.contains('header-line') ||
                                    child.classList.contains('footer') ||
                                    child.classList.contains('target-info')) {
                                    return; // Skip duplicates
                                }
                                wrapper.appendChild(child.cloneNode(true));
                            });

                            appendedContainer.appendChild(wrapper);
                        }
                    }
                }
            }

            // 2. INJECT PRINT-SPECIFIC CSS (The "Better Formatting" Logic)
            const printStyle = doc.createElement('style');
            printStyle.textContent = `
                @media print {
                    @page { margin: 10mm; size: A4; }
                    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; background-color: #fff; }
                    .a4-page { width: 100% !important; margin: 0 !important; padding: 0 !important; box-shadow: none !important; }

                    /* Prevent blocks from breaking internally */
                    .report-block, table, .info-box, .session-image-container { break-inside: avoid; page-break-inside: avoid; }

                    /* Force Sessions to start on new pages, but reduce top margin */
                    .session-appendix-wrapper {
                        break-before: page;
                        page-break-before: always;
                        display: block;
                        margin-top: 0 !important;
                    }

                    /* Keep the Title with the immediate following content (the summary table) */
                    .session-appendix-wrapper h3 {
                        break-after: avoid;
                        page-break-after: avoid;
                        margin-bottom: 10px;
                    }

                    /* Constrain images in the appendix to fit on the same page as the summary */
                    .session-appendix-wrapper img {
                        max-height: 350px !important;
                        width: auto !important;
                        object-fit: contain;
                        display: block;
                        margin: 10px auto;
                    }

                    /* Hide non-print elements */
                    .footer { display: none; }
                }
            `;
            doc.head.appendChild(printStyle);

            // 3. TRIGGER BROWSER PRINT
            buttonElement.textContent = "Check Popup...";
            setTimeout(() => {
                iframe.contentWindow.focus();
                iframe.contentWindow.print();
                buttonElement.textContent = buttonOriginalText;
                buttonElement.disabled = false;
            }, 500);

        } catch (err) {
            console.error(err);
            alert("Error preparing print view: " + err.message);
            buttonElement.textContent = buttonOriginalText;
            buttonElement.disabled = false;
        }
    }

    function showDetailTab(tabName) {
        const wrapper = document.getElementById('session-detail-wrapper');
        const isEditingOrAdding = wrapper.classList.contains('is-editing') || wrapper.classList.contains('is-adding');
        const modeSelector = isEditingOrAdding ? '.edit-mode-form' : '.view-mode';

        document.querySelectorAll(`${modeSelector} .detail-tab-content`).forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.detail-tab-button').forEach(button => button.classList.remove('active'));

        const selectedTabContent = document.querySelector(`${modeSelector} #${tabName}-tab`);
        if (selectedTabContent) selectedTabContent.classList.add('active');

        const selectedTabButton = document.querySelector(`.detail-tab-button[data-tab="${tabName}"]`);
        if (selectedTabButton && !isEditingOrAdding) selectedTabButton.classList.add('active');

        // --- NEW: Lazy load the report preview if selecting the report tab ---
        if (tabName === 'report') {
            const iframe = document.getElementById('report-preview-frame');
            if (iframe && !iframe.src && iframe.dataset.src) {
                iframe.src = iframe.dataset.src; // Load the URL only when tab is clicked
            }
        }
    }

    function populateEditForm(data) {
        if (!data) return;
        const form = document.getElementById('journal-detail-form');

        // Fix: Explicitly set the location select value
        if (data.location_name) {
            form.elements['location_name'].value = data.location_name;
        }

        form.elements['seeing_observed_fwhm'].value = data.seeing_observed_fwhm || '';
        form.elements['sky_sqm_observed'].value = data.sky_sqm_observed || '';
        form.elements['moon_illumination_session'].value = data.moon_illumination_session || '';
        form.elements['moon_angular_separation_session'].value = data.moon_angular_separation_session || '';
        form.elements['rig_id_snapshot'].value = data.rig_id_snapshot || '';
        form.elements['telescope_setup_notes'].value = data.telescope_setup_notes || '';
        form.elements['guiding_rms_avg_arcsec'].value = data.guiding_rms_avg_arcsec || '';
        form.elements['exposure_time_per_sub_sec'].value = data.exposure_time_per_sub_sec || '';
        form.elements['number_of_subs_light'].value = data.number_of_subs_light || '';
        form.elements['filter_used_session'].value = data.filter_used_session || '';
        form.elements['gain_setting'].value = data.gain_setting || '';
        form.elements['offset_setting'].value = data.offset_setting || '';
        form.elements['session_rating_subjective'].value = data.session_rating_subjective || '';
        const journalEditor = document.getElementById('journal-notes-editor');
        if (journalEditor && journalEditor.editor) {
            journalEditor.editor.loadHTML(data.notes || '');
        } else {
            document.getElementById('journal-notes-hidden').value = data.notes || '';
        }
        form.elements['transparency_observed_scale'].value = data.transparency_observed_scale || '';
        form.elements['weather_notes'].value = data.weather_notes || '';
        form.elements['guiding_equipment'].value = data.guiding_equipment || '';
        form.elements['dither_details'].value = data.dither_details || '';
        form.elements['acquisition_software'].value = data.acquisition_software || '';
        form.elements['camera_temp_setpoint_c'].value = data.camera_temp_setpoint_c !== null ? data.camera_temp_setpoint_c : '';
        form.elements['camera_temp_actual_avg_c'].value = data.camera_temp_actual_avg_c !== null ? data.camera_temp_actual_avg_c : '';
        form.elements['binning_session'].value = data.binning_session || '';
        form.elements['darks_strategy'].value = data.darks_strategy || '';
        form.elements['flats_strategy'].value = data.flats_strategy || '';
        form.elements['bias_darkflats_strategy'].value = data.bias_darkflats_strategy || '';
        const monoFilters = ['L', 'R', 'G', 'B', 'Ha', 'OIII', 'SII'];
         monoFilters.forEach(filt => {
            form.elements[`filter_${filt}_subs`].value = data.hasOwnProperty(`filter_${filt}_subs`) && data[`filter_${filt}_subs`] !== null ? data[`filter_${filt}_subs`] : '';
            form.elements[`filter_${filt}_exposure_sec`].value = data.hasOwnProperty(`filter_${filt}_exposure_sec`) && data[`filter_${filt}_exposure_sec`] !== null ? data[`filter_${filt}_exposure_sec`] : '';
        });
        if (data.project_id) { form.elements['project_selection'].value = data.project_id; }
        else { form.elements['project_selection'].value = 'standalone'; }
        toggleNewProjectField();
    }

    function setupAddMode() {
        const wrapper = document.getElementById('session-detail-wrapper');
        const form = document.getElementById('journal-detail-form');
        const formDetailTitle = document.getElementById('form-detail-title');
        const submitButton = document.getElementById('form-submit-button');
        const cancelButton = document.getElementById('form-cancel-button');

        if (!wrapper || !form || !formDetailTitle || !submitButton || !cancelButton) return;

        // Hide ALL view modes (session and project)
        document.querySelectorAll('.view-mode, #journal-project-view-wrapper').forEach(el => el.style.display = 'none');

        // Hide Project Add Form if active
        const projAdd = document.getElementById('journal-project-add-mode');
        if(projAdd) projAdd.style.display = 'none';

        const initialDetailHeader = wrapper.querySelector('.detail-header:not(form .detail-header)');
        if(initialDetailHeader) initialDetailHeader.style.display = 'none';
        const placeholder = wrapper.querySelector('p.view-mode');
        if(placeholder) placeholder.style.display = 'none';

        form.style.display = 'block';
        wrapper.classList.remove('is-editing');
        wrapper.classList.add('is-adding');

        form.reset();
        const journalEditor = document.getElementById('journal-notes-editor');
        if (journalEditor && journalEditor.editor) journalEditor.editor.loadHTML('');

        form.action = '{{ url_for("journal_add_for_target", object_name=object_name) }}';
        form.elements.session_id.value = '';
        form.elements.session_date.value = '{{ today_date }}';
        // Use the current header location first, fall back to default
        form.elements.location_name.value = '{{ header_location_name or default_location or (available_locations[0].name if available_locations else "") }}';
        form.elements['project_selection'].value = 'standalone';

        const deleteCheckbox = form.elements['delete_session_image']; if (deleteCheckbox) deleteCheckbox.checked = false;
        const fileInput = form.elements['session_image']; if(fileInput) fileInput.value = '';

        formDetailTitle.textContent = 'Add New Session for {{ alt_name | default(object_name, True) }}';
        submitButton.textContent = 'Add Session';
        submitButton.style.backgroundColor = '#28a745';
        cancelButton.onclick = () => window.location.reload();

        updateMoonData();
        toggleNewProjectField();
    }

    function setupEditMode() {
        const wrapper = document.getElementById('session-detail-wrapper');
        const form = document.getElementById('journal-detail-form');
        const formDetailTitle = document.getElementById('form-detail-title');
        const submitButton = document.getElementById('form-submit-button');
        const cancelButton = document.getElementById('form-cancel-button');

        if (!wrapper || !form || !formDetailTitle || !submitButton || !cancelButton) return;

        document.querySelectorAll('.view-mode').forEach(el => el.style.display = 'none');
        const initialDetailHeader = wrapper.querySelector('.detail-header:not(form .detail-header)');
        if(initialDetailHeader) initialDetailHeader.style.display = 'none';

        form.style.display = 'block';
        wrapper.classList.add('is-editing');
        wrapper.classList.remove('is-adding');

        if (window.selectedSessionData) {
            formDetailTitle.textContent = 'Editing Session: ' + new Date(window.selectedSessionData.date_utc).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
            form.action = `/journal/edit/${window.selectedSessionData.id}`;
            form.elements.session_id.value = window.selectedSessionData.id;
            form.elements.session_date.value = window.selectedSessionData.date_utc.split('T')[0];
            form.elements.location_name.value = window.selectedSessionData.location_name;
            populateEditForm(window.selectedSessionData);
            updateMoonData();
        }

        submitButton.textContent = 'Save Changes';
        submitButton.style.backgroundColor = '#007bff';
        cancelButton.onclick = cancelForm;
    }

    function cancelForm() {
        // Remove 'edit' parameter to ensure we return to View Mode (fixes loop after Duplicate)
        const url = new URL(window.location.href);
        url.searchParams.delete('edit');
        window.location.href = url.toString();
    }

    async function updateMoonData() {
        const dateInput = document.getElementById('session_date');
        const locationSelect = document.getElementById('location_name');
        if (!dateInput || !locationSelect) return;

        const date = dateInput.value;
        const selectedOption = locationSelect.options[locationSelect.selectedIndex];
        const illumInput = document.getElementById('moon_illumination_session');
        const sepInput = document.getElementById('moon_angular_separation_session');

        if (!date || !selectedOption || !selectedOption.dataset.lat) return;

        const lat = selectedOption.dataset.lat;
        const lon = selectedOption.dataset.lon;
        const tz = selectedOption.dataset.tz;
        const ra = '{{ object_main_details["RA (hours)"] | default("", True) }}';
        const dec = '{{ object_main_details["DEC (degrees)"] | default("", True) }}';

        if (!ra || !dec) return;

        const apiUrl = `/api/get_moon_data?date=${date}&lat=${lat}&lon=${lon}&ra=${ra}&dec=${dec}&tz=${encodeURIComponent(tz)}`;
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();

            if (data.status === 'success') {
                illumInput.value = data.moon_illumination !== null ? data.moon_illumination : '';
                sepInput.value = data.angular_separation !== null ? data.angular_separation : '';

                // Store duration globally for calculation
                window.currentObsDurationMinutes = data.observable_duration_min || 0;

                // Trigger recalculation for all existing inputs
                triggerAllMaxSubsCalculations();
            }
        } catch (error) {
            console.error('Failed to fetch moon data:', error);
        }
    }

    // Helper: Calculate total integration time currently scheduled by other fields
    function getUsedTimeSeconds(excludeKey) {
        let usedSeconds = 0;

        // Helper to add time if not the excluded key
        const addTime = (subsName, expName, currentKey) => {
            if (currentKey === excludeKey) return;
            const subs = parseFloat(document.querySelector(`input[name="${subsName}"]`)?.value) || 0;
            const exp = parseFloat(document.querySelector(`input[name="${expName}"]`)?.value) || 0;
            usedSeconds += (subs * exp);
        };

        // Check Main
        addTime('number_of_subs_light', 'exposure_time_per_sub_sec', 'main');

        // Check Mono Filters
        ['L', 'R', 'G', 'B', 'Ha', 'OIII', 'SII'].forEach(k => {
            addTime(`filter_${k}_subs`, `filter_${k}_exposure_sec`, k);
        });

        return usedSeconds;
    }

    // New Helper: Calculate Max Subs with Deduction and Efficiency
    function calculateMaxSubs(exposureSec, targetSpanId, filterKey) {
        const span = document.getElementById(targetSpanId);
        if (!span) return;

        const durationMin = window.currentObsDurationMinutes || 0;
        const exp = parseFloat(exposureSec);

        if (durationMin > 0 && exp > 0) {
            const totalAvailableSeconds = durationMin * 60;
            const usedSeconds = getUsedTimeSeconds(filterKey); // Get time used by *other* fields

            // Calculate remaining time for *this* field
            const remainingSeconds = Math.max(0, totalAvailableSeconds - usedSeconds);

            // Theoretical Max
            const maxSubs = Math.floor(remainingSeconds / exp);

            // Realistic Max (Efficiency factor ~85% for dither/meridian flip/readout)
            const efficiencyFactor = 0.85;
            const realSubs = Math.floor((remainingSeconds * efficiencyFactor) / exp);

            if (maxSubs > 0) {
                span.innerHTML = `(Max <span style="font-weight:600;">${maxSubs}</span> | Real <span style="font-weight:600;">${realSubs}</span>)`;
                span.title = `Based on ${durationMin}m total window minus other active filters. Real assumes ~15% overhead for meridian flip, dithering etc.`;
            } else {
                span.textContent = '(Time Limit Reached)';
                span.style.color = '#dc3545'; // Red warning
            }
        } else {
            span.textContent = '';
        }
    }

    function triggerAllMaxSubsCalculations() {
        // Main Exposure
        const mainExp = document.querySelector('input[name="exposure_time_per_sub_sec"]');
        if (mainExp) calculateMaxSubs(mainExp.value, 'max-subs-main', 'main');

        // Mono Filters
        const monoFilters = ['L', 'R', 'G', 'B', 'Ha', 'OIII', 'SII'];
        monoFilters.forEach(key => {
            const input = document.querySelector(`input[name="filter_${key}_exposure_sec"]`);
            if (input) calculateMaxSubs(input.value, `max-subs-${key}`, key);
        });
    }

    function toggleNewProjectField() {
        const projectSelect = document.getElementById('project_selection');
        const newProjectGroup = document.getElementById('new_project_name_group');
        if (projectSelect && newProjectGroup) {
            newProjectGroup.style.display = (projectSelect.value === 'new_project') ? 'block' : 'none';
        }
    }

    // Trix helper for loading content into editors (Used for Project Edit)
    function loadTrixContentJournal(editorId, htmlContent) {
        const editorElement = document.getElementById(editorId);
        if (editorElement && editorElement.editor) {
             editorElement.editor.loadHTML(htmlContent);
        } else if (editorElement) {
             const hiddenInput = document.getElementById(editorElement.getAttribute('input'));
             if (hiddenInput) {
                 hiddenInput.value = htmlContent;
             }
             editorElement.addEventListener('trix-initialize', function() {
                 editorElement.editor.loadHTML(hiddenInput.value);
             }, { once: true });
        }
    }

    function toggleJournalProjectEdit(enable) {
        const viewMode = document.getElementById('journal-project-view-mode');
        const editMode = document.getElementById('journal-project-edit-mode');

        // Select the button group in the main view header (Edit + Delete)
        const viewHeaderButtons = document.querySelector('#journal-project-view-wrapper .detail-header .action-button-group');

        if (!viewMode || !editMode) return;

        if (enable) {
            // Switch to Edit Mode
            viewMode.style.display = 'none';
            editMode.style.display = 'block';

            // Hide the Edit/Delete buttons in the main header
            if (viewHeaderButtons) viewHeaderButtons.style.display = 'none';

            // Ensure Trix editors are populated
            loadTrixContentJournal('goals-editor-journal', document.getElementById('goals-hidden-journal').value);
            loadTrixContentJournal('description-editor-journal', document.getElementById('description-hidden-journal').value);
            loadTrixContentJournal('framing-editor-journal', document.getElementById('framing-hidden-journal').value);
            loadTrixContentJournal('processing-editor-journal', document.getElementById('processing-hidden-journal').value);

        } else {
            // Switch to View Mode
            viewMode.style.display = 'flex';
            editMode.style.display = 'none';

            // Show the Edit/Delete buttons again
            if (viewHeaderButtons) viewHeaderButtons.style.display = 'flex';
        }
    }

    // Form submission handler for the journal project edit form to update hidden inputs
    document.addEventListener('DOMContentLoaded', () => {
        const projectEditForm = document.getElementById('journal-project-edit-form');
        if (projectEditForm) {
            projectEditForm.addEventListener('submit', function(e) {
                document.getElementById('goals-hidden-journal').value = document.getElementById('goals-editor-journal').value;
                document.getElementById('description-hidden-journal').value = document.getElementById('description-editor-journal').value;
                document.getElementById('framing-hidden-journal').value = document.getElementById('framing-editor-journal').value;
                document.getElementById('processing-hidden-journal').value = document.getElementById('processing-editor-journal').value;
            });
        }

        // New Project Form Listener
        const projectAddForm = document.getElementById('journal-project-add-form');
        if (projectAddForm) {
            projectAddForm.addEventListener('submit', function(e) {
                document.getElementById('goals-hidden-add').value = document.getElementById('goals-editor-add').value;
            });
        }

        const wrapper = document.getElementById('session-detail-wrapper');
        const form = document.getElementById('journal-detail-form');

        // Initial visibility & population logic
        const startInEditMode = wrapper && wrapper.classList.contains('is-editing');

        if (startInEditMode) {
            // If we loaded in edit mode (e.g. duplicate), ensure form is visible and populated
            if (form) form.style.display = 'block';

            if (window.selectedSessionData) {
                const formDetailTitle = document.getElementById('form-detail-title');
                if (formDetailTitle) {
                    formDetailTitle.textContent = 'Editing Session: ' + new Date(window.selectedSessionData.date_utc).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
                }
                if (form) {
                    form.action = `/journal/edit/${window.selectedSessionData.id}`;
                    form.elements.session_id.value = window.selectedSessionData.id;
                    form.elements.session_date.value = window.selectedSessionData.date_utc.split('T')[0];
                    if (form.elements.location_name && window.selectedSessionData.location_name) {
                        form.elements.location_name.value = window.selectedSessionData.location_name;
                    }
                }
                populateEditForm(window.selectedSessionData);
            }
        } else {
            // Standard view mode: hide the form initially
            if (form) form.style.display = 'none';
        }

         if (wrapper && (wrapper.classList.contains('is-adding') || wrapper.classList.contains('is-editing'))) {
            updateMoonData();
        }

        if(wrapper && wrapper.querySelector('.view-mode .detail-header')){
            showDetailTab('summary');
        }
    });

    function setupAddProjectMode() {
        const wrapper = document.getElementById('session-detail-wrapper');
        const addProjDiv = document.getElementById('journal-project-add-mode');

        if (!wrapper || !addProjDiv) return;

        // 1. Hide View Elements
        document.querySelectorAll('.view-mode, #journal-project-view-wrapper').forEach(el => el.style.display = 'none');

        // 2. Hide Session Forms
        const sessForm = document.getElementById('journal-detail-form');
        if (sessForm) sessForm.style.display = 'none';

        // 3. Show Project Add Form
        addProjDiv.style.display = 'block';

        // 4. Hide headers
        const initialDetailHeader = wrapper.querySelector('.detail-header:not(form .detail-header)');
        if(initialDetailHeader) initialDetailHeader.style.display = 'none';

        // 5. Reset Form
        document.getElementById('journal-project-add-form').reset();
        const trix = document.getElementById('goals-editor-add');
        if(trix && trix.editor) trix.editor.loadHTML('');
    }

// FIX: Auto-resize iframe to eliminate double scrollbars
    function resizeIframe(obj) {
        if (!obj || !obj.contentWindow) return;
        try {
            // Reset to allow shrinking if content changed, then match content height
            obj.style.height = (obj.contentWindow.document.body.scrollHeight + 50) + 'px';
        } catch(e) {
            // Fallback for safety
            console.warn("Iframe resize failed", e);
            obj.style.height = '1400px';
        }
    }
// --- EXACT CHART GENERATOR (Uses real API & Chart.js) ---
    async function generateExactSessionChart(dateStr, locName) {
        // 1. Resolve Location Coordinates & Timezone
        // We scrape the dropdown to find the matching Lat/Lon/TZ for the session's location name
        let coords = { lat: window.NOVA_GRAPH_DATA.plotLat, lon: window.NOVA_GRAPH_DATA.plotLon, tz: window.NOVA_GRAPH_DATA.plotTz }; // Default
        const select = document.getElementById('location_name');
        if (select) {
            for (let opt of select.options) {
                if (opt.value === locName) {
                    coords = { lat: opt.dataset.lat, lon: opt.dataset.lon, tz: opt.dataset.tz };
                    break;
                }
            }
        }

        // 2. Prepare Date & API URL
        const dateObj = new Date(dateStr);
        const day = dateObj.getDate();
        const month = dateObj.getMonth() + 1;
        const year = dateObj.getFullYear();
        const objectName = window.NOVA_GRAPH_DATA.objectName;

        const apiUrl = `/api/get_plot_data/${encodeURIComponent(objectName)}?day=${day}&month=${month}&year=${year}&plot_lat=${coords.lat}&plot_lon=${coords.lon}&plot_tz=${encodeURIComponent(coords.tz)}`;

        try {
            // 3. Fetch Real Data
            const resp = await fetch(apiUrl);
            if (!resp.ok) return null;
            const data = await resp.json();

            // 4. Setup Canvas
            const canvas = document.createElement('canvas');
            canvas.width = 1000;
            canvas.height = 400; // 2.5:1 Aspect Ratio

            // 5. Replicate "Night Shade" Plugin (Gray background for day/twilight)
            const DateTime = luxon.DateTime;
            const nightShadePlugin = {
                id: 'nightShade',
                beforeDraw(chart) {
                    const {ctx, chartArea, scales} = chart;
                    if (!chartArea) return;

                    const x = scales.x;
                    const left = x.getPixelForValue(x.min);
                    const right = x.getPixelForValue(x.max);

                    // Parse times from API response
                    const baseDt = DateTime.fromISO(data.date, {zone: coords.tz});
                    const nextDt = baseDt.plus({days: 1});
                    const parseTime = (base, tStr) => {
                        if (!tStr || !tStr.includes(':')) return null;
                        const [h, m] = tStr.split(':').map(Number);
                        return base.set({hour: h, minute: m, second: 0}).toMillis();
                    };

                    // Logic: Draw gray box from Start->Dusk and Dawn->End to simulate "Night" window
                    let duskMs = parseTime(baseDt, data.sun_events.current.astronomical_dusk);
                    const sunsetMs = parseTime(baseDt, data.sun_events.current.sunset);
                    if (duskMs && sunsetMs && duskMs < sunsetMs) duskMs = parseTime(nextDt, data.sun_events.current.astronomical_dusk); // Rollover

                    const dawnMs = parseTime(nextDt, data.sun_events.next.astronomical_dawn);

                    const duskPx = duskMs ? x.getPixelForValue(duskMs) : right;
                    const dawnPx = dawnMs ? x.getPixelForValue(dawnMs) : left;

                    ctx.save();
                    ctx.fillStyle = 'rgba(211, 211, 211, 0.5)'; // Light gray shade

                    // Fill the "Daytime" areas
                    if (duskPx > left) ctx.fillRect(left, chartArea.top, duskPx - left, chartArea.height);
                    if (dawnPx < right) ctx.fillRect(dawnPx, chartArea.top, right - dawnPx, chartArea.height);
                    ctx.restore();
                }
            };

            // 6. Render Chart (Identical Config to Main View)
            const toMs = (val) => (typeof val === 'string') ? DateTime.fromISO(val, { zone: coords.tz }).toMillis() : val;

            new Chart(canvas, {
                type: 'line',
                data: {
                    labels: data.times.map(toMs),
                    datasets: [
                        {
                            label: `${objectName} Altitude`,
                            data: data.object_alt,
                            borderColor: '#36A2EB', // Blue
                            borderWidth: 3,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'Moon Altitude',
                            data: data.moon_alt,
                            borderColor: '#FFC107', // Yellow
                            borderWidth: 3,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'Horizon',
                            data: Array(data.times.length).fill(0),
                            borderColor: 'black',
                            borderWidth: 2,
                            pointRadius: 0
                        }
                    ]
                },
                plugins: [nightShadePlugin],
                options: {
                    animation: false, // Instant render
                    responsive: false,
                    adapters: { date: { zone: coords.tz } },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
                            grid: { color: 'rgba(128,128,128,0.5)', borderDash: [2, 2] },
                            title: { display: true, text: `Local Time (${coords.tz})` }
                        },
                        y: {
                            min: 0, max: 90,
                            title: { display: true, text: 'Altitude (°)' },
                            grid: { color: 'rgba(128,128,128,0.5)', borderDash: [2, 2] }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        title: { display: true, text: `Visibility: ${dateStr}` }
                    }
                }
            });

            return canvas.toDataURL('image/png');

        } catch (e) {
            console.error("Report Chart Error:", e);
            return null;
        }
    }

// --- New function for Project Detail Tabs ---
    // --- ASIAIR LOG IMPORT HANDLER ---
    document.addEventListener('DOMContentLoaded', () => {
        const logInput = document.getElementById('asiair_log_input');
        if (logInput) {
            logInput.addEventListener('change', async function() {
                if (this.files.length === 0) return;

                const formData = new FormData();
                formData.append('file', this.files[0]);

                // Show loading state on button
                const btn = this.nextElementSibling;
                const originalText = btn.textContent;
                btn.textContent = "Parsing...";
                btn.disabled = true;

                try {
                    const response = await fetch('/api/parse_asiair_log', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error("Parse failed");

                    const data = await response.json();

                    if (data.status === 'success') {
                        const editor = document.getElementById('journal-notes-editor');
                        if (editor && editor.editor) {
                            // Insert content at the beginning
                            editor.editor.setSelectedRange([0, 0]);
                            editor.editor.insertHTML(data.html);
                            // Add a break after
                            editor.editor.insertLineBreak();
                        }
                    } else {
                        alert("Error parsing log: " + data.message);
                    }
                } catch (e) {
                    console.error(e);
                    alert("Failed to upload/parse log file.");
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                    this.value = ''; // Reset input
                }
            });
        }
    });

    function showProjectTab(tabName) {
        // 1. Hide all content divs
        document.querySelectorAll('.project-tab-content').forEach(el => el.style.display = 'none');

        // 2. Remove active class from buttons
        document.querySelectorAll('.project-tab-btn').forEach(el => el.classList.remove('active'));

        // 3. Show selected content
        const content = document.getElementById(`project-${tabName}-tab`);
        if (content) content.style.display = 'block';

        // 4. Activate button
        const btn = document.querySelector(`.project-tab-btn[data-ptab="${tabName}"]`);
        if (btn) btn.classList.add('active');

        // 5. Lazy load report iframe if needed
        if (tabName === 'report') {
            const iframe = document.getElementById('project-report-frame');
            if (iframe && !iframe.src && iframe.dataset.src) {
                iframe.src = iframe.dataset.src;
            }
        }
    }

</script>
<script>
async function loadSessionViaAjax(e, url, rowElement) {
    // Allow Ctrl/Cmd+Click to open in new tab
    if (e.ctrlKey || e.metaKey) return;

    e.preventDefault();
    document.body.style.cursor = 'wait';

    // UI Feedback: Reset all highlights first
    document.querySelectorAll('.clickable-session-row').forEach(r => r.classList.remove('current-session-item'));
    document.querySelectorAll('.project-header-clickable').forEach(r => r.classList.remove('current-project-item'));

    // Apply highlight based on the type of element clicked
    if (rowElement) {
        if (rowElement.classList.contains('project-header-clickable')) {
            rowElement.classList.add('current-project-item');
        } else {
            rowElement.classList.add('current-session-item');
        }
    }

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error("Network response was not ok");

        const text = await response.text();
        const parser = new DOMParser();
        const newDoc = parser.parseFromString(text, 'text/html');

        // 1. Swap the Detail Column Content
        const newContent = newDoc.querySelector('.session-detail-column');
        const currentContent = document.querySelector('.session-detail-column');

        if (newContent && currentContent) {
            currentContent.innerHTML = newContent.innerHTML;
        }

        // 2. Update Global State (Critical for Edit Mode to work after swap)
        const scripts = newDoc.querySelectorAll('script');
        for (let s of scripts) {
            // Extract the new session JSON data
            const match = s.textContent.match(/window\.selectedSessionData\s*=\s*(\{[\s\S]*?\});/);
            if (match && match[1]) {
                try {
                    window.selectedSessionData = JSON.parse(match[1]);
                } catch (err) { console.error("JSON Parse error", err); }
                break;
            }
        }

        // 3. Update Browser URL without reloading
        window.history.pushState({}, '', url);

        // 4. Re-initialize Tabs if needed
        if (typeof showDetailTab === 'function') {
            showDetailTab('summary');
        }

    } catch (error) {
        console.warn("AJAX Load Failed, falling back to reload:", error);
        window.location.href = url;
    } finally {
        document.body.style.cursor = 'default';
    }
}
</script>