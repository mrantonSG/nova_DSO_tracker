{# templates/_journal_section.html - COMPLETE AND CORRECTED VERSION #}
<style>
    .journal-container { display: flex; gap: 25px; align-items: flex-start; }
    .session-list-column { flex: 0 0 450px; max-height: 750px; overflow-y: auto; }
    .session-detail-column { flex: 1 1 auto; max-height: 750px; overflow-y: auto; padding-right: 15px; }
    .detail-tabs-container { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ccc; }
    .detail-tab-button { padding: 8px 16px; cursor: pointer; border: none; background-color: transparent; color: #555; border-bottom: 2px solid transparent; font-size: 15px; }
    .detail-tab-button.active { color: #83b4c5; border-bottom-color: #83b4c5; font-weight: 600; }
    .detail-tab-content { display: none; }
    .detail-tab-content.active { display: block; }
    .edit-mode { display: none; }
    .is-editing .view-mode, .is-adding .view-mode { display: none; }
    .is-editing .edit-mode, .is-adding .edit-mode { display: block; }
    .is-editing .detail-tab-button[data-tab="summary"], .is-adding .detail-tab-button[data-tab="summary"] { display: none; }
    .summary-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 20px; text-align: center; padding: 15px; background-color: #e9ecef; border-radius: 6px; margin-bottom: 25px; }
    .summary-box .stat-value { font-size: 1.4em; font-weight: 600; color: #343a40; display: block; }
    .summary-box .stat-label { font-size: 0.8em; color: #6c757d; text-transform: uppercase; }
    .detail-grid { display: grid; grid-template-columns: max-content 1fr; gap: 12px 20px; align-items: baseline; }
    .detail-grid > dt { font-weight: 600; color: #495057; }
    .detail-grid > dd { margin: 0; color: #212529; }
    .notes-block { margin-top: 8px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; white-space: pre-wrap; min-height: 60px; }
    .session-list-column h4, .session-detail-column h4 { font-size: 1.2em; font-weight: 600; margin-top: 0; margin-bottom: 0; color: #343a40; }
    .edit-mode .form-group input, .edit-mode .form-group textarea, .edit-mode .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
    .edit-mode .form-group textarea { min-height: 100px; }
    .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75em; }
    .history-header .inline-button { font-size: 13px; padding: 6px 12px; margin-right: 0; }
    .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; }
    .detail-header .action-button-group { margin: 0; }
    .form-group.full-width { flex-basis: 100%; }
    .form-group.full-width label { width: auto; }
</style>

<div class="journal-container">
    <div class="session-list-column">
        <div class="history-header">
            <h4>Session History:</h4>
            <button type="button" class="inline-button" onclick="setupAddMode()">Add New Session</button>
        </div>
        <div class="table-wrapper" style="border-top: 1px solid #dee2e6;">
            <table class="session-history-table">
                <thead><tr><th class="col-date">Date & Location</th><th class="col-integ">Integ.</th><th class="col-rating">Rating</th></tr></thead>
                <tbody>
                {% for group in grouped_sessions %}
                    <tr>
                        <th colspan="3" style="background-color: #f0f2f5; font-weight: bold; padding: 8px 5px; border-top: 1px solid #ddd;">
                            {% if group.is_project %}{% set project_total_h = (group.total_integration_time / 60) | round(1) %}
                                Project: {{ group.project_name }}
                                {% if project_total_h > 0 %}<span style="float: right; font-weight: normal; color: #555;">Total: {{ project_total_h }}h</span>{% endif %}
                            {% else %}{{ group.project_name }}{% endif %}
                        </th>
                    </tr>
                    {% for session_item in group.sessions %}
                        <tr class="clickable-session-row {{ 'current-session-item' if session_item.id|string == current_session_id|string else '' }}" onclick='window.location.href="{{ url_for("graph_dashboard", object_name=object_name, session_id=session_item.id) }}"'>
                            <td class="col-date">{{ session_item.date_utc |date_eu| default("N/A") }}<br><small style="color:#555;">{{ session_item.location_name | default("N/A") }}</small></td>
                            <td class="col-integ">{% set integ_min = session_item.calculated_integration_time_minutes %}{{ integ_min | round(0) if integ_min is number else 'N/A' }} min</td>
                            <td class="col-rating">{{ session_item.session_rating_subjective | default('N/A') }}{% if session_item.session_rating_subjective %} ★{% endif %}</td>
                        </tr>
                    {% endfor %}
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="session-detail-column">
        <div id="session-detail-wrapper">

            {% if selected_session_data %}
                {% set entry = selected_session_data %} {# Use 'entry' as the variable for consistency #}

                <div class="detail-header">
                    <h4 id="detail-title">Details for Session: {{ entry.date_utc | date_eu }}</h4>
                    <div class="action-button-group view-mode">
                        <button type="button" class="inline-button" style="background-color:#ffc107; color:black;" onclick="setupEditMode()">Edit This Session</button>
                        <form action="{{ url_for('journal_delete', session_id=entry.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this session permanently?');">
                            <button type="submit" class="inline-button" style="background-color:#dc3545;">Delete This Session</button>
                        </form>
                    </div>
                    <div class="action-button-group edit-mode">
                        <button id="form-submit-button" type="submit" form="journal-detail-form" class="inline-button" style="background-color:#28a745;">Save Changes</button>
                        <button type="button" class="inline-button" style="background-color:#6c757d;" onclick="cancelForm()">Cancel</button>
                    </div>
                </div>

                <form id="journal-detail-form" method="POST" action="" enctype="multipart/form-data">
                    <input type="hidden" name="target_object_id" value="{{ object_name }}">
                    <input type="hidden" name="session_id" value="{{ entry.id }}">

                    <div class="detail-tabs-container">
                        <button type="button" class="detail-tab-button active" data-tab="summary" onclick="showDetailTab('summary')">Summary</button>
                        <button type="button" class="detail-tab-button" data-tab="sky" onclick="showDetailTab('sky')">Sky & Equipment</button>
                        <button type="button" class="detail-tab-button" data-tab="acq" onclick="showDetailTab('acq')">Acquisition</button>
                        <button type="button" class="detail-tab-button" data-tab="outcome" onclick="showDetailTab('outcome')">Outcome</button>
                    </div>

                    <div class="view-mode">
                        <div id="summary-tab" class="detail-tab-content active">
                             <div class="summary-box">
                                <div class="stat"><span class="stat-value">{{ entry.seeing_observed_fwhm | default('N/A') }}{% if entry.seeing_observed_fwhm %}"{% endif %}</span><span class="stat-label">SEEING (FWHM)</span></div>
                                <div class="stat"><span class="stat-value">{{ entry.guiding_rms_avg_arcsec | default('N/A') }}{% if entry.guiding_rms_avg_arcsec %}"{% endif %}</span><span class="stat-label">GUIDING (RMS)</span></div>
                                <div class="stat"><span class="stat-value">{{ entry.sky_sqm_observed | default('N/A') }}</span><span class="stat-label">SKY QUALITY (SQM)</span></div>
                                <div class="stat">
                                    <span class="stat-value">
                                        {% set mono_filters = ['L', 'R', 'G', 'B', 'Ha', 'OIII', 'SII'] %}{% set has_mono_data = namespace(found=false) %}{% for filt_key in mono_filters %}{% if entry['filter_' ~ filt_key ~ '_subs'] or entry['filter_' ~ filt_key ~ '_exposure_sec'] %}{% set has_mono_data.found = true %}{% endif %}{% endfor %}
                                        {% if has_mono_data.found %}Multiple{% else %}{{ entry.number_of_subs_light | default('N/A') }}x{{ entry.exposure_time_per_sub_sec | default('N/A') }}s{% endif %}
                                    </span><span class="stat-label">EXPOSURES</span>
                                </div>
                            </div>
                            <dl class="detail-grid">
                                <dt>Filter:</dt><dd>{{ entry.filter_used_session | default('N/A') }}</dd>
                                <dt>Telescope Setup:</dt><dd>{{ entry.telescope_setup_notes | default('N/A') }}</dd>
                                {% if entry.session_image_file %}<dt style="grid-column: 1 / -1;">Session Image:</dt>
                                    <dd style="grid-column: 1 / -1; margin-top: 8px;"><a href="{{ url_for('get_uploaded_image', username=(current_user.username if not SINGLE_USER_MODE else 'default'), filename=entry.session_image_file) }}" target="_blank" title="Click to view full size"><img src="{{ url_for('get_uploaded_image', username=(current_user.username if not SINGLE_USER_MODE else 'default'), filename=entry.session_image_file) }}" alt="Session Image" style="max-width: 100%; max-height: 400px; border-radius: 6px; border: 1px solid #ddd; display: block; object-fit: contain;"></a></dd>
                                {% endif %}
                            </dl>
                        </div>
                        <div id="sky-tab" class="detail-tab-content"><dl class="detail-grid"><dt>Seeing (FWHM):</dt><dd>{{ entry.seeing_observed_fwhm | default('N/A') }}"</dd><dt>SQM:</dt><dd>{{ entry.sky_sqm_observed | default('N/A') }}</dd><dt>Moon Illum/Sep:</dt><dd>{{ entry.moon_illumination_session | default('N/A') }}% / {{ entry.moon_angular_separation_session | default('N/A') }}°</dd><dt>Telescope Setup:</dt><dd>{{ entry.telescope_setup_notes | default('N/A') }}</dd><dt>Guiding RMS:</dt><dd>{{ entry.guiding_rms_avg_arcsec | default('N/A') }}"</dd></dl></div>
                        <div id="acq-tab" class="detail-tab-content"><dl class="detail-grid"><dt>Sub Exposure:</dt><dd>{{ entry.exposure_time_per_sub_sec | default('N/A') }}s</dd><dt># Light Subs:</dt><dd>{{ entry.number_of_subs_light | default('N/A') }}</dd><dt>Filter:</dt><dd>{{ entry.filter_used_session | default('N/A') }}</dd><dt>Gain / Offset:</dt><dd>{{ entry.gain_setting | default('N/A') }} / {{ entry.offset_setting | default('N/A') }}</dd></dl>{% set mono_filters = [('L', 'Luminance'), ('R', 'Red'), ('G', 'Green'), ('B', 'Blue'), ('Ha', 'H-alpha'), ('OIII', 'OIII'), ('SII', 'SII')] %}{% set has_mono_data = namespace(found=false) %}{% for filt_key, _ in mono_filters %}{% if entry['filter_' ~ filt_key ~ '_subs'] or entry['filter_' ~ filt_key ~ '_exposure_sec'] %}{% set has_mono_data.found = true %}{% endif %}{% endfor %}{% if has_mono_data.found %}<div class="form-section-title" style="margin-top:25px;">Monochrome Exposures</div><dl class="detail-grid">{% for filt_key, filt_name in mono_filters %}{% set subs = entry['filter_' ~ filt_key ~ '_subs'] %}{% set exp = entry['filter_' ~ filt_key ~ '_exposure_sec'] %}{% if subs or exp %}<dt>{{ filt_name }} ({{ filt_key }}):</dt><dd>{{ subs | default('N/A') }} subs x {{ exp | default('N/A') }}s</dd>{% endif %}{% endfor %}</dl>{% endif %}</div>
                        <div id="outcome-tab" class="detail-tab-content"><dl class="detail-grid"><dt>Session Rating:</dt><dd>{{ entry.session_rating_subjective | default('N/A') }} ★</dd><dt>Notes:</dt><dd><div class="notes-block">{{ entry.notes | default('N/A') }}</div></dd></dl></div>
                    </div>

                    <div class="edit-mode">
                        <div class="form-row"><div class="form-group"><label for="session_date">Session Date:</label><input type="date" id="session_date" name="session_date" onchange="updateMoonData()" value=""></div><div class="form-group"><label for="location_name">Location:</label><select id="location_name" name="location_name" onchange="updateMoonData()">{% for loc in available_locations %}<option value="{{ loc.name }}" data-lat="{{ loc.lat }}" data-lon="{{ loc.lon }}" data-tz="{{ loc.timezone }}">{{ loc.name }}</option>{% endfor %}</select></div></div>
                        <div class="form-group full-width"><label for="project_selection">Link to Project (Optional)</label><select name="project_selection" id="project_selection" onchange="toggleNewProjectField()"><option value="standalone">-- Standalone Session --</option>{% for project in all_projects %}<option value="{{ project.id }}">{{ project.name }}</option>{% endfor %}<option value="new_project">-- Create New Project --</option></select></div>
                        <div class="form-group full-width" id="new_project_name_group" style="display: none;"><label for="new_project_name">New Project Name:</label><input type="text" name="new_project_name" id="new_project_name" placeholder="e.g., M31 Galaxy - 2025"></div>
                        <div class="form-row"><div class="form-group"><label>Seeing (FWHM, arcsec):</label><input type="number" step="0.01" name="seeing_observed_fwhm"></div><div class="form-group"><label>SQM Reading:</label><input type="number" step="0.01" name="sky_sqm_observed"></div></div>
                        <div class="form-row"><div class="form-group"><label>Moon Illumination (%):</label><input type="number" step="0.1" id="moon_illumination_session" name="moon_illumination_session"></div><div class="form-group"><label>Moon Angular Separation (°):</label><input type="number" step="0.1" id="moon_angular_separation_session" name="moon_angular_separation_session"></div></div>
                        <div class="form-group"><label for="rig-selector">Select a Rig (Optional):</label><select id="rig-selector" onchange="document.getElementById('telescope_setup_notes').value = this.value;"><option value="">-- Manually Enter Below --</option>{% for rig in available_rigs %}<option value="{{ rig.resolved_string }}">{{ rig.rig_name }}</option>{% endfor %}</select></div>
                        <div class="form-group"><label>Telescope Setup Notes:</label><textarea id="telescope_setup_notes" name="telescope_setup_notes" rows="3"></textarea></div>
                        <div class="form-group"><label>Guiding RMS (avg, arcsec):</label><input type="number" step="0.01" name="guiding_rms_avg_arcsec"></div>
                        <div class="form-row"><div class="form-group"><label>Sub Exposure (sec):</label><input type="number" name="exposure_time_per_sub_sec"></div><div class="form-group"><label># Light Subs:</label><input type="number" name="number_of_subs_light"></div><div class="form-group"><label>Filter:</label><input type="text" name="filter_used_session"></div><div class="form-group"><label>Gain:</label><input type="number" name="gain_setting"></div><div class="form-group"><label>Offset:</label><input type="number" name="offset_setting"></div></div>
                        {% set mono_filters = [('L', 'Luminance'), ('R', 'Red'), ('G', 'Green'), ('B', 'Blue'), ('Ha', 'H-alpha'), ('OIII', 'OIII'), ('SII', 'SII')] %}
                        <div class="form-section-title" style="margin-top:20px;">Monochrome Filter Exposures</div>
                        {% for filt_key, filt_name in mono_filters %}
                            <div class="form-row"><div class="form-group" style="flex: 0 0 200px; align-self: center;"><label style="margin-bottom:0;">{{ filt_name }} ({{ filt_key }}):</label></div><div class="form-group"><label># Subs:</label><input type="number" name="filter_{{ filt_key }}_subs" min="0" step="1" placeholder="Count"></div><div class="form-group"><label>Exp (sec/sub):</label><input type="number" name="filter_{{ filt_key }}_exposure_sec" min="0" step="1" placeholder="Seconds"></div></div>
                        {% endfor %}
                        <div class="form-group"><label>Session Rating (1-5 ★):</label><input type="number" min="1" max="5" name="session_rating_subjective"></div>
                        <div class="form-group"><label>General Notes, Problems, Learnings:</label><textarea name="general_notes_problems_learnings"></textarea></div>
                        {% if entry.session_image_file %}<div class="form-group full-width"><label>Current Image:</label><div style="display: flex; align-items: center; gap: 15px;"><span style="font-family: monospace; font-size: 13px;">{{ entry.session_image_file }}</span><label style="color: #c0392b; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; white-space: nowrap;"><input type="checkbox" name="delete_session_image" value="1"> Delete Image</label></div></div>{% endif %}
                        <div class="form-group full-width"><label for="session_image">Upload New or Replace Image (optional, max 5MB)</label><input type="file" id="session_image" name="session_image" accept="image/jpeg, image/png, image/gif"></div>
                    </div>
                </form>

            {% else %}
                {# This is the message that shows when NO session is selected #}
                <div style="padding-top: 50px; padding-left: 20px; color: #6c757d;">
                    <p>← Select a session from the history to view its details, or add a new one.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function showDetailTab(tabName) {
        document.querySelectorAll('.detail-tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.detail-tab-button').forEach(button => button.classList.remove('active'));
        document.getElementById(tabName + '-tab').classList.add('active');
        document.querySelector(`.detail-tab-button[data-tab="${tabName}"]`).classList.add('active');
    }

    function populateEditForm(data) {
        if (!data) return;
        const form = document.getElementById('journal-detail-form');
        form.elements['seeing_observed_fwhm'].value = data.seeing_observed_fwhm || '';
        form.elements['sky_sqm_observed'].value = data.sky_sqm_observed || '';
        form.elements['moon_illumination_session'].value = data.moon_illumination_session || '';
        form.elements['moon_angular_separation_session'].value = data.moon_angular_separation_session || '';
        form.elements['telescope_setup_notes'].value = data.telescope_setup_notes || '';
        form.elements['guiding_rms_avg_arcsec'].value = data.guiding_rms_avg_arcsec || '';
        form.elements['exposure_time_per_sub_sec'].value = data.exposure_time_per_sub_sec || '';
        form.elements['number_of_subs_light'].value = data.number_of_subs_light || '';
        form.elements['filter_used_session'].value = data.filter_used_session || '';
        form.elements['gain_setting'].value = data.gain_setting || '';
        form.elements['offset_setting'].value = data.offset_setting || '';
        form.elements['session_rating_subjective'].value = data.session_rating_subjective || '';
        form.elements['general_notes_problems_learnings'].value = data.notes || '';
        const monoFilters = ['L', 'R', 'G', 'B', 'Ha', 'OIII', 'SII'];
        monoFilters.forEach(filt => {
            form.elements[`filter_${filt}_subs`].value = data[`filter_${filt}_subs`] || '';
            form.elements[`filter_${filt}_exposure_sec`].value = data[`filter_${filt}_exposure_sec`] || '';
        });
        if (data.project_id) { form.elements['project_selection'].value = data.project_id; }
        else { form.elements['project_selection'].value = 'standalone'; }
        toggleNewProjectField();
    }

    function setupAddMode() {
        const wrapper = document.getElementById('session-detail-wrapper');
        const form = document.getElementById('journal-detail-form');
        const title = document.getElementById('detail-title');
        wrapper.innerHTML = `<div class="detail-header"><h4 id="detail-title">Add New Session for {{ alt_name | default(object_name, True) }}</h4><div class="action-button-group"><button id="form-submit-button" type="submit" form="journal-detail-form" class="inline-button" style="background-color:#28a745;">Add Session</button><button type="button" class="inline-button" style="background-color:#6c757d;" onclick="window.location.reload()">Cancel</button></div></div>` + form.outerHTML;
        const newForm = document.getElementById('journal-detail-form');
        newForm.action = '{{ url_for("journal_add_for_target", object_name=object_name) }}';
        newForm.reset();
        newForm.elements.session_id.value = '';
        newForm.elements.session_date.value = '{{ today_date }}';
        newForm.elements.location_name.value = '{{ default_location }}';
        newForm.elements['project_selection'].value = 'standalone';
        document.querySelector('.view-mode').style.display = 'none';
        document.querySelector('.edit-mode').style.display = 'block';
        showDetailTab('sky');
        updateMoonData();
        toggleNewProjectField();
    }

    function setupEditMode() {
        const wrapper = document.getElementById('session-detail-wrapper');
        const form = document.getElementById('journal-detail-form');
        wrapper.classList.add('is-editing');
        wrapper.classList.remove('is-adding');
        if (window.selectedSessionData) {
            document.getElementById('detail-title').textContent = 'Editing Session: ' + new Date(window.selectedSessionData.date_utc).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
            form.action = `/journal/edit/${window.selectedSessionData.id}`;
            form.elements.session_date.value = window.selectedSessionData.date_utc.split('T')[0];
            form.elements.location_name.value = window.selectedSessionData.location_name;
            populateEditForm(window.selectedSessionData);
        }
        showDetailTab('sky');
        updateMoonData();
    }

    function cancelForm() {
        const wrapper = document.getElementById('session-detail-wrapper');
        wrapper.classList.remove('is-editing', 'is-adding');
        showDetailTab('summary');
    }

    async function updateMoonData() {
        const date = document.getElementById('session_date').value;
        const locationSelect = document.getElementById('location_name');
        const selectedOption = locationSelect.options[locationSelect.selectedIndex];
        if (!date || !selectedOption) return;
        const lat = selectedOption.dataset.lat;
        const lon = selectedOption.dataset.lon;
        const tz = selectedOption.dataset.tz;
        const ra = '{{ object_main_details["RA (hours)"] }}';
        const dec = '{{ object_main_details["DEC (degrees)"] }}';
        const apiUrl = `/api/get_moon_data?date=${date}&lat=${lat}&lon=${lon}&ra=${ra}&dec=${dec}&tz=${tz}`;
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            if (data.status === 'success') {
                document.getElementById('moon_illumination_session').value = data.moon_illumination;
                document.getElementById('moon_angular_separation_session').value = data.angular_separation;
            } else { console.error('Error fetching moon data:', data.message); }
        } catch (error) { console.error('Failed to fetch moon data:', error); }
    }

    function toggleNewProjectField() {
        const projectSelect = document.getElementById('project_selection');
        const newProjectGroup = document.getElementById('new_project_name_group');
        if (projectSelect && newProjectGroup) {
            if (projectSelect.value === 'new_project') {
                newProjectGroup.style.display = 'block';
            } else {
                newProjectGroup.style.display = 'none';
            }
        }
    }

    document.addEventListener('DOMContentLoaded', toggleNewProjectField);
</script>