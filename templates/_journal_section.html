{# templates/_journal_section.html #}
<style>
    .journal-container { display: flex; gap: 25px; align-items: flex-start; }
    .session-list-column { flex: 0 0 450px; max-height: 750px; overflow-y: auto; }
    .session-detail-column { flex: 1 1 auto; max-height: 750px; overflow-y: auto; padding-right: 15px; }

    .detail-tabs-container { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ccc; }
    .detail-tab-button { padding: 8px 16px; cursor: pointer; border: none; background-color: transparent; color: #555; border-bottom: 2px solid transparent; font-size: 15px; }
    .detail-tab-button.active { color: #0056b3; border-bottom-color: #0056b3; font-weight: 600; }
    .detail-tab-content { display: none; }
    .detail-tab-content.active { display: block; }

    .edit-mode, #add-session-view { display: none; }
    .is-editing .view-mode, .is-adding .view-mode { display: none; }
    .is-editing .edit-mode, .is-adding .edit-mode { display: block; }
    .is-editing .detail-tab-button[data-tab="summary"], .is-adding .detail-tab-button[data-tab="summary"] { display: none; }

    .summary-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 20px; text-align: center; padding: 15px; background-color: #e9ecef; border-radius: 6px; margin-bottom: 25px; }
    .summary-box .stat-value { font-size: 1.4em; font-weight: 600; color: #343a40; display: block; }
    .summary-box .stat-label { font-size: 0.8em; color: #6c757d; text-transform: uppercase; }

    .detail-grid { display: grid; grid-template-columns: max-content 1fr; gap: 12px 20px; align-items: baseline; }
    .detail-grid > dt { font-weight: 600; color: #495057; }
    .detail-grid > dd { margin: 0; color: #212529; }
    .notes-block { margin-top: 8px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; white-space: pre-wrap; min-height: 60px; }

    h3 { font-size: 1.4em; font-weight: 600; color: #333; margin-bottom: 1em; }
    .session-list-column h4, .session-detail-column h4 { font-size: 1.2em; font-weight: 600; margin-top: 0; margin-bottom: 0; color: #343a40; }

    .edit-mode .form-group input, .edit-mode .form-group textarea, .edit-mode .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
    .edit-mode .form-group textarea { min-height: 100px; }

    .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75em; }
    .history-header .inline-button { font-size: 13px; padding: 6px 12px; margin-right: 0; }

    .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; }
    .detail-header .action-button-group { margin: 0; }
</style>

{% if object_specific_sessions or True %}
<div class="journal-container">
    <div class="session-list-column">
        <div class="history-header">
            <h4>Session History:</h4>
            <button type="button" class="inline-button" onclick="setupAddMode()">Add New Session</button>
        </div>
        <div class="table-wrapper" style="border-top: 1px solid #dee2e6;">
            <table class="session-history-table">
                <thead>
                    <tr><th class="col-date">Date & Location</th><th class="col-integ">Integ.</th><th class="col-rating">Rating</th></tr>
                </thead>
                <tbody>
                {% for session_item in object_specific_sessions %}
                <tr class="clickable-session-row {{ 'current-session-item' if session_item.session_id == current_session_id else '' }}"
                    onclick='window.location.href="{{ url_for("graph_dashboard", object_name=object_name, day=selected_day, month=selected_month, year=selected_year, session_id=session_item.session_id) }}"'>
                    <td class="col-date">{{ session_item.session_date |date_eu| default("N/A") }}<br><small style="color:#555;">{{ session_item.location_name | default("N/A") }}</small></td>
                    <td class="col-integ">{% set integ_min = session_item.get('calculated_integration_time_minutes') %}{{ integ_min | round(0) if integ_min is number and integ_min != 'N/A' else 'N/A' }} min</td>
                    <td class="col-rating">{{ session_item.session_rating_subjective | default('N/A') }}{% if session_item.session_rating_subjective and session_item.session_rating_subjective != 'N/A' and session_item.session_rating_subjective is not none %} ★{% endif %}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="session-detail-column">
        <div id="session-detail-wrapper">
            <div class="detail-header">
                <h4 id="detail-title">{% if selected_session_data %}Details for Session: {{ selected_session_data.session_date | date_eu }}{% endif %}</h4>
                <div class="action-button-group view-mode" {% if not selected_session_data %}style="display:none;"{% endif %}>
                    <button type="button" class="inline-button" style="background-color:#ffc107; color:black;" onclick="setupEditMode()">Edit This Session</button>
                    <form action="{{ url_for('journal_delete', session_id=selected_session_data.session_id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure?');">
                        <button type="submit" class="inline-button" style="background-color:#dc3545;">Delete This Session</button>
                    </form>
                </div>
            </div>

            <form id="journal-detail-form" method="POST" action="">
                <input type="hidden" name="session_id" value="{{ selected_session_data.session_id if selected_session_data else '' }}">
                <div class="action-button-group edit-mode">
                    <button id="form-submit-button" type="submit" class="inline-button" style="background-color:#28a745;"></button>
                    <button type="button" class="inline-button" style="background-color:#6c757d;" onclick="cancelForm()">Cancel</button>
                </div>

                <div class="detail-tabs-container">
                    <button type="button" class="detail-tab-button active" data-tab="summary" onclick="showDetailTab('summary')">Summary</button>
                    <button type="button" class="detail-tab-button" data-tab="sky" onclick="showDetailTab('sky')">Sky & Equipment</button>
                    <button type="button" class="detail-tab-button" data-tab="acq" onclick="showDetailTab('acq')">Acquisition</button>
                    <button type="button" class="detail-tab-button" data-tab="outcome" onclick="showDetailTab('outcome')">Outcome</button>
                </div>

                <div class="view-mode">
                {% if selected_session_data %}
                    <div id="summary-tab" class="detail-tab-content active">
                        <div class="summary-box">
                             <div class="stat"><span class="stat-value">{% set integ_min = selected_session_data.get('calculated_integration_time_minutes') %}{{ integ_min | round(0) if integ_min is number and integ_min != 'N/A' else 'N/A' }}</span><span class="stat-label">MINUTES</span></div>
                             <div class="stat"><span class="stat-value">{{ selected_session_data.seeing_observed_fwhm | default('N/A') }}"</span><span class="stat-label">SEEING (FWHM)</span></div>
                             <div class="stat"><span class="stat-value">{{ selected_session_data.guiding_rms_avg_arcsec | default('N/A') }}"</span><span class="stat-label">GUIDING (RMS)</span></div>
                             <div class="stat"><span class="stat-value">{{ selected_session_data.session_rating_subjective | default('N/A') }} ★</span><span class="stat-label">RATING</span></div>
                        </div>
                        <dl class="detail-grid">
                            <dt>Location:</dt><dd>{{ selected_session_data.location_name | default('N/A') }}</dd>
                            <dt>SQM:</dt><dd>{{ selected_session_data.sky_sqm_observed | default('N/A') }}</dd>
                            <dt>Filter:</dt><dd>{{ selected_session_data.filter_used_session | default('N/A') }}</dd>

                            <dt>Subs:</dt>
                            <dd>
                                {% set mono_filters = [('L'), ('R'), ('G'), ('B'), ('Ha'), ('OIII'), ('SII')] %}
                                {% set has_mono_data = namespace(found=false) %}
                                {% for filt_key in mono_filters %}
                                    {% if selected_session_data.get('filter_' ~ filt_key ~ '_subs') or selected_session_data.get('filter_' ~ filt_key ~ '_exposure_sec') %}
                                        {% set has_mono_data.found = true %}
                                    {% endif %}
                                {% endfor %}

                                {% if has_mono_data.found %}
                                    Multiple (Mono)
                                {% else %}
                                    {{ selected_session_data.number_of_subs_light | default('N/A') }} x {{ selected_session_data.exposure_time_per_sub_sec | default('N/A') }}s
                                {% endif %}
                            </dd>
                            </dl>
                    </div>
                {% else %}
                     <div style="text-align:center; padding-top: 50px; color: #6c757d;"><p>← Select a session from the history to view its details, or add a new one.</p></div>
                {% endif %}
                </div>

                {% set entry = selected_session_data or {} %}
                <div class="edit-mode">
                    <div class="form-group"><label for="session_date">Session Date:</label><input type="date" id="session_date" name="session_date" value=""></div>
                    <div class="form-group"><label for="location_name">Location:</label><select id="location_name" name="location_name">{% for loc_name_key, loc_details in available_locations.items() %}<option value="{{ loc_name_key }}">{{ loc_name_key }}</option>{% endfor %}</select></div>
                </div>

                <div id="sky-tab" class="detail-tab-content">
                    <div class="view-mode"><dl class="detail-grid"><dt>Seeing (FWHM):</dt><dd>{{ entry.seeing_observed_fwhm | default('N/A') }}"</dd><dt>SQM:</dt><dd>{{ entry.sky_sqm_observed | default('N/A') }}</dd><dt>Telescope Setup:</dt><dd>{{ entry.telescope_setup_notes | default('N/A') }}</dd><dt>Guiding RMS:</dt><dd>{{ entry.guiding_rms_avg_arcsec | default('N/A') }}"</dd></dl></div>
                    <div class="edit-mode"><div class="form-row"><div class="form-group"><label>Seeing (FWHM, arcsec):</label><input type="number" step="0.01" name="seeing_observed_fwhm" value="{{ entry.seeing_observed_fwhm if entry.seeing_observed_fwhm is not none else '' }}"></div><div class="form-group"><label>SQM Reading:</label><input type="number" step="0.01" name="sky_sqm_observed" value="{{ entry.sky_sqm_observed if entry.sky_sqm_observed is not none else '' }}"></div></div><div class="form-group"><label>Telescope Setup Notes:</label><textarea name="telescope_setup_notes" rows="3">{{ entry.telescope_setup_notes or '' }}</textarea></div><div class="form-group"><label>Guiding RMS (avg, arcsec):</label><input type="number" step="0.01" name="guiding_rms_avg_arcsec" value="{{ entry.guiding_rms_avg_arcsec if entry.guiding_rms_avg_arcsec is not none else '' }}"></div></div>
                </div>

                <div id="acq-tab" class="detail-tab-content">
                    <div class="view-mode">
                        <dl class="detail-grid"><dt>Sub Exposure:</dt><dd>{{ entry.exposure_time_per_sub_sec | default('N/A') }}s</dd><dt># Light Subs:</dt><dd>{{ entry.number_of_subs_light | default('N/A') }}</dd><dt>Filter:</dt><dd>{{ entry.filter_used_session | default('N/A') }}</dd><dt>Gain / Offset:</dt><dd>{{ entry.gain_setting | default('N/A') }} / {{ entry.offset_setting | default('N/A') }}</dd></dl>
                        {% set mono_filters = [('L', 'Luminance'), ('R', 'Red'), ('G', 'Green'), ('B', 'Blue'), ('Ha', 'H-alpha'), ('OIII', 'OIII'), ('SII', 'SII')] %}
                        {% set has_mono_data = namespace(found=false) %}
                        {% for filt_key, _ in mono_filters %}{% if entry.get('filter_' ~ filt_key ~ '_subs') or entry.get('filter_' ~ filt_key ~ '_exposure_sec') %}{% set has_mono_data.found = true %}{% endif %}{% endfor %}
                        {% if has_mono_data.found %}
                        <div class="form-section-title" style="margin-top:25px;">Monochrome Exposures</div>
                        <dl class="detail-grid">
                        {% for filt_key, filt_name in mono_filters %}
                            {% set subs = entry.get('filter_' ~ filt_key ~ '_subs') %}
                            {% set exp = entry.get('filter_' ~ filt_key ~ '_exposure_sec') %}
                            {% if subs or exp %}
                                <dt>{{ filt_name }} ({{ filt_key }}):</dt>
                                <dd>{{ subs | default('N/A') }} subs x {{ exp | default('N/A') }}s</dd>
                            {% endif %}
                        {% endfor %}
                        </dl>
                        {% endif %}
                    </div>
                    <div class="edit-mode">
                        <div class="form-row"><div class="form-group"><label>Sub Exposure (s):</label><input type="text" name="exposure_time_per_sub_sec" value="{{ entry.exposure_time_per_sub_sec if entry.exposure_time_per_sub_sec is not none else '' }}"></div><div class="form-group"><label># Light Subs:</label><input type="text" name="number_of_subs_light" value="{{ entry.number_of_subs_light if entry.number_of_subs_light is not none else '' }}"></div></div>
                        <div class="form-group"><label>Filter Used (for OSC/broadband):</label><input type="text" name="filter_used_session" value="{{ entry.filter_used_session or '' }}"></div>
                        <div class="form-row"><div class="form-group"><label>Gain:</label><input type="number" name="gain_setting" value="{{ entry.gain_setting if entry.gain_setting is not none else '' }}"></div><div class="form-group"><label>Offset:</label><input type="number" name="offset_setting" value="{{ entry.offset_setting if entry.offset_setting is not none else '' }}"></div></div>
                        <div class="form-section-title" style="margin-top:20px;">Monochrome Filter Exposures</div>
                        {% for filt_key, filt_name in mono_filters %}
                        <div class="form-row">
                            <div class="form-group" style="flex: 0 0 200px; align-self: center;"><label style="margin-bottom:0;">{{ filt_name }} ({{ filt_key }}):</label></div>
                            <div class="form-group"><label># Subs:</label><input type="number" name="filter_{{ filt_key }}_subs" min="0" step="1" value="{{ entry['filter_' ~ filt_key ~ '_subs'] if entry['filter_' ~ filt_key ~ '_subs'] is not none else '' }}" placeholder="Count"></div>
                            <div class="form-group"><label>Exp (sec/sub):</label><input type="number" name="filter_{{ filt_key }}_exposure_sec" min="0" step="1" value="{{ entry['filter_' ~ filt_key ~ '_exposure_sec'] if entry['filter_' ~ filt_key ~ '_exposure_sec'] is not none else '' }}" placeholder="Seconds"></div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div id="outcome-tab" class="detail-tab-content">
                    <div class="view-mode"><dl class="detail-grid"><dt>Session Rating:</dt><dd>{{ entry.session_rating_subjective | default('N/A') }} ★</dd><dt>Notes:</dt><dd><div class="notes-block">{{ entry.general_notes_problems_learnings | default('N/A') }}</div></dd></dl></div>
                    <div class="edit-mode"><div class="form-group"><label>Session Rating (1-5 ★):</label><input type="number" min="1" max="5" name="session_rating_subjective" value="{{ entry.session_rating_subjective if entry.session_rating_subjective is not none else '' }}"></div><div class="form-group"><label>General Notes, Problems, Learnings:</label><textarea name="general_notes_problems_learnings">{{ entry.general_notes_problems_learnings if entry else '' }}</textarea></div></div>
                </div>
            </form>
        </div>
    </div>
</div>
{% else %}
    <p style="margin-top:15px; color:#777;">No journal entries found for this object yet.</p>
{% endif %}

<script>
    function showDetailTab(tabName) {
        document.querySelectorAll('.detail-tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.detail-tab-button').forEach(button => button.classList.remove('active'));
        document.getElementById(tabName + '-tab').classList.add('active');
        document.querySelector(`.detail-tab-button[data-tab="${tabName}"]`).classList.add('active');
    }

    function setFormMode(mode) {
        const wrapper = document.getElementById('session-detail-wrapper');
        const form = document.getElementById('journal-detail-form');
        const title = document.getElementById('detail-title');
        const submitBtn = document.getElementById('form-submit-button');

        wrapper.classList.remove('is-editing', 'is-adding');

        if (mode === 'edit' || mode === 'add') {
            wrapper.classList.add('is-editing');
            if (mode === 'add') {
                wrapper.classList.add('is-adding');
                title.textContent = 'Add New Session for {{ alt_name | default(object_name, True) }}';
                submitBtn.textContent = 'Add Session';
                form.action = '{{ url_for("journal_add_for_target", object_name=object_name) }}';
                form.reset();
                form.elements.session_id.value = '';
                form.elements.session_date.value = '{{ today_date }}';
                form.elements.location_name.value = '{{ default_location }}';
            } else {
                title.textContent = 'Editing Session: {{ selected_session_data.session_date | date_eu if selected_session_data }}';
                submitBtn.textContent = 'Save Changes';
                form.action = '{{ url_for("journal_edit", session_id=(selected_session_data.session_id if selected_session_data)) }}';
                form.elements.session_date.value = '{{ selected_session_data.session_date if selected_session_data }}';
                form.elements.location_name.value = '{{ selected_session_data.location_name if selected_session_data }}';
            }
            showDetailTab('sky');
        } else {
            title.textContent = '{% if selected_session_data %}Details for Session: {{ selected_session_data.session_date | date_eu }}{% endif %}';
            showDetailTab('summary');
        }
    }

    function setupAddMode() { setFormMode('add'); }
    function setupEditMode() { setFormMode('edit'); }
    function cancelForm() { setFormMode('view'); }

    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('session-detail-wrapper')) {
            if ({{ 'true' if selected_session_data else 'false' }}) {
                setFormMode('view');
            }
        }
    });
</script>