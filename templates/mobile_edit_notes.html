{% extends "mobile_base.html" %}

{% block title %}Edit Notes{% endblock %}
{% block header_title %}Edit: {{ common_name or object_name }}{% endblock %}

{% block content %}
    <form id="edit-notes-form">
        <div class="form-group">
            <input id="project-notes" type="hidden" name="content" value="{{ project_notes_html | e }}">
            <trix-editor input="project-notes"></trix-editor>
        </div>
        <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 20px;">
            <input type="checkbox" id="is-active" style="width: auto;" {% if is_project_active %}checked{% endif %}>
            <label for="is-active" style="margin: 0; font-weight: normal;">Set as Active Project</label>
        </div>
        <button type="submit" class="button" id="save-button" style="margin-top: 20px;">
            Save Notes
        </button>
    </form>

    <div id="message-area" class="message" style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('edit-notes-form');
        const saveButton = document.getElementById('save-button');
        const messageArea = document.getElementById('message-area');

        // --- Get the Trix editor and its hidden input field ---
        const editor = document.querySelector('trix-editor');
        const notesInput = document.getElementById('project-notes'); // The hidden input
        // ---

        const objectName = "{{ object_name | e }}";


        // --- FIX #1: THE TRIX UPLOAD HANDLER ---
        // This listens for when you drop an image into the editor.
        editor.addEventListener('trix-attachment-add', (event) => {
            const file = event.attachment.file;
            if (file) {
                // 1. Create a FormData object
                const formData = new FormData();
                formData.append('file', file);

                // 2. Post it to your (already existing) upload endpoint
                fetch("{{ url_for('upload_editor_image') }}", {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.url) {
                        // 3. On success, tell Trix the URL of the uploaded image
                        event.attachment.setAttributes({
                            url: data.url,
                            href: data.url
                        });
                    }
                })
                .catch(e => {
                    console.error('Upload failed:', e);
                    event.attachment.remove(); // Remove the failed upload
                });
            }
        });
        // --- END OF FIX #1 ---


        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';
            messageArea.style.display = 'none';

            // --- FIX #2: SAVE THE HTML, NOT PLAIN TEXT ---
            // We get the .value from the *hidden input field*
            const notesHtml = notesInput.value;
            // --- END OF FIX #2 ---

            const payload = {
                object: objectName,
                project: notesHtml,
                is_active: document.getElementById('is-active').checked
            };

            try {
                // ... (rest of the fetch/save logic is the same) ...
                const response = await fetch("{{ url_for('update_project') }}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    messageArea.textContent = 'Notes saved successfully!';
                    messageArea.style.color = 'var(--accent-rise)';
                    messageArea.style.display = 'block';

                    saveButton.disabled = false;
                    saveButton.textContent = 'Save Notes';

                    setTimeout(() => {
                        window.location.href = "{{ url_for('mobile_up_now') }}";
                    }, 1500);

                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            } catch (err) {
                messageArea.textContent = `Error: ${err.message}`;
                messageArea.style.color = 'var(--accent-set)';
                messageArea.style.display = 'block';
                saveButton.disabled = false;
                saveButton.textContent = 'Save Notes';
            }
        });
    });
</script>
{% endblock %}