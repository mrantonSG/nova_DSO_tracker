<style>
    #heatmap-tab-content {
        position: relative;
        min-height: 600px;
    }
    #heatmap-wrapper {
        width: 100%;
    }
    #heatmap-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        background-color: #f9f9f9;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #eee;
    }
    #heatmap-legend-text {
        font-size: 0.9em;
        color: #666;
    }
    #yearly-heatmap-plot {
        width: 100%;
        min-height: 600px;
    }

    /* Fixed Loader Styling */
    #heatmap-loading {
        display: none;
        position: absolute;
        top: 150px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255,255,255,0.95);
        padding: 20px 40px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        z-index: 100;
        text-align: center;
        color: #6795a4;
        font-weight: bold;
        border: 1px solid #ddd;
    }
</style>

<div id="heatmap-tab-content" style="display:none;">
    <div id="heatmap-loading">
        Generating Heatmap...<br>
        <small style="color:#666; font-weight:normal;">
            Calculating 52 weeks for all objects.<br>
            (Results are cached for 24 hours for instant reloading.)
        </small>
    </div>

    <div id="heatmap-wrapper">
        <div id="heatmap-controls">
            <div style="display:flex; gap:15px; align-items:center;">
                <label style="font-size: 14px; font-weight: bold; color: #333; cursor: pointer; display: flex; align-items: center;">
                    <input type="checkbox" id="heatmap-active-only" onchange="updateHeatmapFilter()" style="margin-right: 8px;">
                    Active Only
                </label>
                </div>
            <span id="heatmap-legend-text">* Vertical light bands = Full Moon (Washed out). Darker Green = Best Quality. Click object names to view details.</span>
        </div>
        <div id="yearly-heatmap-plot"></div>
    </div>
</div>

<script>
    let heatmapLoaded = false;
    let globalHeatmapData = null;

    // Store the filtered arrays globally so the click handler can access them
    let currentFilteredIds = [];
    let currentFilteredY = [];

    // Force Plotly to resize when the browser window changes
    window.addEventListener('resize', function() {
        const plotDiv = document.getElementById('yearly-heatmap-plot');
        if (heatmapLoaded && plotDiv) {
            Plotly.Plots.resize(plotDiv);
        }
    });

    function updateHeatmapFilter() {
        renderHeatmapFromCache();
    }

    function fetchAndRenderHeatmap() {
        const plotDiv = document.getElementById('yearly-heatmap-plot');
        const loadingDiv = document.getElementById("heatmap-loading");
        const currentLoc = sessionStorage.getItem('selectedLocation') || '';

        if (heatmapLoaded && globalHeatmapData && globalHeatmapData._location === currentLoc) {
            Plotly.Plots.resize(plotDiv);
            return;
        }

        plotDiv.innerHTML = "";
        if (loadingDiv) loadingDiv.style.display = "block";

        fetch(`/api/get_yearly_heatmap?location_name=${encodeURIComponent(currentLoc)}`)
            .then(res => res.json())
            .then(data => {
                if (loadingDiv) loadingDiv.style.display = "none";
                data._location = currentLoc;
                globalHeatmapData = data;
                renderHeatmapFromCache();
            })
            .catch(err => {
                console.error(err);
                if (loadingDiv) loadingDiv.style.display = "none";
                plotDiv.innerHTML = `<div style="color:red; text-align:center; padding:20px;">Error loading heatmap: ${err.message}</div>`;
            });
    }

    function renderHeatmapFromCache() {
        const data = globalHeatmapData;
        const plotDiv = document.getElementById('yearly-heatmap-plot');
        const onlyActive = document.getElementById('heatmap-active-only').checked;

        // --- INTEGRATION: Read from Main Dropdown ---
        const mainDropdown = document.getElementById('saved-views-dropdown');
        const selectedViewName = mainDropdown ? mainDropdown.value : '';

        // Get View Settings from Global 'allSavedViews' (defined in index.html)
        let viewSettings = null;
        if (selectedViewName && window.allSavedViews && window.allSavedViews[selectedViewName]) {
            viewSettings = window.allSavedViews[selectedViewName].settings;
        }

        if (!data || data.error) {
            plotDiv.innerHTML = `<div style="color:red; text-align:center; padding:20px;">${data ? data.error : 'No Data'}</div>`;
            return;
        }

        if (!data.z || data.z.length === 0) {
            plotDiv.innerHTML = `<div style="color:#666; text-align:center; padding:20px;">No objects found with valid coordinates.</div>`;
            return;
        }

        // --- Helper to check if a row matches Saved View criteria ---
        const checkViewMatch = (i) => {
            if (!viewSettings) return true;

            // Type Filter
            const typeFilter = viewSettings['dso_filter_col_key_Type'];
            if (typeFilter) {
                const cellText = (data.types[i] || "").toLowerCase();
                const filterTerms = typeFilter.toLowerCase().split(/[\s,]+/).filter(t => t.length > 0);
                if (filterTerms.length > 0) {
                    const cellTokens = cellText.split(/[\s,]+/).filter(t => t.length > 0);
                    const match = filterTerms.some(term => cellTokens.some(token => token.includes(term)));
                    if (!match) return false;
                }
            }

            // Constellation Filter
            const conFilter = viewSettings['dso_filter_col_key_Constellation'];
            if (conFilter) {
                if (!(data.cons[i] || "").toLowerCase().includes(conFilter.toLowerCase())) return false;
            }

            // Numeric Filters
            const checkNumeric = (val, filter) => {
                if (!filter) return true;
                if (typeof matchesNumericFilter === 'function') {
                    return matchesNumericFilter(val, filter);
                }
                if (filter.startsWith('>')) return val > parseFloat(filter.substring(1));
                if (filter.startsWith('<')) return val < parseFloat(filter.substring(1));
                return true;
            };

            if (!checkNumeric(data.mags[i], viewSettings['dso_filter_col_key_Magnitude'])) return false;
            if (!checkNumeric(data.sizes[i], viewSettings['dso_filter_col_key_Size'])) return false;
            if (!checkNumeric(data.sbs[i], viewSettings['dso_filter_col_key_SB'])) return false;

            return true;
        };

        // --- Filtering ---
        let filteredY = [];
        let filteredZ = [];
        let filteredIds = [];

        for(let i=0; i < data.y.length; i++) {
            if (onlyActive && data.active[i] === 0) continue;
            if (!checkViewMatch(i)) continue;

            filteredY.push(data.y[i]);
            filteredZ.push(data.z[i]);
            filteredIds.push(data.ids[i]);
        }

        if (filteredY.length === 0) {
             plotDiv.innerHTML = `<div style="color:#666; text-align:center; padding:20px; padding-top:100px; font-size: 1.2em;">No active projects found matching criteria.<br><br><small>Uncheck 'Active Only' or clear Saved View filter.</small></div>`;
             return;
        } else {
            plotDiv.innerHTML = "";
        }

        // Update Globals for Click Handler
        currentFilteredIds = filteredIds;
        currentFilteredY = filteredY;

        // --- Moon Overlays ---
        const shapes = [];
        if (data.moon_phases) {
            data.moon_phases.forEach((phase, index) => {
                if (phase > 80) {
                    shapes.push({
                        type: 'rect',
                        xref: 'x',
                        yref: 'paper',
                        x0: index - 0.5,
                        x1: index + 0.5,
                        y0: 0,
                        y1: 1,
                        fillcolor: 'rgba(255, 255, 255, 0.75)',
                        line: { width: 0 },
                        layer: 'above'
                    });
                }
            });
        }

        const novaColorScale = [
            [0.0, '#ffffff'],
            [0.1, '#f0f4f5'],
            [0.3, '#dce5eb'],
            [0.6, '#83b4c5'],
            [1.0, '#5a8491']
        ];

        const trace = {
            z: filteredZ,
            x: data.x,
            y: filteredY,
            type: 'heatmap',
            colorscale: novaColorScale,
            showscale: false,
            xgap: 1,
            ygap: 1,
            hovertemplate: '<b>%{y}</b><br>Week: %{x}<br>Score: %{z:.0f}/100<extra></extra>'
        };

        const calculatedHeight = Math.max(600, filteredY.length * 15);

        const layout = {
            height: calculatedHeight,
            xaxis: {
                title: '',
                side: 'top',
                tickangle: -90,
                fixedrange: true,
                tickfont: { size: 11, color: '#555' }
            },
            yaxis: {
                automargin: true,
                fixedrange: true,
                tickfont: { size: 11, color: '#333' }
            },
            dragmode: false,
            margin: { l: 180, r: 20, b: 20, t: 100 },
            shapes: shapes,
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)'
        };

        const config = {
            responsive: true,
            displayModeBar: false
        };

        Plotly.newPlot(plotDiv, [trace], layout, config).then(() => {
            heatmapLoaded = true;

            plotDiv.removeAllListeners('plotly_click');

            // --- CLICK HANDLER ---
            plotDiv.on('plotly_click', function(evt){
                if(evt.points && evt.points.length > 0) {
                    const point = evt.points[0];
                    const yIndex = currentFilteredY.indexOf(point.y);
                    const xIndex = globalHeatmapData.x.indexOf(point.x);

                    if (yIndex !== -1 && xIndex !== -1) {
                        const objectId = currentFilteredIds[yIndex];

                        if (globalHeatmapData.dates && globalHeatmapData.dates[xIndex]) {
                            const dateStr = globalHeatmapData.dates[xIndex];
                            const [year, month, day] = dateStr.split('-');

                            const currentLoc = sessionStorage.getItem('selectedLocation');
                            const locParam = currentLoc ? `&location=${encodeURIComponent(currentLoc)}` : '';

                            window.location.assign(`/graph_dashboard/${encodeURIComponent(objectId)}?tab=chart&year=${year}&month=${month}&day=${day}${locParam}`);
                        }
                    }
                }
            });
        });
    }

    function resetHeatmapState() {
        heatmapLoaded = false;
        globalHeatmapData = null;
        const plotDiv = document.getElementById('yearly-heatmap-plot');
        if(plotDiv) plotDiv.innerHTML = "";
    }
</script>