{% extends "base.html" %}

{% block title %}Graph – Nova DSO Tracker{% endblock %}

{% block head_extra %}

  <script src="https://aladin.cds.unistra.fr/AladinLite/api/v3/latest/aladin.js" charset="utf-8"></script>
  <style>
    /* Basic styles, merged from index and additional styling */
    body {
      padding: 20px;
      margin: 0;
    }

    #back-button {
      margin-top: 0;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #83b4c5;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #back-button:hover {
      background-color: #6795a4 !important;
    }
    /* Chart container */
    #chart-section {
      margin-top: 20px;
    }
    #chart-section img {
      max-width: 100%;
      height: auto;
      border-radius: 5px;
      margin-bottom: 10px;
      margin-bottom: 20px;
    }
    /* Day/Month/Year controls */
    .date-controls {
      display: flex;         /* For internal layout of Day, Month, Year inputs/buttons */
      align-items: center;   /* Vertically aligns items within this line */
      gap: 10px;             /* Spacing between items like Day, Month, Year, buttons */

      margin-top: 10px;      /* Space from the graph image above - adjust as needed */
      margin-bottom: 30px;   /* Space after this controls block - adjust as needed */

      /* --- Key change for positioning: --- */
      margin-left: 120px;      /* STARTING VALUE. Increase this (e.g., 20px, 50px, 100px)
                                 to push the entire line from the left edge of the chart-section. */

    }

    .date-controls label, .date-controls input, .date-controls select {
      font-size: 14px;
      padding: 4px;
    }
    /* View-switching buttons */
    .view-buttons {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }
    .view-button {
      background-color: #83b4c5;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      padding: 8px 16px;
      font-size: 14px;
    }
    .view-button:hover {
      background-color: #6795a4;
    }
    /* Project field and buttons area */
    .button-container {
      margin-top: 0px;
    }
    #project-field {
      width: 100%;
      max-width: 970px;
      height: 150px;
      box-sizing: border-box;
      font-size: 15px;
    }
    .inline-button {
      background-color: #83b4c5;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      padding: 10px 20px;
      font-size: 16px;
      margin-right: 10px;
    }
    .inline-button:hover {
      background-color: #6795a4;
    }
    .button-container {
      padding: 10px;
      margin-left: 50px;
    }

    /* Styles for the new two-column top information area */
    .top-info-grid {
      display: flex;
      /* align-items: flex-start; */ /* Remove this or comment out */
      align-items: stretch;      /* ADD THIS: Makes both columns equal height */
      margin-bottom: 40px;     /* Or your preferred space before the graph */
    }

    .info-button-column {
      flex-shrink: 0;
      padding-right: 15px;
      margin-right: 15px;
      border-right: 1px solid #ccc; /* This border will now span the full stretched height */

      /* Optional: Add these to keep the button at the top of its stretched column */
      display: flex;
      flex-direction: column; /* Though only one item, good practice */
      align-items: flex-start; /* Aligns button to the top */
      /* justify-content: flex-start; /* Ensures button is at the start if column is flex */
    }

    .info-details-column {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }

    /* Styles for .object-title-block-main, .object-common-name, .object-id-name,
       .secondary-info-line-main and its children (p, small, span)
       remain the same as in the previous correct version. */
    /* ... (keep those other styles) ... */

    .primary-info-line .inline-button { /* This rule was from a previous structure, check if still needed or if .info-button-column .inline-button is more appropriate */
      margin-right: 15px;
      flex-shrink: 0;
    }

    /* If .primary-info-line and .object-title-block classes are no longer used in the HTML for this section,
       their specific CSS rules can be removed to avoid confusion.
       The new structure uses .object-title-block-main. */

    .object-title-block-main { /* Replaces .object-title-block if you used my latest HTML */
      margin-bottom: 10px;
    }
    .object-common-name {
      font-size: 1.4em;
      font-weight: bold;
      color: #333;
    }
    .object-id-name {
      font-size: 1.2em;
      font-weight: bold;
      color: #555;
      margin-left: 4px;
    }

    .secondary-info-line-main { /* Replaces .secondary-info-line if you used my latest HTML */
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
      /* width: 100%; /* Not strictly needed if .info-details-column grows and this is a child */
    }
    .secondary-info-line-main p {
      margin: 0;
      font-size: 16px;
    }
    .secondary-info-line-main small {
      font-size: 12px;
      color: #666;
    }
    .secondary-info-line-main span {
      font-weight: bold;
      font-size: 16px;
      color: #000;
    }

    /* Styles for the p, small, span inside .secondary-info-line-main */
    /* These can be adapted from your previous .secondary-info-line p/small/span rules */
    .secondary-info-line-main p {
      margin: 0;
      font-size: 16px;
    }
    .secondary-info-line-main small {
      font-size: 12px;
      color: #666;
    }
    .secondary-info-line-main span {
      font-weight: bold;
      font-size: 16px;
      color: #000;
    }

    /* Your existing .inline-button style for "Back to Tracker" can remain */
    .inline-button {
      background-color: #83b4c5;
      /* ... other .inline-button styles ... */
    }

    .object-title-block {
      flex-grow: 1;
    }

    .object-common-name {
      font-size: 1.4em;
      font-weight: bold;
      color: #333;
    }

    .object-id-name {
      font-size: 1.2em;
      font-weight: bold;
      color: #555;
      margin-left: 4px;
    }

    .inline-button {
      margin-top: 0px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #83b4c5;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .inline-button:hover {
      background-color: #6795a4 !important;
    }
    /* NEW STYLES for Journal Sections on graph_view.html */
    .content-section { /* Common class for distinct sections */
        margin-top: 25px; /* Space above the section */
        padding: 20px;
        background-color: #f8f9fa; /* Light background for the section box */
        border: 1px solid #dee2e6;
        border-radius: 6px;
        margin-bottom: 25px; /* Space below the section */
    }
    .content-section h3 { /* Titles for Journal, Project Notes */
        margin-top: 0;
        color: #343a40;   /* Darker grey for heading */
        border-bottom: 1px solid #ced4da;
        padding-bottom: 10px;
        font-size: 1.2em; /* Slightly larger section titles */
        font-weight: 600;
    }
    .sessions-history-list {
        list-style-type: none;
        padding-left: 0;
        max-height: 250px; /* Scrollable if many sessions */
        overflow-y: auto;
        border: 1px solid #ced4da; /* Border around the list */
        border-radius: 4px;
        background-color: #fff; /* White background for the list itself */
        margin-top: 10px;
    }
    .sessions-history-list li {
        padding: 7px 10px; /* Slightly adjusted padding */
        border-bottom: 1px dotted #e0e0e0;
        font-size: 0.85em; /* Slightly smaller font for list items */
    }
    .sessions-history-list li:last-child { border-bottom: none; }
    .sessions-history-list li a { text-decoration: none; color: #0056b3; }
    .sessions-history-list li a:hover { text-decoration: underline; }
    .sessions-history-list li.current-session-item { /* Highlight for current session in list */
        background-color: #cfe2ff;
        border-left: 3px solid #0056b3;
        padding-left: 7px; /* Adjust if border changes padding */
    }
    .sessions-history-list li.current-session-item a { font-weight:bold; }

    .selected-session-details {
        margin-top: 15px;
        padding: 15px;
        background-color: #ffffff; /* White background for details box */
        border: 1px solid #bac8d3;
        border-radius: 4px;
        max-width: 770px;
    }
    .selected-session-details h4 { margin-top: 0; color: #2c3e50; font-size: 1.05em; font-weight: 600; }
    .selected-session-details p, .selected-session-details div { margin-bottom: 6px; font-size: 0.9em; line-height: 1.5; }
    .selected-session-details strong { color: #1c2833; }
    .action-button-group {
        display: flex;         /* Makes this a flex container */
        align-items: center;   /* Vertically aligns flex items (buttons) to the center */
        /* gap: 8px; */       /* Optional: Replaces margin-right on buttons for spacing */
        margin-top: 10px;
        margin-bottom: 10px;
    }
    .action-button-group .inline-button {
        margin-right: 8px;    /* Keep if not using 'gap' on the parent */
        /* If using 'gap' on .action-button-group, you might remove margin-right here */
        margin-bottom: 5px;
        font-size: 13px;
        padding: 6px 12px;
        text-decoration: none;
        box-sizing: border-box;
        display: inline-block;
        vertical-align: middle;
        line-height: 1.2;
    }
    hr.detail-separator { border: 0; height: 1px; background: #e0e0e0; margin: 10px 0; } /* For separating groups of details */

    #opportunities-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
      margin-left: 20px;
    }

    #opportunities-table th, #opportunities-table td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      text-align: left;
    }

    #opportunities-table th {
      background-color: #83b4c5;
      color: white;
      font-weight: normal;
    }

    #opportunities-table tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    #opportunities-table tr:hover {
      background-color: #e1f0f5;
    }

    #opportunities-section {
      margin-top: 40px;
    }

    .opportunities-heading {
      font-size: 16px;
      font-weight: normal;
      color: #333;
      margin-bottom: 10px;
      margin-left: 20px;
    }
    #opportunities-table th,
    #opportunities-table td {
      text-align: center !important;
      vertical-align: middle !important;
    }
    .highlight {
      background-color: #d6ecff !important; /* Light blue */
    }
    code {
      background-color: #f5f5f5;
      padding: 2px 4px;
      border-radius: 4px;
      font-family: monospace;
    }
    .preserve-newlines {
        white-space: pre-wrap;
        margin-top: 4px; /* Optional: for spacing below the label */
        padding-left: 10px; /* Optional: for indentation */
        border-left: 2px solid #eee; /* Optional: visual cue */
    }

      /* Styles for Session History Table on graph_view.html */
    .session-history-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 0.85em; /* Slightly smaller font */
    }
    .session-history-table th, .session-history-table td {
        border: 1px solid #dde;
        padding: 6px 8px;
        text-align: left;
        vertical-align: middle;
    }
    .session-history-table th {
        background-color: #e9ecef; /* Lighter header */
        font-weight: 600;
    }
    .session-history-table tr.clickable-session-row:hover {
        background-color: #e6f7ff; /* Light blue hover */
        cursor: pointer;
    }
    .session-history-table tr.current-session-item {
        background-color: #cfe2ff !important; /* Ensure this highlight is visible */
        font-weight: bold;
    }
    .session-history-table td.col-date, .session-history-table th.col-date { width: 120px; }
    .session-history-table td.col-location, .session-history-table th.col-location { width: 150px; }
    .session-history-table td.col-setup, .session-history-table th.col-setup { width: auto; } /* Takes remaining */
    .session-history-table td.col-integ, .session-history-table th.col-integ { width: 100px; text-align: center; }
    .session-history-table td.col-rating, .session-history-table th.col-rating { width: 100px; text-align: center; }

    .selected-session-details .form-data-value { /* Now specificity is (0,2,0) - two classes */
        padding: 8px 10px;    /* Increased padding slightly for much larger font */
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        border-radius: 4px;
        min-height: 25px;    /* Increased min-height for larger font */
        word-wrap: break-word;
        font-size: 1.1em;  /* Let's try 1.1em first. 2em will be VERY large. Adjust from here. */
        line-height: 1.5;    /* May need adjustment based on final font size */
    }

    /* You can still have a separate rule for the preserve-newlines variant if needed for other properties */
    .selected-session-details div.form-data-value.preserve-newlines {
        min-height: 80px;
        background-color: #fff;
        border: 1px dashed #ced4da;
        /* font-size will be inherited from the rule above if not overridden here */
    }
    div.form-data-value.preserve-newlines { /* For textareas */
        min-height: 80px; /* Give more space for multi-line notes */
        background-color: #fff; /* White background might be better for readability for notes */
        border: 1px dashed #ced4da; /* Dashed border to indicate it's display text */
    }
    .form-group label {
        display: block;
        margin-bottom: 3px;
        font-weight: normal;
        font-size: 1em;
        color: #495057;
        width: 320px; /* Suggested width - adjust as needed */
        /* Optional: If a single word in a label is too long and you want it to break */
        /* overflow-wrap: break-word; */
    }
    .form-group {
        margin-bottom: 10px; /* Reduced margin */
    }
    .form-section-title { /* Already defined, ensure it's styled as you like */
        font-size: 1.1em; /* Adjusted from previous */
        font-weight: bold;
        color: #333;
        margin-top: 20px;
        margin-bottom: 10px;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
    }
    .form-row { display: flex; gap: 20px; flex-wrap: wrap; } /* Allow wrapping for form rows */
    .form-row .form-group { flex: 1; min-width: 200px; } /* Min width before wrapping */

    /* --- NEW CSS for the Framing Table --- */
    .framing-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    .framing-table th, .framing-table td {
        border: 1px solid #eee;
        padding: 10px;
        text-align: left;
        font-size: 14px;
    }
    .framing-table th {
        background-color: #f9f9f9;
        font-weight: 600;
    }

    .framing-controls { color: black; } /* Make control text readable */

    /* --- CSS for the Framing Modal --- */
    .modal {
        display: none; position: fixed; z-index: 1000;
        left: 0; top: 0; width: 100%; height: 100%;
        overflow: auto; background-color: rgba(0,0,0,0.6);
    }

    .modal-close {
        color: #aaa;
        position: absolute;
        top: 5px;
        right: 20px;
        font-size: 35px;
        font-weight: bold;
        cursor: pointer;
    }
    .modal-close:hover { color: black; }
    .framing-controls {
        margin-bottom: 15px; display: flex; gap: 20px; align-items: center; color: black;
    }
    .framing-controls select, .framing-controls button { font-size: 14px; padding: 5px; }

    /* Hide Aladin’s floating mouse-position readout to avoid redundancy */
    #aladin-lite-div .aladin-location,
    #aladin-lite-div .aladin-mouse-position {
      display: none !important;
    }

     /* Header bar at the top of the modal */
    .modal-header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 56px 6px 16px; /* right padding leaves space for the × button */
      border-bottom: 1px solid #83b4c5;
    }

    /* Nova brand style (matches your site typography) */
    .brand-strong {
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: 20px;
    }
    .brand-light {
      font-weight: 400;
      margin-left: 6px;
      color: #555;
      font-size: 20px;
    }

    /* Little pill on the right for the FOV text */
    .fov-chip {
      font-size: 13px;
      color: #444;
      background: #f3f5f7;
      border: 1px solid #e2e6ea;
      border-radius: 999px;
      padding: 4px 10px;
      white-space: nowrap;
    }

    /* Make sure the close button sits above and doesn’t overlap content */
    .modal .close {
      position: absolute;
      top: 10px;
      right: 12px;
      z-index: 3;         /* above header text */
      line-height: 1;
      font-size: 22px;
      color: #999;
    }
    .modal .close:hover { color: #666; }

    /* Overlay – fill screen, unchanged */
    #framing-modal {
      position: fixed;
      inset: 0;
      display: none;              /* set to block when open */
      background: rgba(0,0,0,0.6);
      z-index: 1000;
    }

    /* Modal content: fluid width/height with sane caps */
    #framing-modal-content {
      /* Center the box */
      position: relative;
      margin: 4vh auto 6vh auto;

      /* Width scales with screen: min 320px, ideal 70vw, max 1200px */
      width: clamp(320px, 70vw, 1200px);

      /* Height scales with screen: min 400px, ideal 78vh, max 900px */
      height: clamp(400px, 78vh, 900px);

      background: #fff;
      border-radius: 10px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.25);
      overflow: hidden;           /* keep internals tidy */

      /* Make internals layout nicely */
      display: flex;
      flex-direction: column;
    }

    /* Header / toolbar area at the top of the modal */
    #framing-header,
    #framing-toolbar {
      padding: 10px 16px;
    }

    /* Put your controls (rig select, rotation, survey, buttons) in a wrapping row */
    #framing-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 14px;
      align-items: center;
      border-top: 1px solid #e9eef2;
      border-bottom: 1px solid #e9eef2;
    }

    /* The main content area (holds the Aladin canvas) should grow and scroll as needed */
    #framing-body {
      flex: 1 1 auto;             /* <-- key: take all remaining height */
      min-height: 240px;          /* safety on tiny screens */
      display: flex;
      flex-direction: column;
      overflow: hidden;           /* canvas should not overflow the box */
      padding: 10px 16px 14px 16px;
    }

    /* Aladin container fills the body */
    #aladin-lite-div {
      flex: 1 1 auto;
      min-height: 200px;
      border-radius: 6px;
      overflow: hidden;
    }

    /* Chip / readout strip can wrap on small widths */
    .framing-readout {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      align-items: center;
      margin: 8px 0 10px;
    }

    /* Smaller screens: expand to near full-screen and tighten paddings */
    @media (max-width: 1280px) {
      #framing-modal-content {
        width: 96vw;
        height: 92vh;
        margin: 2vh auto;
      }
      #framing-toolbar, #framing-body {
        padding-left: 12px;
        padding-right: 12px;
      }
      /* Optional: reduce control spacing */
      #framing-toolbar { gap: 8px 10px; }
    }

    /* Very small screens: stack controls more aggressively */
    @media (max-width: 900px) {
      .framing-readout { gap: 6px 10px; }
      /* If you have long labels, make them inline and shorter */
      .inline-label { white-space: nowrap; font-size: 0.95rem; }
    }
    /* Fullscreen modifier */
    #framing-modal-content.fullscreen {
      width: 98vw !important;
      height: 96vh !important;
      margin: 2vh auto !important;
    }
    /* Header / toolbar area at the top of the modal */
    #framing-header,
    #framing-toolbar,
    .framing-controls {
      padding-left: 16px;
      padding-right: 16px;
    }
    /* Fullscreen mode */
    #framing-modal-content.fullscreen {
      width: 98vw !important;
      height: 96vh !important;
      margin: 2vh auto !important;
    }

    /* Fullscreen toggle button (⤢) */
    .fullscreen-btn {
      float: right;
      border: none;
      background: transparent;
      font-size: 1.3rem;
      cursor: pointer;
      margin-right: 10px;
    }
    .fullscreen-btn:hover {
      color: #0077aa;
    }
    .modal-controls {
      position: absolute;
      top: 8px;
      right: 12px;
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .fullscreen-btn {
      border: none;
      background: transparent;
      font-size: 1.2rem;
      cursor: pointer;
      line-height: 1;
      color: #444;
    }
    .fullscreen-btn:hover {
      color: #0077aa;
    }

    .close {
      font-size: 1.4rem;
      cursor: pointer;
      color: #666;
    }
    .close:hover {
      color: #d00;
    }
    /* Top-right controls bar */
    .modal-controls{
      position:absolute;
      top:8px;
      right:12px;
      z-index:2;
      display:flex;
      gap:10px;
      align-items:center;
      pointer-events:auto;
    }

    /* Ensure old .close rules don't fight us */
    .modal-controls .close,
    .modal-controls .close-btn{
      position:static !important;
      float:none !important;
    }

    /* Uniform icon buttons with real hit-area (no overlap) */
    .fullscreen-btn,
    .close-btn{
      width:28px;
      height:28px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:18px;          /* icon size */
      line-height:1;
      border:0;
      border-radius:6px;
      background:transparent;
      color:#444;
      cursor:pointer;
    }
    .fullscreen-btn:hover{ color:#0a7db8; }
    .close-btn:hover{ color:#d22; }

    /* If your FOV chip is also absolutely positioned near the right edge,
       keep it from colliding with the controls */
    .fov-chip{
      margin-right:48px; /* gives space for the two buttons */
    }
  </style>

{% endblock %}
</head>
<body>
{% block body %}

    <div class="top-info-grid"> {# Renamed for clarity, this will be our main flex row for the two columns #}

      {# ---- Column 1: Back to Tracker Button ---- #}
      <div class="info-button-column">
        <button class="inline-button" onclick="window.top.location.href='{{ url_for('index') }}'">Back to Tracker</button>
      </div>
      {# ---- END: Column 1 ---- #}

      {# ---- Column 2: Object Details and Secondary Info ---- #}
      <div class="info-details-column">
        {# Object Name/ID Display #}
        <div class="object-title-block-main">
            <span class="object-common-name">{{ alt_name | default(object_name, True) }}</span>
            <span class="object-id-name">({{ object_name }})</span>
        </div>

        {# Secondary Info Line: Location, Date, Moon, etc. #}
        <div class="secondary-info-line-main">
          <p><small>Location:</small> <span id="location-display">{{ header_location_name }}</span></p>
          <p><small>Date (Graph):</small> <span id="date-display">{{ header_date_display }}</span></p>
          <p><small>Moon (for date):</small> <span id="phase-display">{{ header_moon_phase }}%</span></p>
          <p><small>Astro Dusk:</small> <span id="dusk-display">{{ header_astro_dusk }}</span></p>
          <p><small>Astro Dawn:</small> <span id="dawn-display">{{ header_astro_dawn }}</span></p>
        </div>
      </div>
      {# ---- END: Column 2 ---- #}

    </div>
  <div id="chart-section">

    <div id="chart-loading" style="display:none; color: #6795a4; margin-bottom: 10px; margin-left: 10px;">Loading chart...</div>
    {# The initial src for chart-img will be set by refreshChart() on DOMContentLoaded #}
    <a id="chart-link" href="#" target="_blank">
      <img id="chart-img" src="#" alt="Altitude Graph for {{ alt_name }}" />
    </a>
    <div class="date-controls">
      <label for="day-select">Day:</label>
      <input type="number" id="day-select" value="{{ selected_day }}" min="1" max="31" style="width:60px;" />

      <label for="month-select">Month:</label>
      <select id="month-select">
        {% for m in range(1, 13) %}
          <option value="{{ m }}" {% if m == selected_month|int %}selected{% endif %}>{{ '%02d' % m }}</option>
        {% endfor %}
      </select>

      <label for="year-select">Year:</label>
      <input type="number" id="year-select" value="{{ selected_year }}" style="width:70px;" />

      <button class="view-button" data-view="day" onclick="changeView('day')">Day View</button>
      <button class="view-button" data-view="month" onclick="changeView('month')">Month View</button>
      <button class="view-button" data-view="year" onclick="changeView('year')">Year View</button>
    </div>
  </div>
  {# End of chart-section #}


  <div class="content-section journal-section-for-object">
    <h3>Imaging Journal for {{ alt_name | default(object_name, True) }}</h3>
    <div class="action-button-group">
        {% if is_guest %}
            <a href="#" onclick="alert('Please log in to add a journal session.'); return false;" class="inline-button">Add New Session</a>
        {% else %}
            <a href="{{ url_for('journal_add_for_target', object_name=object_name) }}" class="inline-button">Add New Session</a>
        {% endif %}
    </div>

    {% if object_specific_sessions %}
            <h4>Session History:</h4>
            <div class="table-wrapper" style="max-height: 280px; overflow-y: auto; margin-bottom:15px;"> {# Make it scrollable #}
                <table class="session-history-table">
                    <thead>
                        <tr>
                            <th class="col-date">Date</th>
                            <th class="col-location">Location</th>
                            <th class="col-setup">Telescope Setup</th>
                            <th class="col-integ">Integ. Time</th>
                            <th class="col-rating">Rating</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for session_item in object_specific_sessions %}
                            <tr class="clickable-session-row {{ 'current-session-item' if session_item.session_id == current_session_id else '' }}"
                                onclick="window.location.href='{{ url_for('graph_dashboard', object_name=object_name, day=selected_day, month=selected_month, year=selected_year, session_id=session_item.session_id) }}'">
                                <td class="col-date">{{ session_item.session_date |date_eu| default("N/A") }}</td>
                                <td class="col-location">{{ session_item.location_name | default("N/A") }}</td>
                                <td class="col-setup">{{ session_item.telescope_setup_notes | default("N/A") | truncate(50, True) }}</td>
                                <td class="col-integ">
                                    {% set integ_min = session_item.get('calculated_integration_time_minutes') %}
                                    {{ integ_min | round(0) if integ_min is number and integ_min != 'N/A' else 'N/A' }} min
                                </td>
                                <td class="col-rating">{{ session_item.session_rating_subjective | default('N/A') }}{% if session_item.session_rating_subjective and session_item.session_rating_subjective != 'N/A' and session_item.session_rating_subjective is not none %} ★{% endif %}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if selected_session_data %}
                <div class="selected-session-details"> {# Keep this outer wrapper #}
                    <h4>Details for Session: {{ selected_session_data.session_date | date_eu }}
                        {% if selected_session_data.session_id %}<small>(ID: {{ selected_session_data.session_id[:8] }}...)</small>{% endif %}
                    </h4>
                    <div class="action-button-group">
                        {% if is_guest %}
                            <a href="#" onclick="alert('Please log in to edit journal sessions.'); return false;" class="inline-button" style="background-color:#ffc107; color:black;">Edit This Session</a>
                        {% else %}
                            <a href="{{ url_for('journal_edit', session_id=selected_session_data.session_id) }}" class="inline-button" style="background-color:#ffc107; color:black;">Edit This Session</a>
                        {% endif %}
                        {% if is_guest %}
                            <button type="button" class="inline-button" style="background-color:#dc3545;" onclick="alert('Please log in to delete journal sessions.');">Delete This Session</button>
                        {% else %}
                            <form action="{{ url_for('journal_delete', session_id=selected_session_data.session_id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this journal entry? This action cannot be undone.');">
                                <button type="submit" class="inline-button" style="background-color:#dc3545;">Delete This Session</button>
                            </form>
                        {% endif %}
                    </div>

                    {# --- Mimicking journal_form.html structure --- #}
                    <div class="form-section-title" style="margin-top:20px;">Core Info</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Session Date:</label>
                            <p class="form-data-value">{{ selected_session_data.session_date | date_eu | default('N/A') }}</p>
                        </div>
                        <div class="form-group">
                            <label>Target Object:</label>
                            <p class="form-data-value">{{ selected_session_data.target_object_id | default('N/A') }}</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Location:</label>
                        <p class="form-data-value">{{ selected_session_data.location_name | default('N/A') }}</p>
                    </div>

                    <div class="form-section-title">Sky Conditions (Observed)</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Seeing (FWHM, arcsec):</label>
                            <p class="form-data-value">{{ selected_session_data.seeing_observed_fwhm | default('N/A') }}{% if selected_session_data.seeing_observed_fwhm and selected_session_data.seeing_observed_fwhm not in ['N/A', None] %}"{% endif %}</p>
                        </div>
                        <div class="form-group">
                            <label>Transparency Scale:</label>
                            <p class="form-data-value">{{ selected_session_data.transparency_observed_scale | default('N/A') }}</p>
                        </div>
                    </div>
                    <div class="form-row">
                         <div class="form-group">
                            <label>SQM Reading:</label>
                            <p class="form-data-value">{{ selected_session_data.sky_sqm_observed | default('N/A') }}</p>
                        </div>
                         <div class="form-group"> </div>
                    </div>
                    <div class="form-group">
                        <label>Weather Notes:</label>
                        <div class="form-data-value preserve-newlines">{{ selected_session_data.weather_notes | default('N/A') }}</div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Moon Illumination (Session):</label>
                            <p class="form-data-value">{{ selected_session_data.moon_illumination_session | default('N/A') }}{% if selected_session_data.moon_illumination_session not in ['N/A', None] %}%{% endif %}</p>
                        </div>
                        <div class="form-group">
                            <label>Moon Angular Separation (Session):</label>
                            <p class="form-data-value">{{ selected_session_data.moon_angular_separation_session | default('N/A') }}{% if selected_session_data.moon_angular_separation_session not in ['N/A', None] %}°{% endif %}</p>
                        </div>
                    </div>
                    <div class="form-section-title">Equipment & Guiding</div>
                     <div class="form-group">
                        <label>Telescope Setup Notes:</label>
                        <p class="form-data-value">{{ selected_session_data.telescope_setup_notes | default('N/A') }}</p>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Filter Used:</label>
                            <p class="form-data-value">{{ selected_session_data.filter_used_session | default('N/A') }}</p>
                        </div>
                        <div class="form-group">
                            <label>Guiding RMS (avg, arcsec):</label>
                            <p class="form-data-value">{{ selected_session_data.guiding_rms_avg_arcsec | default('N/A') }}{% if selected_session_data.guiding_rms_avg_arcsec and selected_session_data.guiding_rms_avg_arcsec not in ['N/A', None] %}"{% endif %}</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Guiding Equipment (Scope, Camera, Software):</label>
                        <p class="form-data-value">{{ selected_session_data.guiding_equipment | default('N/A') }}</p>
                    </div>
                    <div class="form-group">
                        <label>Dither Settings:</label>
                        <p class="form-data-value">{{ selected_session_data.dither_details | default('N/A') }}</p>
                    </div>
                    <div class="form-group">
                        <label>Acquisition Software:</label>
                        <p class="form-data-value">{{ selected_session_data.acquisition_software | default('N/A') }}</p>
                    </div>
                <div class="form-section-title">Acquisition Details</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Sub Exposure (seconds):</label>
                            <p class="form-data-value">{{ selected_session_data.exposure_time_per_sub_sec | default('N/A') }}s</p>
                        </div>
                        <div class="form-group">
                            <label>Number of Light Subs:</label>
                            <p class="form-data-value">{{ selected_session_data.number_of_subs_light | default('N/A') }}</p>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Gain:</label>
                            <p class="form-data-value">{{ selected_session_data.gain_setting | default('N/A') }}</p>
                        </div>
                        <div class="form-group">
                            <label>Offset:</label>
                            <p class="form-data-value">{{ selected_session_data.offset_setting | default('N/A') }}</p>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Binning:</label>
                            <p class="form-data-value">{{ selected_session_data.binning_session | default('N/A') }}</p>
                        </div>
                        <div class="form-group">
                             <label>Total Integration:</label>
                            <p class="form-data-value">
                                {% set integ_min_detail = selected_session_data.get('calculated_integration_time_minutes') %}
                                {{ integ_min_detail | round(0) if integ_min_detail is number and integ_min_detail != 'N/A' else 'N/A' }} min
                            </p>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Camera Temp Setpoint (°C):</label>
                            <p class="form-data-value">{{ selected_session_data.camera_temp_setpoint_c | default('N/A') }}°C</p>
                        </div>
                        <div class="form-group">
                            <label>Camera Temp Actual Avg (°C):</label>
                            <p class="form-data-value">{{ selected_session_data.camera_temp_actual_avg_c | default('N/A') }}°C</p>
                        </div>
                    </div>

                    <div class="form-section-title">Monochrome Filter Exposures</div>

                    {% set filters_display = [
                        ('L', 'Luminance'), ('R', 'Red'), ('G', 'Green'), ('B', 'Blue'),
                        ('Ha', 'H-alpha'), ('OIII', 'OIII'), ('SII', 'SII')
                    ] %}

                    {% for filt_key, filt_name in filters_display %}
                        {% set subs_val = selected_session_data.get('filter_' + filt_key + '_subs') %}
                        {% set exp_val = selected_session_data.get('filter_' + filt_key + '_exposure_sec') %}

                        {# Only display the row if there's data for either subs or exposure for that filter #}
                        {% if (subs_val is not none and subs_val|string|trim != '') or
                              (exp_val is not none and exp_val|string|trim != '') %}
                            {# The rest of the div.form-row and its content remains the same as before #}
                            <div class="form-row" style="margin-bottom: 8px;">
                                <div class="form-group" style="flex: 0 0 200px; display: flex; align-items: center;">
                                    <label style="margin-bottom: 0;">{{ filt_name }} ({{ filt_key }}) Filter:</label>
                                </div>
                                <div class="form-group">
                                    <label># Subs:</label>
                                    <p class="form-data-value">{{ subs_val | default('N/A') }}</p>
                                </div>
                                <div class="form-group">
                                    <label>Exp (sec/sub):</label>
                                    <p class="form-data-value">{{ exp_val | default('N/A') }}</p>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}

                    <div class="form-section-title">Calibration Strategy</div>
                    <div class="form-group">
                        <label>Darks:</label>
                        <p class="form-data-value">{{ selected_session_data.darks_strategy | default('N/A') }}</p>
                    </div>
                    <div class="form-group">
                        <label>Flats:</label>
                        <p class="form-data-value">{{ selected_session_data.flats_strategy | default('N/A') }}</p>
                    </div>
                    <div class="form-group">
                        <label>Bias / Dark Flats:</label>
                        <p class="form-data-value">{{ selected_session_data.bias_darkflats_strategy | default('N/A') }}</p>
                    </div>

                    <div class="form-section-title">Outcome & Reflections</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Session Rating (1-5 ★):</label>
                            <p class="form-data-value">{{ selected_session_data.session_rating_subjective | default('N/A') }}{% if selected_session_data.session_rating_subjective and selected_session_data.session_rating_subjective not in ['N/A', None] %} ★{% endif %}</p>
                        </div>

                    </div>

                    <div class="form-group">
                        <label>General Notes, Problems, Learnings:</label>
                        <div class="form-data-value preserve-newlines">{{ selected_session_data.general_notes_problems_learnings | default('N/A') }}</div>
                    </div>
                </div>
            {% elif object_specific_sessions %}
                <p style="margin-top:15px; color:#555;"><em>Select a session from the history above to view its full details.</em></p>
            {% endif %}
    {% else %}
        <p style="margin-top:15px; color:#777;">No journal entries found for {{ alt_name | default(object_name, True) }}.</p>
    {% endif %}
  </div>
  {# End of Journal Section #}

    {% if available_rigs and object_main_details.Size and object_main_details.Size != "N/A" %}
    <div class="content-section">
        <h3>Framing With Your Rigs</h3>
        <p style="font-size:13px; color: #666; margin-top: -8px;"><em>Assessment is based on the object's largest dimension and may not reflect framing of specific features.</em></p>
        <table class="framing-table">
            <thead>
                <tr>
                    <th>Rig Name</th>
                    <th>Rig FOV</th>
                    <th>Object Size</th>
                    <th>Fit Assessment</th>
                </tr>
            </thead>
            <tbody>
                {% set object_size = object_main_details.Size | float %}
                {% for rig in available_rigs %}
                    {% if rig.fov_w_arcmin and rig.fov_h_arcmin %}
                        {% set fov_max = [rig.fov_w_arcmin, rig.fov_h_arcmin] | max %}
                        {% set fov_min = [rig.fov_w_arcmin, rig.fov_h_arcmin] | min %}

                        {# --- NEW, MORE DETAILED LOGIC --- #}
                        {% if object_size > fov_max %}
                            {% set fit_text = "Mosaic Required" %}
                            {% set fit_color = "#e74c3c" %} {# Red #}

                        {% elif object_size > fov_min %}
                            {% set fit_text = "Fits with Rotation" %}
                            {% set fit_color = "#f39c12" %} {# Orange #}

                        {% else %}
                            {# The object fits easily, so now we assess how well #}
                            {% set fit_ratio = (object_size / fov_min) * 100 %}

                            {% if fit_ratio < 5 %}
                                {# NEW CATEGORY for very small objects #}
                                {% set fit_text = "Small Target" %}
                                {% set fit_color = "#9b59b6" %} {# Purple #}
                            {% elif fit_ratio < 20 %}
                                {% set fit_text = "Wide Field" %}
                                {% set fit_color = "#3498db" %} {# Blue #}
                            {% else %}
                                {% set fit_text = "Good Fit" %}
                                {% set fit_color = "#2ecc71" %} {# Green #}
                            {% endif %}
                        {% endif %}

                        <tr>
                            <td><strong>{{ rig.rig_name }}</strong></td>
                            <td>{{ rig.fov_w_arcmin | round(1) }}' x {{ rig.fov_h_arcmin | round(1) }}'</td>
                            <td>{{ object_size }}'</td>
                            <td style="color: {{ fit_color }}; font-weight: bold;">{{ fit_text }}</td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

  {# This was your 'button-container' div previously, now wrapped and styled #}
  <div class="content-section project-notes-section">
       <h3>Project Notes</h3>
       <textarea id="project-field" name="project_notes_from_config" title="General notes for this object from your main configuration. Editable on the Configuration page.">{{ project_notes_from_config }}</textarea>
       <div id="project-quick-link" style="margin:6px 0 12px; font-size:14px; color:#333;"></div>
       <div class="button-group"> {# Your existing group of buttons for this object #}
           <button class="inline-button" onclick="saveProject()">Save Project Notes</button> {# If you make project-field editable #}
           <button class="inline-button" onclick="openFramingAssistant()">Show Framing</button>
           <button class="inline-button" onclick="toggleSimbad()">Toggle SIMBAD Info</button>
           <button class="inline-button" onclick="loadImagingOpportunities()">Find Imaging Opportunities</button>
           <button id="open-in-stellarium" class="inline-button" onclick="openInStellarium()">Open in Stellarium</button>
       </div>
       <div id="stellarium-status" style="margin-top: 10px; color: #666;"></div>
  </div>
  {# End of Project Notes Section #}


  <div id="simbadContainer" style="display:none; margin-top:20px;">
    <iframe id="simbadIframe" style="width:100%; height:1200px; border:1px solid #ddd;"></iframe>
  </div>

  <div id="opportunities-section" style="display: none; max-width: 800px; margin-top: 30px;">
    <div class="opportunities-heading">Imaging Opportunities:<br><small>Note: The star rating does not differentiate whether the moon is above or below the horizon.</small></div>
    <table id="opportunities-table" class="opportunity-table center-text">
      <thead>
        <tr>
          <th>Date</th>
          <th>From</th> <th>To</th> <th>Obs Duration (min)</th>
          <th>Max Alt (°)</th>
          <th>Moon Illum (%)</th>
          <th>Ang Sep (°)</th>
          <th>Rating</th>
          <th>Add to Cal</th> </tr>
        </tr>
      </thead>
      <tbody id="opportunities-body">
        {# Populated by loadImagingOpportunities() #}
      </tbody>
    </table>
  </div>
    <div id="framing-modal" class="modal">
        <div id="framing-modal-content">
        <div class="modal-controls">
          <button type="button" class="fullscreen-btn" aria-label="Toggle fullscreen" title="Fullscreen" onclick="toggleFramingFullscreen(this)">⤢</button>
          <button type="button" class="close-btn" aria-label="Close" title="Close" onclick="closeFramingAssistant()">×</button>
        </div>

        <!-- Modal header (inside the white panel) -->
        <div class="modal-header-bar">
          <div class="brand">
            <span class="brand-strong">Nova</span>
            <span class="brand-light">DSO Tracker</span>
          </div>
          <span id="fov-vs-object" class="fov-chip"></span>
        </div>

          <!-- QoL utility bar -->
    <div class="framing-controls" style="align-items:center; gap:10px; padding-top:4px;">
      <label style="display:flex;align-items:center;gap:6px;">
        <input type="checkbox" id="lock-to-object" onchange="applyLockToObject(this.checked)">
        Lock FOV to object
      </label>

      <button class="inline-button" style="padding:6px 10px;font-size:13px;" onclick="flipFraming90()">Flip 90°</button>
      <button class="inline-button" style="padding:6px 10px;font-size:13px;" onclick="copyFramingUrl()">Copy framing URL</button>
      <button class="inline-button" style="padding:6px 10px;font-size:13px;" onclick="insertFramingIntoProject()">Insert into Project</button>
    </div>
    <div class="framing-controls">
      <div>
        <label for="framing-rig-select">Select Rig:</label>
        <select id="framing-rig-select" onchange="updateFramingChart(true); updateFovVsObjectLabel();">
          {% if available_rigs %}
            {% for rig in available_rigs %}
              <option value="{{ rig.rig_id }}"
                      data-fovw="{{ rig.fov_w_arcmin }}"
                      data-fovh="{{ rig.fov_h_arcmin }}">
                {{ rig.rig_name }}
              </option>
            {% endfor %}
          {% else %}
            <option value="">No rigs configured</option>
          {% endif %}
        </select>
      </div>

      <div>
        <label for="framing-rotation">Rotation:</label>
        <input type="range" id="framing-rotation" min="0" max="360" value="0" step="1"
               oninput="window.updateFramingChart(false)" onchange="window.updateFramingChart(false)">
        <span id="rotation-value">0°</span>
      </div>

      <div>
        <label for="survey-select">Survey:</label>
        <select id="survey-select" onchange="setSurvey(this.value)">
          <option value="P/DSS2/color">DSS2 (color)</option>
          <option value="P/allWISE/color">AllWISE (color)</option>
          <option value="P/2MASS/color">2MASS (color)</option>
          <option value="P/GALEXGR6/AIS/color">GALEX (color)</option>
          <option value="P/PanSTARRS/DR1/color-z-zg-g">Pan-STARRS (color)</option>
          <option value="CDS/P/SHASSA">SHASSA Hα</option>
          <option value="P/SDSS9/color">SDSS9 (color)</option>
        </select>
      </div>
    </div>

    <!-- Image tuning + RA/Dec utility bar -->
    <div class="framing-controls" style="flex-wrap: wrap;">
      <div>
        <label>Brightness</label>
        <input type="range" id="img-bright" min="-1" max="1" step="0.01" value="0" oninput="updateImageAdjustments()">
      </div>
      <div>
        <label>Contrast</label>
        <input type="range" id="img-contrast" min="-1" max="1" step="0.01" value="0" oninput="updateImageAdjustments()">
      </div>
      <div>
        <label>Gamma</label>
        <input type="range" id="img-gamma" min="0.1" max="10" step="0.1" value="1" oninput="updateImageAdjustments()">
      </div>
      <div>
        <label>Saturation</label>
        <input type="range" id="img-sat" min="-1" max="1" step="0.01" value="0" oninput="updateImageAdjustments()">
      </div>

      <div style="display:flex; align-items:center; gap:6px;">
        <label>RA</label>
        <input id="ra-readout" type="text" style="width:160px;" readonly>
        <label>Dec</label>
        <input id="dec-readout" type="text" style="width:160px;" readonly>
        <button class="inline-button" style="padding:6px 10px; font-size:13px;" onclick="copyRaDec()">Copy</button>
        <button class="inline-button" style="padding:6px 10px; font-size:13px;" onclick="useReadoutAsFovCenter()">Use current RA/Dec</button>
      </div>

      <div style="display:flex; align-items:center; gap:6px;">
        <span style="font-size:12px;color:#555;">Tip: Click on the sky to move the FOV center.</span>
        <button class="inline-button" style="padding:6px 10px; font-size:13px;" onclick="resetFovCenterToObject()">Recenter to object</button>
        <div style="display:flex; align-items:center; gap:4px;">
          <button class="inline-button" style="padding:4px 8px;" title="Nudge Up" onclick="nudgeFov(0, +1)">↑</button>
          <div>
            <button class="inline-button" style="padding:4px 8px;" title="Nudge Left" onclick="nudgeFov(-1, 0)">←</button>
            <button class="inline-button" style="padding:4px 8px;" title="Nudge Right" onclick="nudgeFov(+1, 0)">→</button>
          </div>
          <button class="inline-button" style="padding:4px 8px;" title="Nudge Down" onclick="nudgeFov(0, -1)">↓</button>
          <span style="font-size:12px;color:#555;">(1′ steps)</span>
        </div>
      </div>
    </div>
        <div id="aladin-lite-div"></div>
      </div>
    </div>


<script>
    const OBJECT_SIZE_ARCMIN = null;
    // --- Aladin Lite Variables ---
    let aladin = null;
    let fovLayer = null;

    // NEW: base image layer handle + FOV center
    let baseSurvey = null;
    let fovCenter = null; // { ra: number, dec: number }

    // --- QoL state ---
    let lockToObject = false;
    let objectCoords = null; // {ra, dec} resolved once per open

    // --- Aladin Lite Functions ---
    function openFramingAssistant() {
      const framingModal = document.getElementById('framing-modal');
      const framingRigSelect = document.getElementById('framing-rig-select');

      if (framingRigSelect.options.length === 0 || framingRigSelect.value === "") {
        alert("Please configure at least one rig on the Configuration page first.");
        return;
      }

      // Show the modal
      framingModal.style.display = 'block';

      // Initialize Aladin once
      if (!aladin) {
        aladin = A.aladin('#aladin-lite-div', {
          survey: "P/DSS2/color",
          fov: 1.5,
          cooFrame: 'ICRS',
          showFullscreenControl: false,
          showGotoControl: false
        });

        baseSurvey = aladin.getBaseImageLayer();

        // Overlay for the FOV polygon
        fovLayer = A.graphicOverlay({ color: '#83b4c5', lineWidth: 3 });
        aladin.addOverlay(fovLayer);

        const canvas = document.getElementById('aladin-lite-div');
          // --- Watch for canvas size changes so FOV frame always stays visible ---
        if (window.ResizeObserver && canvas) {
          let roTimer = null;
          const ro = new ResizeObserver(() => {
            clearTimeout(roTimer);
            roTimer = setTimeout(() => {
              const sel = document.getElementById('framing-rig-select');
              if (sel && sel.selectedIndex >= 0) {
                const opt = sel.options[sel.selectedIndex];
                applyRigFovZoom(opt.dataset.fovw, opt.dataset.fovh);
              }
              updateFramingChart(false);
            }, 80);
          });
          ro.observe(canvas);
        }
        // Click → set FOV center to cursor
        canvas.addEventListener('click', (ev) => {
          if (lockToObject) return;
          const rect = canvas.getBoundingClientRect();
          const x = ev.clientX - rect.left;
          const y = ev.clientY - rect.top;
          const sky = aladin.pix2world(x, y);
          if (!sky) return;
          fovCenter = { ra: sky[0], dec: sky[1] };
          updateFramingChart(false);
          updateReadoutFromCenter();
        });

        // Keyboard nudges (1′)
        window.addEventListener('keydown', (e) => {
          const k = e.key.toLowerCase();
          if (['arrowup','arrowdown','arrowleft','arrowright','w','a','s','d'].includes(k)) {
            e.preventDefault();
            if (k === 'arrowup' || k === 'w') nudgeFov(0, +1);
            if (k === 'arrowdown' || k === 's') nudgeFov(0, -1);
            if (k === 'arrowleft' || k === 'a') nudgeFov(-1, 0);
            if (k === 'arrowright' || k === 'd') nudgeFov(+1, 0);
          }
        });
      }

      // -------- Restore from URL (rig/center/rotation/survey) --------
      let haveCenter = false;
      let haveRot = false;
      let haveRigRestored = false;

      try {
        const q   = new URLSearchParams(location.search);
        const rig = q.get('rig');
        const ra  = parseFloat(q.get('ra'));
        const dec = parseFloat(q.get('dec'));
        const rot = parseFloat(q.get('rot'));
        const surv= q.get('survey');

        // Rig
        if (rig) {
          const sel = document.getElementById('framing-rig-select');
          if (sel) {
            const idx = Array.from(sel.options).findIndex(o => o.value === rig);
            if (idx >= 0) { sel.selectedIndex = idx; haveRigRestored = true; }
          }
        }

        // Rotation
        if (!Number.isNaN(rot)) {
          const rotInput = document.getElementById('framing-rotation');
          if (rotInput) rotInput.value = rot;
          const rotSpan = document.getElementById('rotation-value');
          if (rotSpan) rotSpan.textContent = `${Math.round(rot)}°`;
          haveRot = true;
        }

        // Survey
        if (surv) {
          if (typeof setSurvey === 'function') setSurvey(surv);
          else {
            const s = document.getElementById('survey-select');
            if (s) s.value = surv;
          }
        }

        // Saved frame center
        if (!Number.isNaN(ra) && !Number.isNaN(dec)) {
          fovCenter = { ra, dec };       // IMPORTANT: assign the real variable, not window.*
          haveCenter = true;
        } else {
          fovCenter = null;
        }
      } catch (e) {
        // ignore; keep current defaults
      }

      // Defaults if not provided
      if (!haveRot) {
        const rotInput = document.getElementById('framing-rotation');
        if (rotInput) rotInput.value = 0;
        const rotSpan = document.getElementById('rotation-value');
        if (rotSpan) rotSpan.textContent = `0°`;
      }
      if (!haveRigRestored) {
        // Do NOT force index 0 if a rig is already selected; leave as-is
      }

      // If there is a saved center: unlock and center Aladin there BEFORE first draw
      if (haveCenter) {
        const lockBox = document.getElementById('lock-to-object');
        if (lockBox) lockBox.checked = false;
        lockToObject = false;
        if (aladin && typeof aladin.gotoRaDec === 'function') {
          aladin.gotoRaDec(fovCenter.ra, fovCenter.dec);
        }
        if (haveCenter) {
          const sel = document.getElementById('framing-rig-select');
          if (sel && sel.selectedIndex >= 0) {
            const opt = sel.options[sel.selectedIndex];
            applyRigFovZoom(opt.dataset.fovw, opt.dataset.fovh);
          }
        }
      }

      // First draw: if haveCenter, don't recenter to object
      updateFramingChart(haveCenter ? false : true);
      updateFovVsObjectLabel?.();
      updateReadoutFromCenter?.();
    }

    function closeFramingAssistant() {
        const framingModal = document.getElementById('framing-modal');
        framingModal.style.display = 'none';
    }
    function flipFraming90() {
      const slider = document.getElementById('framing-rotation');
      let v = parseFloat(slider.value) || 0;
      v = (v + 90) % 360;
      slider.value = v;
      document.getElementById('rotation-value').textContent = `${Math.round(v)}°`;
      updateFramingChart(false);
      updateReadoutFromCenter();
    }

    // Always zoom so the current rig's FOV just fits in view.
    // fovW_arcmin and fovH_arcmin are arcminutes.
    function applyRigFovZoom(fovW_arcmin, fovH_arcmin, rotationDeg = 0, margin = 1.06) {
      if (!aladin) return;
      const host = document.getElementById('aladin-lite-div');
      if (!host) return;

      const wpx = host.clientWidth, hpx = host.clientHeight;
      if (!(wpx > 0 && hpx > 0)) return;
      const aspect = wpx / hpx;               // width / height in pixels

      const wDeg = parseFloat(fovW_arcmin) / 60;
      const hDeg = parseFloat(fovH_arcmin) / 60;
      if (!(isFinite(wDeg) && isFinite(hDeg) && wDeg > 0 && hDeg > 0)) return;

      // Account for rotation: bounding box of a rotated rectangle
      const th = (parseFloat(rotationDeg) || 0) * Math.PI / 180;
      const needWidthDeg  = Math.abs(wDeg * Math.cos(th)) + Math.abs(hDeg * Math.sin(th));
      const needHeightDeg = Math.abs(wDeg * Math.sin(th)) + Math.abs(hDeg * Math.cos(th));

      // setFov() controls the *width* in degrees. Ensure BOTH axes fit:
      const requiredWidthDeg = Math.max(needWidthDeg * margin, needHeightDeg * margin * aspect);
      aladin.setFov(requiredWidthDeg);
    }
    window.updateFramingChart = function(recenter = true) {
      if (!aladin) return;

      const objectName = "{{ object_name }}";
      const framingRigSelect = document.getElementById('framing-rig-select');
      const rotationSlider = document.getElementById('framing-rotation');
      const rotationValueSpan = document.getElementById('rotation-value');
      const selectedOption = framingRigSelect.options[framingRigSelect.selectedIndex];
      if (!selectedOption) return;

      const fovWidthArcmin  = parseFloat(selectedOption.dataset.fovw);
      const fovHeightArcmin = parseFloat(selectedOption.dataset.fovh);

      const _rot = parseFloat(rotationSlider.value);
      const rotation = Number.isFinite(_rot) ? _rot : 0;
      if (rotationValueSpan) rotationValueSpan.textContent = `${Math.round(rotation)}°`;

      // ✅ Always zoom based on the CURRENT rig and rotation
      applyRigFovZoom(fovWidthArcmin, fovHeightArcmin, rotation);

      if (recenter) {
        aladin.gotoObject(objectName, {
          success: () => {
            // ✅ Zoom again after gotoObject so frame fits perfectly
            applyRigFovZoom(fovWidthArcmin, fovHeightArcmin, rotation);

            const rc = aladin.getRaDec();
            objectCoords = { ra: rc[0], dec: rc[1] };
            fovCenter = lockToObject ? { ...objectCoords } : { ra: rc[0], dec: rc[1] };
            drawFovFootprint(fovWidthArcmin, fovHeightArcmin, rotation, fovCenter);
            updateReadoutFromCenter?.();
          },
          error: () => {
            const rc = aladin.getRaDec();
            fovCenter = { ra: rc[0], dec: rc[1] };
            drawFovFootprint(fovWidthArcmin, fovHeightArcmin, rotation, fovCenter);
            updateReadoutFromCenter?.();
          }
        });
        return;
      }

      // No recenter: reuse existing center
      if (!fovCenter) {
        const rc = aladin.getRaDec();
        fovCenter = { ra: rc[0], dec: rc[1] };
      }
      drawFovFootprint(fovWidthArcmin, fovHeightArcmin, rotation, fovCenter);
    };

    function drawFovFootprint(fovWidthArcmin, fovHeightArcmin, rotationDeg, center) {
      if (!aladin || !fovLayer || !center) return;

      fovLayer.removeAll();

      // Half-sizes in DEGREES
      const halfW = (fovWidthArcmin  / 60) / 2;
      const halfH = (fovHeightArcmin / 60) / 2;

      // Rotation in radians
      const ang = rotationDeg * Math.PI / 180;

      // Center (radians)
      const ra0  = center.ra  * Math.PI / 180;
      const dec0 = center.dec * Math.PI / 180;

      // Unit vector at center
      const cX = Math.cos(dec0) * Math.cos(ra0);
      const cY = Math.cos(dec0) * Math.sin(ra0);
      const cZ = Math.sin(dec0);

      // Local basis at center: East & North unit vectors
      // East: d/dRA at fixed Dec -> (-sinRA, cosRA, 0)
      const eX = -Math.sin(ra0), eY = Math.cos(ra0), eZ = 0;
      // North: d/dDec at fixed RA -> (-sinDec*cosRA, -sinDec*sinRA, cosDec)
      const nX = -Math.sin(dec0)*Math.cos(ra0);
      const nY = -Math.sin(dec0)*Math.sin(ra0);
      const nZ =  Math.cos(dec0);

      // Rotate a point (x,y) in the local tangent plane by 'ang'
      function rot2d(x, y) {
        return [ x*Math.cos(ang) - y*Math.sin(ang),
                 x*Math.sin(ang) + y*Math.cos(ang) ];
      }

      // Corners before spherical mapping (deg in the local plane)
      const raw = [
        [-halfW, -halfH],
        [ halfW, -halfH],
        [ halfW,  halfH],
        [-halfW,  halfH],
      ].map(([x,y]) => rot2d(x,y));

      // Map each (x_deg, y_deg) to the sphere and return [ra_deg, dec_deg]
      function planeToSky(x_deg, y_deg) {
        const dx = x_deg * Math.PI/180;  // angular distance east (radians)
        const dy = y_deg * Math.PI/180;  // angular distance north (radians)
        const r  = Math.hypot(dx, dy);

        if (r < 1e-12) {
          // exactly the center
          return [center.ra, center.dec];
        }

        // Direction unit vector in 3D: (dx * East + dy * North) / r
        const dirX = (dx*eX + dy*nX) / r;
        const dirY = (dx*eY + dy*nY) / r;
        const dirZ = (dx*eZ + dy*nZ) / r;

        // Great-circle step: new = center*cos(r) + dir*sin(r)
        const s = Math.sin(r), c = Math.cos(r);
        const pX = c*cX + s*dirX;
        const pY = c*cY + s*dirY;
        const pZ = c*cZ + s*dirZ;

        // Back to RA/Dec
        let ra  = Math.atan2(pY, pX);
        if (ra < 0) ra += 2*Math.PI;
        const dec = Math.asin(pZ);
        return [ ra*180/Math.PI, dec*180/Math.PI ];
      }

      // Build polygon
      const polyCoords = raw.map(([x,y]) => planeToSky(x, y));
      polyCoords.push(polyCoords[0]); // close

      // Draw (teal, thicker line)
      const fovPolygon   = A.polygon(polyCoords, { color: '#83b4c5', lineWidth: 3 });
      const fovFootprint = A.footprint(fovPolygon);
      fovLayer.add(fovFootprint);

      updateReadoutFromCenter?.();
    }

    function setSurvey(hipsId) {
      if (!aladin) return;
      const newLayer = aladin.newImageSurvey(hipsId);
      aladin.setBaseImageLayer(newLayer);
      baseSurvey = aladin.getBaseImageLayer();
      // reapply current image adjustments to the new layer
      updateImageAdjustments();
    }
    function updateImageAdjustments() {
      if (!baseSurvey) return;
      const b = parseFloat(document.getElementById('img-bright').value);
      const c = parseFloat(document.getElementById('img-contrast').value);
      const g = parseFloat(document.getElementById('img-gamma').value);
      const s = parseFloat(document.getElementById('img-sat').value);

      // API: setBrightness(-1..1), setContrast(-1..1), setGamma(0.1..10), setSaturation(-1..1)
      baseSurvey.setBrightness(b);
      baseSurvey.setContrast(c);
      baseSurvey.setGamma(g);
      baseSurvey.setSaturation(s);
    }
    function updateReadout(raDeg, decDeg) {
      document.getElementById('ra-readout').value  = formatRA(raDeg);
      document.getElementById('dec-readout').value = formatDec(decDeg);
    }

    function updateReadoutFromCenter() {
      // If center not set yet, fall back to current view center
      const c = fovCenter || (() => {
        const rc = aladin.getRaDec();
        return { ra: rc[0], dec: rc[1] };
      })();
      updateReadout(c.ra, c.dec);
    }

    function copyRaDec() {
      const text = `${document.getElementById('ra-readout').value} ${document.getElementById('dec-readout').value}`;
      navigator.clipboard.writeText(text).then(()=> {
        // optional toast
      });
    }

    function useReadoutAsFovCenter() {
      const raStr  = document.getElementById('ra-readout').value;
      const decStr = document.getElementById('dec-readout').value;
      const sky = parseRaDec(raStr, decStr);
      if (!sky) return;
      fovCenter = { ra: sky.ra, dec: sky.dec };
      updateFramingChart(false);
      updateReadoutFromCenter();
    }

    function resetFovCenterToObject() {
      fovCenter = null; // will fall back to view center after gotoObject
      updateFramingChart(true);
      updateFovVsObjectLabel();
    }

    // 1 arcmin nudges; dx positive → RA+, dy positive → Dec+
    function nudgeFov(dxArcmin, dyArcmin) {
      if (lockToObject && objectCoords) {
        fovCenter = { ra: objectCoords.ra, dec: objectCoords.dec };
        updateFramingChart(false);
        updateReadoutFromCenter();
        return;
      }
      if (!fovCenter) {
        const rc = aladin.getRaDec();
        fovCenter = { ra: rc[0], dec: rc[1] };
      }
      fovCenter.ra  += dxArcmin / 60.0;
      fovCenter.dec += dyArcmin / 60.0;
      updateFramingChart(false);
      updateReadoutFromCenter();
    }
    function applyLockToObject(locked) {
      lockToObject = !!locked;

      // When enabling, snap overlay center to the object immediately
      if (lockToObject) {
        // Prefer precise object coords if we have them; else view center is fine right after goto
        const c = objectCoords || (() => {
          const rc = aladin.getRaDec(); return { ra: rc[0], dec: rc[1] };
        })();
        fovCenter = { ra: c.ra, dec: c.dec };
        updateFramingChart(false);
        updateReadoutFromCenter();
      }
    }
    function updateFovVsObjectLabel() {
      const el = document.getElementById('fov-vs-object');
      if (!el) return;

      const sel = document.getElementById('framing-rig-select');
      if (!sel || sel.selectedIndex < 0) { el.textContent = ''; return; }

      const opt = sel.options[sel.selectedIndex];
      const fovW = parseFloat(opt.dataset.fovw); // arcmin
      const fovH = parseFloat(opt.dataset.fovh); // arcmin
      if (!isFinite(fovW) || !isFinite(fovH)) { el.textContent = ''; return; }

      let text = `FOV (Rig): ${Math.round(fovW)}′ × ${Math.round(fovH)}′`;

      if (typeof OBJECT_SIZE_ARCMIN === 'number' && isFinite(OBJECT_SIZE_ARCMIN) && OBJECT_SIZE_ARCMIN > 0) {
        const minSide = Math.min(fovW, fovH);
        const fitAcross = minSide / OBJECT_SIZE_ARCMIN;
        // e.g., "Object ~ 20′ → fits ~3.1× across the short side"
        text += ` • Object ~ ${Math.round(OBJECT_SIZE_ARCMIN)}′ → ${fitAcross >= 1 ? 'fits' : 'spans'} ${fitAcross.toFixed(1)}× ${fitAcross >= 1 ? 'across' : 'of'} short side`;
      }

      el.textContent = text;
    }
    // If user tries to move center while locked, ignore and re-snap.

    // Optionally, keep the VIEW panned onto the object whenever user drags while locked.
    // Simple heuristic: on mouseup, jump back to object.
    (function recenterViewWhenLocked(){
      const canvas = document.getElementById('aladin-lite-div');
      if (!canvas) return;
      canvas.addEventListener('mouseup', () => {
        if (lockToObject && objectCoords) {
          aladin.gotoObject([objectCoords.ra, objectCoords.dec]);
        }
      });
    })();
    // Formatting helpers
    function pad(n, w=2){return n.toString().padStart(w,'0');}
    function formatRA(raDeg){
      const totalSec = raDeg/15*3600;
      const h = Math.floor(totalSec/3600);
      const m = Math.floor((totalSec%3600)/60);
      const s = (totalSec%60).toFixed(2);
      return `${pad(h)}:${pad(m)}:${pad(s,5)}`;
    }
    function formatDec(decDeg){
      const sign = decDeg>=0 ? '+' : '-';
      const abs = Math.abs(decDeg);
      const d = Math.floor(abs);
      const m = Math.floor((abs-d)*60);
      const s = ((abs-d)*60 - m)*60;
      return `${sign}${pad(d)}:${pad(m)}:${s.toFixed(1).padStart(4,'0')}`;
    }
    function parseRaDec(raHMS, decDMS){
      try{
        const [h,m,s]=raHMS.split(':').map(parseFloat);
        const ra = (h + m/60 + s/3600) * 15.0;
        const sign = decDMS.trim()[0]==='-' ? -1 : 1;
        const [d,dm,ds]=decDMS.replace('+','').replace('-','').split(':').map(parseFloat);
        const dec = sign*(d + dm/60 + ds/3600);
        return {ra,dec};
      }catch(e){ return null; }
    }

    // --- Your Original Page Functions ---

    function formatDateISOtoEuropean(iso_str) {
        if (!iso_str || typeof iso_str !== 'string') return 'N/A';
        const parts = iso_str.split("-");
        if (parts.length !== 3) {
            console.warn("formatDateISOtoEuropean received unexpected format:", iso_str);
            return iso_str;
        }
        const [year, month, day] = parts;
        return `${day}.${month}.${year}`;
    }

    function setLocation() {
        const selectedLocation = document.getElementById('location-select').value;
        fetch('/set_location', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ location: selectedLocation })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                refreshChart();
            } else {
                console.error("Location update failed:", data);
            }
        })
        .catch(error => console.error('Error setting location:', error));
    }

    function refreshChart() {
        changeView('day');
    }

    function changeView(view) {
        const objectName = "{{ object_name }}";
        const day = document.getElementById('day-select').value;
        const month = document.getElementById('month-select').value;
        const year = document.getElementById('year-select').value;
        const timestamp = Date.now();
        let baseUrl = "";

        if (view === "day") {
            baseUrl = `/plot_day/${encodeURIComponent(objectName)}?day=${day}&month=${month}&year=${year}`;
        } else if (view === "month") {
            baseUrl = `/plot_monthly_altitude/${encodeURIComponent(objectName)}?year=${year}&month=${month}`;
        } else if (view === "year") {
            baseUrl = `/plot_yearly_altitude/${encodeURIComponent(objectName)}?year=${year}`;
        } else {
            return;
        }

        let locationQueryParams = "";
        const plotLat = "{{ graph_lat_param | default('', True) }}";
        const plotLon = "{{ graph_lon_param | default('', True) }}";
        const plotTz = "{{ graph_tz_name_param | default('', True) }}";
        const plotLocName = "{{ graph_location_name_param | default('', True) }}";

        if (plotLat) locationQueryParams += `&plot_lat=${encodeURIComponent(plotLat)}`;
        if (plotLon) locationQueryParams += `&plot_lon=${encodeURIComponent(plotLon)}`;
        if (plotTz) locationQueryParams += `&plot_tz=${encodeURIComponent(plotTz)}`;
        if (plotLocName) locationQueryParams += `&plot_loc_name=${encodeURIComponent(plotLocName)}`;

        const finalUrl = baseUrl + locationQueryParams + `&t=${timestamp}`;
        document.getElementById('chart-loading').style.display = 'block';
        document.getElementById('chart-img').style.opacity = '0.3';
        document.getElementById('chart-img').src = finalUrl;
        document.getElementById('chart-link').href = finalUrl;

        fetch(`/get_date_info/${encodeURIComponent(objectName)}?day=${day}&month=${month}&year=${year}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById("date-display").innerText = formatDateISOtoEuropean(data.date);
                document.getElementById("phase-display").innerText = data.phase + "%";
                document.getElementById("dusk-display").innerText = data.astronomical_dusk;
                document.getElementById("dawn-display").innerText = data.astronomical_dawn;
            })
            .catch(error => console.error("Error updating header info:", error));
    }

    function saveProject() {
        const newProject = document.getElementById('project-field').value;
        const objectName = "{{ object_name }}";
        fetch('/update_project', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ object: objectName, project: newProject })
        }).then(res => res.json()).then(data => {
            alert(data.status === "success" ? "Project updated successfully!" : data.error);
        });
    }

    function toggleSimbad() {
        var container = document.getElementById('simbadContainer');
        const objectName = "{{ object_name }}";
        if (container.style.display === 'none' || container.style.display === '') {
            document.getElementById('simbadIframe').src = "https://simbad.u-strasbg.fr/simbad/sim-id?Ident=" + encodeURIComponent(objectName);
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
    }

    function loadImagingOpportunities() {
        const objectName = "{{ object_name }}";
        document.getElementById("opportunities-section").style.display = "block";
        const tbody = document.getElementById("opportunities-body");
        tbody.innerHTML = `<tr><td colspan="9">Searching...</td></tr>`;

        fetch(`/get_imaging_opportunities/${encodeURIComponent(objectName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    if (data.results.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="9">No good dates found.</td></tr>`;
                        return;
                    }
                    let htmlRows = "";
                    const selectedDateStr = `${document.getElementById('year-select').value.padStart(4, '0')}-${document.getElementById('month-select').value.padStart(2, '0')}-${document.getElementById('day-select').value.padStart(2, '0')}`;
                    const plotLat = "{{ graph_lat_param }}";
                    const plotLon = "{{ graph_lon_param }}";
                    const plotTz = "{{ graph_tz_name_param }}";

                    data.results.forEach(r => {
                        const isSelected = r.date === selectedDateStr;
                        const formattedDate = formatDateISOtoEuropean(r.date);
                        const ics_url = `/generate_ics/${encodeURIComponent(objectName)}?date=${r.date}&tz=${encodeURIComponent(plotTz)}&lat=${plotLat}&lon=${plotLon}&max_alt=${r.max_alt}&moon_illum=${r.moon_illumination}&obs_dur=${r.obs_minutes}&from_time=${r.from_time}&to_time=${r.to_time}`;
                        const filename = `imaging_${objectName.replace(/\s+/g, '_')}_${r.date}.ics`;
                        htmlRows += `<tr class="${isSelected ? 'highlight' : ''}" data-date="${r.date}" onclick="selectSuggestedDate('${r.date}')" style="cursor: pointer;">
                            <td>${formattedDate}</td><td>${r.from_time}</td><td>${r.to_time}</td><td>${r.obs_minutes}</td>
                            <td>${r.max_alt}</td><td>${r.moon_illumination}</td><td>${r.moon_separation}</td>
                            <td>${r.rating || ""}</td><td onclick="event.stopPropagation();"><a href="${ics_url}" download="${filename}" title="Add to calendar" style="font-size: 1.5em; text-decoration: none;">🗓️</a></td></tr>`;
                    });
                    tbody.innerHTML = htmlRows;
                } else {
                    tbody.innerHTML = `<tr><td colspan="9">Error: ${data.message}</td></tr>`;
                }
            });
    }

    function selectSuggestedDate(dateStr) {
        const [year, month, day] = dateStr.split('-').map(Number);
        document.getElementById('year-select').value = year;
        document.getElementById('month-select').value = month;
        document.getElementById('day-select').value = day;
        changeView('day');
        const rows = document.getElementById("opportunities-body").querySelectorAll("tr");
        rows.forEach(row => {
            row.classList.toggle("highlight", row.getAttribute("data-date") === dateStr);
        });
    }

    function openInStellarium() {
        document.getElementById('stellarium-status').textContent = "Sending object to Stellarium...";
        const objectName = "{{ object_name }}";
        fetch("/proxy_focus", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ target: objectName, mode: "center" })
        })
        .then(async response => {
            let data = await response.json().catch(() => ({ message: "Invalid response from server." }));
            if (response.ok && data.status === "success") {
                document.getElementById('stellarium-status').textContent = "Stellarium view updated!";
                document.getElementById('stellarium-status').style.color = "#83b4c5";
            } else {
                document.getElementById('stellarium-status').innerHTML = `<p style="color:red;">Error:<br>${data.message || "Unknown error"}</p>`;
            }
        });
    }

    // --- Initial setup on page load ---
    document.getElementById('chart-img').onload = function() {
        document.getElementById('chart-loading').style.display = 'none';
        document.getElementById('chart-img').style.opacity = '1';
    };
    refreshChart();
    const dateEl = document.getElementById("date-display");
    if (dateEl && dateEl.innerText.includes("-")) {
        dateEl.innerText = formatDateISOtoEuropean(dateEl.innerText);
    }
    const dayInput = document.getElementById("day-select");
    const monthSelect = document.getElementById("month-select");
    const yearInput = document.getElementById("year-select");
    function updateDayLimit() {
        const year = parseInt(yearInput.value);
        const month = parseInt(monthSelect.value);
        const daysInMonth = new Date(year, month, 0).getDate();
        if (parseInt(dayInput.value) > daysInMonth) {
            dayInput.value = daysInMonth;
        }
        dayInput.max = daysInMonth;
    }
    monthSelect.addEventListener("change", updateDayLimit);
    yearInput.addEventListener("change", updateDayLimit);
    updateDayLimit();

    // Event listener for closing modal by clicking outside
    const framingModal = document.getElementById('framing-modal');
    window.addEventListener('click', function(event) {
        if (event.target == framingModal) {
            closeFramingAssistant();
        }
    });
    function copyFramingUrl() {
      if (!aladin) return;
      const framingRigSelect = document.getElementById('framing-rig-select');
      const rotation = parseFloat(document.getElementById('framing-rotation').value) || 0;

    // Center in decimal degrees (prefer the readout → then explicit fovCenter → then view center)
    const center = (() => {
      const raStr  = document.getElementById('ra-readout')?.value;
      const decStr = document.getElementById('dec-readout')?.value;
      const fromReadout = (raStr && decStr && typeof parseRaDec === 'function') ? parseRaDec(raStr, decStr) : null;
      if (fromReadout) return { ra: fromReadout.ra, dec: fromReadout.dec };
      if (fovCenter && isFinite(fovCenter.ra) && isFinite(fovCenter.dec)) return { ra: fovCenter.ra, dec: fovCenter.dec };
      const rc = aladin.getRaDec();
      return { ra: rc[0], dec: rc[1] };
    })();

      // Survey ID (HiPS name). Try to pull from the select; fall back to current base layer.
      const surveySel = document.getElementById('survey-select');
      const surveyId = surveySel ? surveySel.value : (aladin.getBaseImageLayer()?.hips?.id || '');

      const params = new URLSearchParams({
        rig: framingRigSelect.value || '',
        ra:  center.ra.toFixed(6),
        dec: center.dec.toFixed(6),
        rot: (rotation % 360).toFixed(1),
        survey: surveyId
      });

      const url = `${location.origin}${location.pathname}?${params.toString()}`;
      navigator.clipboard.writeText(url);
    }
      // Auto-open the Framing Assistant when a URL contains rig + (ra or dec)
      window.addEventListener('load', () => {
        const q = new URLSearchParams(location.search);
        if (q.has('rig') && (q.has('ra') || q.has('dec'))) {
          // Slight defer so the modal is visible before Aladin builds
          setTimeout(() => openFramingAssistant(), 0);
        }
      });

    function insertFramingIntoProject() {
      if (!aladin) return;

      // Gather framing
      const rigSel   = document.getElementById('framing-rig-select');
      const rigId    = rigSel?.value || '';
      const rigName  = rigSel?.options[rigSel.selectedIndex]?.text || rigId || 'unknown rig';

      const rot      = parseFloat(document.getElementById('framing-rotation')?.value || '0') || 0;
      const survey   = document.getElementById('survey-select')?.selectedOptions?.[0]?.text
                     || document.getElementById('survey-select')?.value || '';

      // Ensure the readout reflects the latest center before reading it
      updateReadoutFromCenter?.();

      // ---- NEW center derivation ----
      let center = null;

      const raStr  = document.getElementById('ra-readout')?.value;
      const decStr = document.getElementById('dec-readout')?.value;
      if (raStr && decStr && typeof parseRaDec === 'function') {
        const parsed = parseRaDec(raStr, decStr); // { ra, dec } in degrees
        if (parsed && Number.isFinite(parsed.ra) && Number.isFinite(parsed.dec)) {
          center = parsed;
        }
      }

      if (!center && fovCenter) {
        center = { ra: fovCenter.ra, dec: fovCenter.dec };
      }
      if (!center) {
        const rc = aladin.getRaDec();
        center = { ra: rc[0], dec: rc[1] };
      }
      // ---- /NEW ----

      const raHms  = (typeof formatRA === 'function')  ? formatRA(center.ra)  : center.ra.toFixed(6);
      const decDms = (typeof formatDec === 'function') ? formatDec(center.dec) : center.dec.toFixed(6);

      const opt     = rigSel?.options[rigSel.selectedIndex];
      const fovW    = opt ? parseFloat(opt.dataset.fovw) : NaN;
      const fovH    = opt ? parseFloat(opt.dataset.fovh) : NaN;
      const fovTxt  = (isFinite(fovW) && isFinite(fovH)) ? `${Math.round(fovW)}′×${Math.round(fovH)}′` : '';

      // Build a shareable URL
      let url = '';
      try {
        const params = new URLSearchParams({
          rig: rigId,
          ra: center.ra.toFixed(6),
          dec: center.dec.toFixed(6),
          rot: (rot % 360).toFixed(1),
          survey: document.getElementById('survey-select')?.value || ''
        });
        url = `${location.origin}${location.pathname}?${params.toString()}`;
      } catch (e) {}

      const ts = new Date().toLocaleString();
      const entry =
    `[Framing | ${ts}]
    Rig: ${rigName}${fovTxt ? ` (${fovTxt})` : ''}
    Center: RA ${raHms}  Dec ${decDms}  (deg: ${center.ra.toFixed(6)}, ${center.dec.toFixed(6)})
    Rotation: ${Math.round(rot)}°
    Survey: ${survey}
    ${url ? `URL: ${url}\n` : ''}`;

      const projectField = document.getElementById('project-field');

      if (projectField) {
        const sep = projectField.value && !projectField.value.endsWith('\n') ? '\n\n' : '';
        projectField.value = (projectField.value || '') + sep + entry + '\n';
        projectField.focus();
        if (projectField.setSelectionRange) {
          const len = projectField.value.length;
          projectField.setSelectionRange(len, len);
        }
        if (url) setProjectQuickLink(url);
      } else {
        navigator.clipboard.writeText(entry);
        alert('No “Project” field found on this page.\n\nThe framing entry has been copied to your clipboard. Paste it where you want to keep it.');
      }
    }

    function escapeHtml(s){return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

    function setProjectQuickLink(url) {
      const box = document.getElementById('project-quick-link');
      if (!box) return;
      if (!url) { box.innerHTML = ''; return; }

      // Create the button and bind a proper click handler (no inline onclick)
      const jsArg = String(url);               // keep original string
      box.innerHTML = `<button id="open-framing-from-notes" class="inline-button">Open framing</button>`;
      const btn = document.getElementById('open-framing-from-notes');
      btn.addEventListener('click', () => {
        try {
          // Prefer the URL-restoring flow; fall back to just opening the modal
          if (typeof window.openFramingAssistantFromUrl === 'function') {
            window.openFramingAssistantFromUrl(jsArg);
          } else {
            openFramingAssistant();
          }
        } catch (e) {
          console.error('Quick-link click failed:', e);
          openFramingAssistant(); // at least open the modal
        }
      });
    }
    window.openFramingAssistantFromUrl = function(url) {
      try {
        // De-HTMLify just in case
        const clean = String(url || '').replace(/&amp;/g, '&');

        // Parse relative OR absolute URL safely
        const q = new URL(clean, location.href).searchParams;

        // Merge params into current URL (no reload)
        const newParams = new URLSearchParams(location.search);
        ['rig','ra','dec','rot','survey'].forEach(k => {
          if (q.has(k)) newParams.set(k, q.get(k));
        });
        history.replaceState(null, '', location.pathname + '?' + newParams.toString());

        // Open the modal — your existing restore-on-open code will apply everything
        openFramingAssistant();
      } catch (e) {
        console.error('openFramingAssistantFromUrl failed:', e);
        alert('Sorry—opening the saved framing failed. Check the console for details.');
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      const ta = document.getElementById('project-field');
      if (!ta) return;
      // Try to find the last URL in the existing notes and show it as a quick link
      const m = ta.value.match(/\bhttps?:\/\/[^\s<>"']+/g);
      if (m && m.length) setProjectQuickLink(m[m.length - 1]);
    });
    function safeOpenFramingFromUrl(url) {
      try {
        if (typeof window.openFramingAssistantFromUrl === 'function') {
          window.openFramingAssistantFromUrl(url);
        } else {
          console.warn('openFramingAssistantFromUrl missing; falling back');
          openFramingAssistant();
        }
      } catch (e) {
        console.error('safeOpenFramingFromUrl error:', e);
        openFramingAssistant(); // still open the modal even if URL parsing failed
      }
    }
    function toggleFramingFullscreen() {
      const box = document.getElementById('framing-modal-content');
      box.classList.toggle('fullscreen');
      // resize Aladin after toggling fullscreen
      setTimeout(() => {
        if (aladin && document.getElementById('aladin-lite-div')) {
          updateFramingChart(false);
        }
      }, 100);
    }
    function toggleFramingFullscreen(btn){
      const box=document.getElementById('framing-modal-content');
      box.classList.toggle('fullscreen');
      btn.textContent = box.classList.contains('fullscreen') ? '↙' : '⤢';
      setTimeout(()=>{ if (aladin) updateFramingChart(false); },50);
    }
    window.addEventListener('resize', () => {
      if (document.getElementById('framing-modal').style.display === 'block') {
        if (aladin) updateFramingChart(false);
      }
    });
    // Ensure the current Aladin zoom is large enough to display the entire rig FOV (+margin)
    function ensureFovFitsRig(margin = 1.35) {
      if (!aladin) return;
      const sel = document.getElementById('framing-rig-select');
      if (!sel || sel.selectedIndex < 0) return;

      const opt = sel.options[sel.selectedIndex];
      const wArcmin = parseFloat(opt.dataset.fovw);
      const hArcmin = parseFloat(opt.dataset.fovh);
      if (!isFinite(wArcmin) || !isFinite(hArcmin)) return;

      // Required horizontal FOV in degrees (largest dimension) + a small margin
      const need = (Math.max(wArcmin, hArcmin) / 60) * margin;

      // Current horizontal FOV from Aladin
      let curr = null;
      try {
        const gf = aladin.getFov && aladin.getFov();     // often returns [fovX, fovY]
        curr = Array.isArray(gf) ? Math.max(gf[0], gf[1]) : gf;
      } catch (e) {}

      // Only zoom out if needed; don't interfere with a user who zoomed out further
      if (!curr || curr < need * 0.98) {
        aladin.setFov(need);
      }
    }
</script>

{% endblock %}
</body>
</html>