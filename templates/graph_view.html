{% extends "base.html" %}
{% from "macros.html" import status_item, form_group, help_badge, action_button, tab_button %}

{% block title %}{{ alt_name | default(object_name, True) }} ({{ object_name }}) – Nova DSO Tracker{% endblock %}

{% block head_extra %}
<script>
    const IS_GUEST_USER = {{ is_guest | tojson }};
</script>
<script src="{{ url_for('static', filename='js/aladin.js') }}" charset="utf-8" defer></script>
<script>
    // Safely convert the Python object to a JavaScript object
    window.selectedSessionData = {{ selected_session_data_dict | tojson }};

    // Helper function required by the Inspiration Modal to navigate to charts
    window.showGraph = function(objectName) {
        const currentLoc = (window.NOVA_GRAPH_DATA && window.NOVA_GRAPH_DATA.plotLocName) || '';
        let url = `/graph_dashboard/${encodeURIComponent(objectName)}?tab=chart`;
        if (currentLoc) url += `&location=${encodeURIComponent(currentLoc)}`;
        window.location.href = url;
    };
</script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/graph_view.css') }}">
{% endblock %}

{% block page_title %}
    <h2 id="graph-title">
        {{ alt_name | default(object_name, True) }}
        <span class="subtitle" id="graph-title-subtitle">
            <span id="primary-id">({{ object_name }})</span>
            <span id="secondary-separator" class="title-separator" style="display:none;"> &amp;</span>
            <span id="secondary-name" style="display:none;"></span>
            <span id="secondary-id" style="display:none;">()</span>
        </span>
    </h2>
{% endblock %}

{% block header_actions %}
    {{ action_button('← Back to Dashboard', data_attrs='style="background-color: var(--primary-color);" data-action="navigate" data-url="' ~ url_for('core.index') ~ '"') }}
{% endblock %}

{% block header_content %}
<div class="status-strip">
    {{ status_item('Location', header_location_name, value_id='location-display') }}
    {{ status_item('Graph Date', header_date_display, value_id='date-display') }}
    {{ status_item('Moon', header_moon_phase ~ '%', value_id='phase-display') }}
    {{ status_item('Moon Sep.', header_moon_separation ~ '°', value_id='separation-display') }}
    <div class="status-item">
        <span class="status-label">ASTR. DUSK / DAWN</span>
        <span class="status-value"><span id="dusk-display">{{ header_astro_dusk }}</span> - <span id="dawn-display">{{ header_astro_dawn }}</span></span>
    </div>
</div>
{% endblock %}

{% block body %}
<div id="flash-message-container" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; max-width: 500px; text-align: center;">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-message" style="padding: 12px 20px; border-radius: 6px; color: white; font-weight: bold; background-color: {{ 'var(--danger-color)' if category == 'error' else 'var(--success-color-alt)' }}; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
</div>

<script>
    // Self-hiding flash messages
    document.addEventListener('DOMContentLoaded', function() {
        const flashMessages = document.querySelectorAll('.flash-message');
        if (flashMessages.length > 0) {
            setTimeout(() => {
                flashMessages.forEach(el => {
                    el.style.transition = 'opacity 0.5s ease';
                    el.style.opacity = '0';
                    setTimeout(() => el.remove(), 500); // Remove from DOM after fade
                });
            }, 4000); // Message disappears after 4 seconds
        }
    });
</script>
<div class="tab-container">
    <button class="tab-button" data-tab="chart" data-action="show-tab">Chart</button>
    <button class="tab-button" data-tab="framing" data-action="show-tab">Notes & Framing</button>
    <button class="tab-button" data-tab="opportunities" data-action="show-tab">Opportunities</button>
    <button class="tab-button" data-tab="journal" data-action="show-tab">Journal</button>
    <button class="tab-button" data-tab="simbad" data-action="show-tab">SIMBAD</button>
</div>

<div id="chart-tab" class="tab-content">
    <div id="chart-section">
        <div style="width: 100%; max-width: 1300px; margin-left: 0;">
            <div id="chart-area">
                <canvas id="altitudeChartCanvas"></canvas>
                <div id="chart-loading" class="loading-overlay">
                    <div style="text-align: center;">
                        <img src="{{ url_for('static', filename='nova_logo.png') }}" alt="Nova Logo" class="loading-logo"
                             style="width: 70px; height: auto; margin-bottom: 12px; display: block; margin-left: auto; margin-right: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">

                        <div style="color: var(--primary-color); font-weight: 800; letter-spacing: 1.5px; text-transform: uppercase; font-size: 13px;">
                            Loading Chart
                        </div>
                    </div>
                </div>
            </div>
            <div class="date-controls" style="margin-top: 20px; padding-left: 20px; box-sizing: border-box;">
                <label for="day-select">Day:</label>
                <input type="number" id="day-select" value="{{ selected_day }}" min="1" max="31" style="width:60px;"/>
                <label for="month-select">Month:</label>
                <select id="month-select">
                    {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if m== selected_month|int %}selected{% endif %}>{{ '%02d' % m }}</option>
                    {% endfor %}
                </select>
                <label for="year-select">Year:</label>
                <input type="number" id="year-select" value="{{ selected_year }}" style="width:70px;"/>
                <button class="view-button" data-view="day" data-action="change-view">Day View</button>
                <button class="view-button" data-view="month" data-action="change-view">Month View</button>
                <button class="view-button" data-view="year" data-action="change-view">Year View</button>
                <span id="secondary-object-controls" style="margin-left: 24px; padding-left: 24px; border-left: 1px solid var(--border-medium-alt, var(--border-medium-alt, #ccc)); display: inline-flex; align-items: center; gap: 8px;">
                    <label for="secondary-object-select">Add Object:</label>
                    <select id="secondary-object-select" disabled style="min-width: 180px; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        <option value="">Loading...</option>
                    </select>
                    <span class="help-badge" data-help-topic="secondary_object_comparison" title="How objects are ranked">?</span>
                </span>
            </div>
        </div>
    </div>
</div>

<div id="journal-tab" class="tab-content">
    {% include '_journal_section.html' %}
</div>

<div id="framing-tab" class="tab-content">

    <div class="detail-tabs-container">
        {{ tab_button('Notes & Framing', 'notes', active=True, data_action='show-project-subtab') }}
        {{ tab_button('Inspiration', 'inspiration', data_action='show-project-subtab') }}
        {{ tab_button('Rig Data', 'framing-scout', data_action='show-project-subtab') }}
    </div>

    <div id="notes-sub-tab" class="detail-tab-content active">
        <div class="content-section project-notes-section">
            <h3>{{ alt_name | default(object_name, True) }} - Notes</h3>

            <input type="hidden" id="project-field-hidden" name="project_notes_from_config" value="{{ project_notes_from_config | default('', True) | e }}">
            <trix-editor input="project-field-hidden" id="project-field-editor"
                         style="min-height: 150px; height: auto;"></trix-editor>

            <div id="project-quick-link" style="margin:6px 0 12px; font-size:14px; color:var(--text-primary);"></div>

            <div style="margin-top: 15px; margin-bottom: 5px;">
                <label style="font-weight: bold; display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 15px; color: var(--text-primary);">
                    <input type="checkbox" id="active-project-checkbox" style="transform: scale(1.3);"
                           {% if object_main_details.ActiveProject %}checked{% endif %}>
                    Active Project
                </label>
            </div>
            <div class="button-group" style="margin-top: 15px;">
                <button class="inline-button" data-action="save-project">Save Notes</button>
                <button class="inline-button" data-action="open-framing-assistant">Show Framing</button>
                <button id="open-in-stellarium" class="inline-button" data-action="open-stellarium" style="display: none;">Open in Stellarium</button>
            </div>
            <div id="stellarium-status" style="margin-top: 10px; color: var(--text-tertiary);"></div>
        </div>
    </div>

    <div id="inspiration-sub-tab" class="detail-tab-content">
        <div class="content-section">
            <h3 style="display:flex; justify-content:space-between; align-items:center;">
                Inspiration Content
                {% if not object_main_details.image_url and not object_main_details.description_text %}
                <a href="{{ url_for('core.config_form') }}?active_tab=objects" style="font-size:13px; font-weight:normal;">Edit Object to Add Content</a>
                {% endif %}
            </h3>

            {% if object_main_details.image_url or object_main_details.description_text %}
            <div class="insp-detail-container">
                {% if object_main_details.image_url %}
                <div class="insp-detail-image-wrapper">
                    <img src="{{ object_main_details.image_url }}" alt="Inspiration Image for {{ object_name }}">
                    {% if object_main_details.image_credit %}
                        <div class="insp-detail-badge">{{ object_main_details.image_credit }}</div>
                    {% endif %}
                </div>
                {% endif %}

                {% if object_main_details.description_text %}
                <div class="insp-detail-text">
                    <h4 style="margin-top:0; color:var(--text-primary);">Description</h4>
                    <p style="white-space: pre-wrap;">{{ object_main_details.description_text }}</p>
                    {% if object_main_details.image_source_link %}
                        <p style="margin-top:15px; font-size:0.9em; color:var(--text-tertiary);">
                            Source: <a href="{{ object_main_details.image_source_link }}" target="_blank">{{ object_main_details.image_credit or 'External Source' }}</a>
                        </p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% else %}
            <div style="text-align:center; padding:40px; color:var(--text-tertiary); border: 2px dashed var(--text-lighter); border-radius: 6px;">
                <p>No inspiration content (custom image or description) has been added for this object yet.</p>
                <p style="font-size: 0.9em;">Go to <strong>Configuration > Manage Objects</strong> to add one.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <div id="framing-scout-sub-tab" class="detail-tab-content">
        {% if available_rigs and object_main_details.Size and object_main_details.Size != "N/A" %}
        <div class="content-section">
            <h3>Framing With Your Rigs</h3>
            <p style="font-size:13px; color: var(--text-tertiary); margin-top: -8px;"><em>Assessment is based on the object's largest dimension and may not reflect framing of specific features.</em></p>
            <table class="framing-table">
                <thead>
                <tr>
                    <th>Rig Name</th>
                    <th>Rig FOV</th>
                    <th>Object Size</th>
                    <th>Fit Assessment</th>
                </tr>
                </thead>
                <tbody>
                {% set object_size = object_main_details.Size | float %}
                {% for rig in available_rigs %}
                {% if rig.fov_w_arcmin and rig.fov_h_arcmin %}
                {% set fov_max = [rig.fov_w_arcmin, rig.fov_h_arcmin] | max %}
                {% set fov_min = [rig.fov_w_arcmin, rig.fov_h_arcmin] | min %}
                {% if object_size > fov_max %}{% set fit_text = "Mosaic Required" %}{% set fit_color = "var(--danger-color)" %}
                {% elif object_size > fov_min %}{% set fit_text = "Fits with Rotation" %}{% set fit_color = "var(--warning-color-alt)" %}
                {% else %}{% set fit_ratio = (object_size / fov_min) * 100 %}
                {% if fit_ratio < 5 %}{% set fit_text = "Small Target" %}{% set fit_color = "var(--text-muted)" %}
                {% elif fit_ratio < 20 %}{% set fit_text = "Wide Field" %}{% set fit_color = "var(--info-color-alt)" %}
                {% else %}{% set fit_text = "Good Fit" %}{% set fit_color = "var(--success-color-alt)" %}{% endif %}{% endif %}
                <tr>
                    <td><strong>{{ rig.rig_name }}</strong></td>
                    <td>{{ rig.fov_w_arcmin | round(1) }}' x {{ rig.fov_h_arcmin | round(1) }}'</td>
                    <td>{{ object_size }}'</td>
                    <td style="color: {{ fit_color }}; font-weight: bold;">{{ fit_text }}</td>
                </tr>
                {% endif %}{% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>

<div id="opportunities-tab" class="tab-content">
    {% include '_opportunities_section.html' %}
</div>

{% include '_inspiration_section.html' %}

<div id="simbad-tab" class="tab-content">
    <div id="simbadContainer">
        <iframe id="simbadIframe" style="width:100%; height:1200px; border:1px solid var(--text-lighter);"></iframe>
    </div>
</div>


<div id="framing-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="framing-modal-title">
    <div id="framing-modal-content">
        <div class="modal-controls">
            <button type="button" class="close-btn" aria-label="Close" title="Close" data-action="close-framing-assistant">×</button>
            <h2 id="framing-modal-title" class="sr-only">Framing Assistant</h2>
        </div>
        <div class="modal-header-bar">
            <div class="brand">
                <span class="brand-strong">Nova</span><span class="brand-light">DSO Tracker</span>
                {{ help_badge('framing_assistant', 'Help with Framing') }}
            </div>
            <span id="fov-vs-object" class="fov-chip"></span>
        </div>
        <div class="framing-controls" style="align-items:center; gap:10px; padding-top:4px;">
            <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="lock-to-object" data-action="toggle-lock-fov" checked> Lock FOV</label>
            <label style="display:flex;align-items:center;gap:6px;margin-left:8px;" title="Displays the approximate location of geostationary satellites (corrected for your latitude)"><input type="checkbox" id="show-geo-belt" data-action="toggle-geo-belt" checked> Geo Belt</label>
            <button class="inline-button" style="padding:6px 10px;font-size:13px;" data-action="flip-framing">Flip 90°</button>
            <button class="inline-button" style="padding:6px 10px;font-size:13px;" data-action="copy-framing-url">Copy framing URL</button>
            <button id="save-framing-db" type="button" class="inline-button" style="padding:6px 10px;font-size:13px;" data-action="save-framing-db">Save Framing</button>

            <div style="display:flex; align-items:center; gap:6px; margin-left:12px; padding-left:12px; border-left:1px solid var(--border-medium-alt);">
                <label for="framing-rig-select" style="font-weight:bold;">Rig:</label>
                <select id="framing-rig-select" data-action="update-framing-rig" style="max-width:240px; font-size:14px;">
                    {% if available_rigs %}{% for rig in available_rigs %}
                    <option value="{{ rig.rig_id }}" data-fovw="{{ rig.fov_w_arcmin }}" data-fovh="{{ rig.fov_h_arcmin }}">{{ rig.rig_name }}</option>
                    {% endfor %}{% else %}<option value="">No rigs configured</option>{% endif %}
                </select>
            </div>

            <div style="display:flex; align-items:center; gap:8px; margin-left:12px; padding-left:12px; border-left:1px solid var(--border-medium-alt); flex-grow: 1;">
              <label for="framing-rotation" style="font-weight:bold;" title="Position Angle (0°=North, 90°=East)">Rotation (PA):</label>
              <input type="range" id="framing-rotation" min="0" max="360" value="0" step="0.5" data-action="rotation-input" style="flex-grow: 1; height: 6px; cursor: pointer;"/>
              <span id="rotation-value" style="min-width: 45px; font-weight: bold; color: var(--text-primary); text-align: right;">0°</span>
            </div>
        </div>
        <div class="framing-controls">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="display:flex; flex-direction:column; gap:3px;">
                    <label style="font-size:13px; color:var(--text-dark-alt); font-weight:bold; line-height:1;">Mosaic (Col x Row)</label>
                    <div style="display:flex; align-items:center; gap:4px;">
                        <input type="number" id="mosaic-cols" min="1" max="6" value="1" style="width:45px; padding:4px; font-size:14px; font-weight:bold;" data-action="update-mosaic" title="Columns">
                        <span style="font-size:14px; font-weight:bold;">x</span>
                        <input type="number" id="mosaic-rows" min="1" max="6" value="1" style="width:45px; padding:4px; font-size:14px; font-weight:bold;" data-action="update-mosaic" title="Rows">
                    </div>
                </div>
                <div style="display:flex; flex-direction:column; gap:3px;">
                    <label style="font-size:13px; color:var(--text-dark-alt); font-weight:bold; line-height:1;">Overlap %</label>
                    <input type="number" id="mosaic-overlap" min="0" max="80" value="10" step="5" style="width:60px; padding:4px; font-size:14px;" data-action="update-mosaic">
                </div>
                <button class="inline-button" style="padding:8px 12px; font-size:13px; margin-left:8px;" data-action="copy-mosaic-csv" title="Generates a CSV format compatible with ASIAIR (Plan Import), N.I.N.A., and Telescopius.">Copy Plan (CSV)</button>
            </div>
            <div>
                <label for="survey-select">Survey:</label>
                <select id="survey-select" data-action="change-survey">
                    <option value="P/DSS2/color">DSS2 (color)</option>
                    <option value="P/DESI-Legacy-Surveys/DR10/color">Legacy Survey DR10 (Deep/Sharp)</option>
                    <option value="P/DES/DR2/Color">Dark Energy Survey DR2 (Deep)</option>
                    <option value="P/allWISE/color">AllWISE (color)</option>
                    <option value="P/2MASS/color">2MASS (color)</option>

                    <option value="https://www.simg.de/nebulae3/dr0_2/ohs8">NSNS DR0.2 (OHS)</option>
                    <option value="https://www.simg.de/nebulae3/dr0_2/hbr8">NSNS DR0.2 (HBR)</option>
                    <option value="https://www.simg.de/nebulae3/dr0_2/halpha8">NSNS DR0.2 (H-alpha)</option>
                    <option value="https://www.simg.de/nebulae3/dr0_2/oiii8">NSNS DR0.2 ([OIII])</option>
                    <option value="https://www.simg.de/nebulae3/dr0_2/sii8">NSNS DR0.2 ([SII])</option>
                    <option value="https://www.simg.de/nebulae3/dr0_2/rgb8">NSNS DR0.2 (True Color)</option>

                    <option value="P/GALEXGR6/AIS/color">GALEX (color)</option>
                    <option value="P/PanSTARRS/DR1/color-z-zg-g">Pan-STARRS (color)</option>
                    <option value="CDS/P/SHASSA">SHASSA Hα</option>
                    <option value="P/SDSS9/color">SDSS9 (color)</option>
                </select>
                <span style="margin-left:18px;">Blend with:</span>
                <select id="blend-survey-select" style="margin-left:6px;">
                    <option value="P/DSS2/color" selected>DSS2 (color)</option>
                    <option value="P/DSS2/red">DSS2 (red)</option>
                    <option value="P/DSS2/blue">DSS2 (blue)</option>

                    <option value="https://www.simg.de/nebulae3/dr0_2/ohs8">NSNS DR0.2 (OHS)</option>
                    <option value="https://www.simg.de/nebulae3/dr0_2/hbr8">NSNS DR0.2 (HBR)</option>
                    <option value="https://www.simg.de/nebulae3/dr0_2/halpha8">NSNS DR0.2 (H-alpha)</option>
                    <option value="https://www.simg.de/nebulae3/dr0_2/oiii8">NSNS DR0.2 ([OIII])</option>
                    <option value="https://www.simg.de/nebulae3/dr0_2/sii8">NSNS DR0.2 ([SII])</option>
                    <option value="https://www.simg.de/nebulae3/dr0_2/rgb8">NSNS DR0.2 (True Color)</option>

                    <option value="P/2MASS/color">2MASS (color)</option>
                    <option value="P/allWISE/color">WISE (color)</option>
                    <option value="P/SDSS9/color">SDSS (color)</option>
                    <option value="P/GALEXGR6/AIS/color">GALEX (color)</option>
                </select>
                <input id="blend-opacity" type="range" min="0" max="1" step="0.01" value="0" title="Blend opacity" style="width:130px; vertical-align:middle; margin-left:8px;">
            </div>
        </div>
        <div class="framing-controls" style="flex-wrap: wrap;">
            <div><label>Brightness</label><input type="range" id="img-bright" min="-1" max="1" step="0.01" value="0" data-action="update-image-adjustments"></div>
            <div><label>Contrast</label><input type="range" id="img-contrast" min="-1" max="1" step="0.01" value="0" data-action="update-image-adjustments"></div>
            <div><label>Gamma</label><input type="range" id="img-gamma" min="0.1" max="10" step="0.1" value="1" data-action="update-image-adjustments"></div>
            <div><label>Saturation</label><input type="range" id="img-sat" min="-1" max="1" step="0.01" value="0" data-action="update-image-adjustments"></div>
            <div style="display:flex; align-items:center; gap:6px;">
                <span style="font-size:11px; font-weight:bold; color:var(--text-secondary); background:var(--bg-light-gray); padding:2px 6px; border-radius:4px; border:1px solid var(--border-light-alt2); cursor:help;" title="Coordinates are JNow (Real Time / Mean Equinox of Date) to match your mount.">JNow</span>
                <label style="font-size:14px; font-weight:bold;">RA</label>
                <input id="ra-readout" type="text" style="width:160px; font-size:14px; font-family:monospace; font-weight:bold;" readonly>
                <label style="font-size:14px; font-weight:bold;">Dec</label>
                <input id="dec-readout" type="text" style="width:160px; font-size:14px; font-family:monospace; font-weight:bold;" readonly>
                <button class="inline-button" style="padding:6px 10px; font-size:13px;" data-action="copy-ra-dec">Copy</button>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
                <span style="font-size:12px;color:var(--text-secondary);">Tip: Click on the sky to move the FOV center.</span>
                <button class="inline-button" style="padding:6px 10px; font-size:13px;" data-action="recenter-fov">Recenter to object</button>
                <div style="display:flex; align-items:center; gap:4px;">
                    <button class="inline-button" style="padding:4px 8px;" title="Nudge Up" data-action="nudge-fov" data-dx="0" data-dy="1">↑</button>
                    <div>
                        <button class="inline-button" style="padding:4px 8px;" title="Nudge Left" data-action="nudge-fov" data-dx="-1" data-dy="0">←</button>
                        <button class="inline-button" style="padding:4px 8px;" title="Nudge Right" data-action="nudge-fov" data-dx="1" data-dy="0">→</button>
                    </div>
                    <button class="inline-button" style="padding:4px 8px;" title="Nudge Down" data-action="nudge-fov" data-dx="0" data-dy="-1">↓</button>
                    <span style="font-size:12px;color:var(--text-secondary);">(1′ steps)</span>
                </div>
            </div>
        </div>
        <div id="aladin-lite-div"></div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/chart/chart.umd.min.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/chart/luxon.min.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/chart/chartjs-adapter-luxon.umd.min.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/chart/chartjs-plugin-annotation.min.js') }}" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
<script>
    // Data object to pass server-side variables to the external script
    window.NOVA_GRAPH_DATA = {
    // CORRECTED LINES: Use 'tojson' filter and remove surrounding quotes
    plotLat: {{ graph_lat_param | default(0, True) | tojson }},
    objectName: {{ object_name | tojson }},
        altName: {{ alt_name | default(object_name, True) | tojson }},
        plotLat: "{{ graph_lat_param | default('', True) }}",
        plotLon: "{{ graph_lon_param | default('', True) }}",
        plotTz: "{{ graph_tz_name_param | default('UTC', true) }}",
        plotLocName: {{ header_location_name | tojson }},

        // We pass RA in DEGREES (RA_Hours * 15) and DEC in DEGREES
        // 'null' is passed if the database has no value.
        objectRADeg: {{ (object_main_details['RA (hours)'] * 15) if object_main_details['RA (hours)'] is not none else 'null' }},
        objectDECDeg: {{ object_main_details['DEC (degrees)'] if object_main_details['DEC (degrees)'] is not none else 'null' }},
        allObjects: {{ framing_objects | tojson }}
    };
</script>
<script>
    // Data object to pass server-side variables to the external script
    window.NOVA_GRAPH_DATA = {
        // CORRECTED LINES: Use 'tojson' filter and remove surrounding quotes
        objectName: {{ object_name | tojson }},
        altName: {{ alt_name | default(object_name, True) | tojson }},
        plotLat: "{{ graph_lat_param | default('', True) }}",
        plotLon: "{{ graph_lon_param | default('', True) }}",
        plotTz: "{{ graph_tz_name_param | default('UTC', true) }}",
        plotLocName: {{ header_location_name | tojson }},

        // We pass RA in DEGREES (RA_Hours * 15) and DEC in DEGREES
        // 'null' is passed if the database has no value.
        objectRADeg: {{ (object_main_details['RA (hours)'] * 15) if object_main_details['RA (hours)'] is not none else 'null' }},
        objectDECDeg: {{ object_main_details['DEC (degrees)'] if object_main_details['DEC (degrees)'] is not none else 'null' }},
        allObjects: {{ framing_objects | tojson }}
    };
</script>
<script src="{{ url_for('static', filename='js/framing-utils.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/graph_view_chart.js') }}?v=dark_theme_v3" defer></script>
<script src="{{ url_for('static', filename='js/graph_view.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/journal_section.js') }}" defer></script>

{% endblock %}