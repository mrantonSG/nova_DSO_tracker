{% from "macros.html" import form_group, help_badge %}
<div id="objects-tab-content" class="tab-content">

<link rel="stylesheet" href="{{ url_for('static', filename='css/objects_section.css') }}">

    <div class="config-section" style="padding-top: 1em;">
        <div class="detail-tabs-container">
            <button class="detail-tab-button active" data-tab="manage">
                Manage My Objects
                {{ help_badge('objects_manage', extra_attrs='onclick="openHelp(\'objects_manage\'); event.stopPropagation();"') }}
            </button>
            <button class="detail-tab-button" data-tab="add">
                Add New Object
                {{ help_badge('objects_add', extra_attrs='onclick="openHelp(\'objects_add\'); event.stopPropagation();"') }}
            </button>
            <button class="detail-tab-button" data-tab="import">
                Import from Catalog
                {{ help_badge('objects_import', extra_attrs='onclick="openHelp(\'objects_import\'); event.stopPropagation();"') }}
            </button>
            <button class="detail-tab-button" onclick="openDuplicateChecker()">
                Find Duplicates
                {{ help_badge('objects_duplicates', extra_attrs='onclick="openHelp(\'objects_duplicates\'); event.stopPropagation();"') }}
            </button>
        </div>

        <div id="manage-object-subtab" class="detail-tab-content active">
            <div class="block" id="object-filter-bar">
        <div class="inline-fields">
          <div>
            <label class="short-label" for="object-filter-id">Filter ID:</label>
            <input type="text" id="object-filter-id" onkeyup="filterObjectsList()" placeholder="e.g., M42">
          </div>
          <div>
            <label class="short-label" for="object-filter-name">Name:</label>
            <input type="text" id="object-filter-name" onkeyup="filterObjectsList()" placeholder="e.g., Orion">
          </div>
          <div>
            <label class="short-label" for="object-filter-con">Con:</label>
            <input type="text" id="object-filter-con" onkeyup="filterObjectsList()" placeholder="e.g., Cyg">
          </div>
          <div>
            <label class="short-label" for="object-filter-type">Type:</label>
            <input type="text" id="object-filter-type" onkeyup="filterObjectsList()" placeholder="e.g., PN">
          </div>
          <div>
            <label class="short-label" for="object-filter-shared">Status:</label>
            <select id="object-filter-shared" onchange="filterObjectsList()">
              <option value="all">All Statuses</option>
              <option value="enabled">Enabled Only</option>
              <option value="disabled">Disabled Only</option>
              <option disabled>──────────</option>
              <option value="private">Private</option>
              <option value="shared">Shared by Me</option>
              <option value="imported">Imported</option>
            </select>
          </div>
          <div>
            <label class="short-label" for="object-filter-source">Source:</label>
            <input type="text" id="object-filter-source" onkeyup="filterObjectsList()" placeholder="e.g., messier (use = for exact)">
          </div>

          <div style="flex: 0 0 485px;">
            <label class="short-label" for="object-filter-notes">Notes:</label>
            <input type="text" id="object-filter-notes" onkeyup="filterObjectsList()" placeholder="Search notes (use * for all)..." style="width: 100%;">
          </div>

          <div>
            <label class="short-label" for="object-filter-mag">Mag &lt;:</label>
            <input type="number" id="object-filter-mag" onkeyup="filterObjectsList()" placeholder="15" style="width: 60px;">
          </div>
          <div>
            <label class="short-label" for="object-filter-size">Size &gt;:</label>
            <input type="number" id="object-filter-size" onkeyup="filterObjectsList()" placeholder="5" style="width: 60px;">
          </div>
        </div>

        <div style="margin-top: 15px; display: flex; align-items: center; justify-content: space-between; background: var(--border-light-alt3); padding: 8px; border-radius: 4px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <button type="button" class="file-button" onclick="selectAllVisibleObjects()">Select Visible</button>
                <button type="button" class="file-button" onclick="deselectAllObjects()">Deselect All</button>
                <span id="selection-count" style="margin-left: 10px; font-weight: bold; color: var(--text-secondary);">0 Selected</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 14px; color: var(--text-secondary);">Selection Actions:</span>
                <button type="button" class="action-button" style="background-color: var(--success-color-alt);" onclick="executeBulkAction('enable')">Enable</button>
                <button type="button" class="action-button" style="background-color: var(--warning-color-alt);" onclick="executeBulkAction('disable')">Disable</button>
                <button type="button" class="delete-btn" onclick="executeBulkAction('delete')">Delete</button>
            </div>
        </div>

        <div id="object-count-display" style="margin-top: 10px; padding: 5px 0 0 0; color: var(--text-secondary);"></div>
    </div>

        <form method="post">
            <div class="objects-list">
            {% for obj in config.objects %}
                <div class="block object-grid-container">
                  <div>
                    <div class="inline-fields">
                      <div style="margin-right: 8px; display: flex; align-items: center;">
                          <input type="checkbox" class="bulk-select-checkbox" data-object-id="{{ obj.Object | e }}">
                      </div>

                      <div class="object-id">
                        <strong>{{ obj.Object }}</strong>
                        {% if not obj.enabled %}
                            <span class="badge" style="background-color: var(--text-muted); color: white; font-size: 10px; margin-left: 5px;">Disabled</span>
                        {% endif %}
                        {% if obj.original_user_id %}
                          <span class="shared-indicator" style="margin-left: 5px; font-size: 10px;" title="Imported from another user">Imported</span>
                        {% elif obj.is_shared %}
                          <span class="shared-indicator" style="margin-left: 5px; font-size: 10px;" title="You are sharing this item">Shared</span>
                        {% endif %}
                      </div>
                      <div>
                        <label class="short-label" for="name_{{ obj.Object }}">Name:</label>
                        <input type="text" name="name_{{ obj.Object }}" id="name_{{ obj.Object }}" class="name_field" value="{{ obj.Name }}">
                      </div>
                    </div>
                    <div class="inline-fields second-row-fields">
                      <div>
                        <label class="short-label" for="ra_{{ obj.Object }}">RA:</label>
                        <input type="text" name="ra_{{ obj.Object }}" id="ra_{{ obj.Object }}" class="short" value="{{ obj.RA }}">
                      </div>
                      <div>
                        <label class="short-label" for="dec_{{ obj.Object }}">DEC:</label>
                        <input type="text" name="dec_{{ obj.Object }}" id="dec_{{ obj.Object }}" class="short" value="{{ obj.DEC }}">
                      </div>
                    </div>

                    <div class="inline-fields second-row-fields">
                      <div>
                        <label class="short-label" for="constellation_{{ obj.Object }}">Con:</label>
                        <input type="text" name="constellation_{{ obj.Object }}" id="constellation_{{ obj.Object }}" class="object_field" value="{{ obj.Constellation|default('') }}">
                      </div>
                      <div>
                        <label class="short-label" for="type_{{ obj.Object }}">Type:</label>
                        <input type="text" name="type_{{ obj.Object }}" id="type_{{ obj.Object }}" class="object_field" value="{{ obj.Type|default('') }}">
                      </div>
                      <div>
                        <label class="short-label" for="magnitude_{{ obj.Object }}">Mag:</label>
                        <input type="number" name="magnitude_{{ obj.Object }}" id="magnitude_{{ obj.Object }}" class="field-small-numeric" step="0.01"
                               value="{{ obj.Magnitude if obj.Magnitude not in ['N/A', 'Not Found', 'Fetch Error'] else '' }}">
                      </div>
                      <div>
                        <label class="short-label" for="size_{{ obj.Object }}">Size (′):</label>
                        <input type="number" name="size_{{ obj.Object }}" id="size_{{ obj.Object }}" class="field-small-numeric" step="0.01"
                               value="{{ obj.Size if obj.Size not in ['N/A', 'Not Found', 'Fetch Error'] else '' }}">
                      </div>
                      <div>
                        <label class="short-label" for="sb_{{ obj.Object }}">SB:</label>
                        <input type="number" name="sb_{{ obj.Object }}" id="sb_{{ obj.Object }}" class="field-small-numeric" step="0.01"
                               value="{{ obj.SB if obj.SB not in ['N/A', 'Not Found', 'Fetch Error'] else '' }}">
                      </div>
                      {% if obj.catalog_sources %}
                      <div style="align-self: center;">
                        <label class="short-label">Source:</label>
                        <span class="catalog-source-badge">{{ obj.catalog_sources }}</span>
                      </div>
                      {% endif %}
                    </div>
                      <div class="inline-fields second-row-fields">
                        <div style="display: flex; align-items: center;">
                            <label class="short-label" for="enabled_{{ obj.Object }}" style="color: {{ 'var(--success-color-alt)' if obj.enabled else 'var(--accent-gray)' }}; font-weight: bold;">
                                {{ 'Enabled' if obj.enabled else 'Disabled' }}
                            </label>
                            <input type="hidden" name="enabled_{{ obj.Object }}" value="{{ 'on' if obj.enabled else 'off' }}">
                        </div>

                        <div style="margin-left: 15px; display: flex; align-items: center; gap: 10px;">
                            <label class="short-label" for="active_project_{{ obj.Object }}">Active Project:</label>
                            <input type="checkbox" name="active_project_{{ obj.Object }}" id="active_project_{{ obj.Object }}"
                                   {% if obj.ActiveProject %}checked{% endif %}>
                        </div>
                        <div style="margin-left: 15px; display: flex; align-items: center; gap: 10px;">
                            <button type="button" class="action-button" onclick="saveObjectData(this, '{{ obj.Object }}')">Update</button>
                        </div>
                    </div>
                  </div>
                  <div>
                    <div class="inspiration-container" style="background: var(--bg-white); border: 1px solid var(--text-lightest); border-radius: 4px; padding: 12px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 5px;">
                            <label style="font-weight:bold; color:var(--text-secondary); font-size:0.85em; margin:0;">Inspiration Content</label>
                            {{ help_badge('objects_inspiration', extra_attrs='onclick="openHelp(\'objects_inspiration\'); event.stopPropagation();"') }}
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                            <div style="flex: 2; display: flex; gap: 5px;">
                                <input type="text" id="image_url_{{ obj.Object }}" value="{{ obj.image_url or '' }}" placeholder="Image URL (https://...)" style="flex-grow: 1; box-sizing: border-box; padding: 5px; border: 1px solid var(--border-medium-alt); border-radius: 3px; font-size: 13px;">
                                <button type="button" class="file-button" onclick="document.getElementById('upload_file_{{ obj.Object }}').click()" title="Upload a personal image (Protects against catalog updates)">Upload</button>
                                <input type="file" id="upload_file_{{ obj.Object }}" style="display: none;" accept="image/*" onchange="uploadObjectImage(this, 'image_url_{{ obj.Object }}')">
                            </div>
                            <div style="flex: 1;">
                                <input type="text" id="image_credit_{{ obj.Object }}" value="{{ obj.image_credit or '' }}" placeholder="Img Credit" style="width: 100%; box-sizing: border-box; padding: 5px; border: 1px solid var(--border-medium-alt); border-radius: 3px; font-size: 13px;">
                            </div>
                        </div>
                        <div style="margin-bottom: 8px;">
                             <input type="text" id="image_source_link_{{ obj.Object }}" value="{{ obj.image_source_link or '' }}" placeholder="Image Source Link (e.g. APOD URL)" style="width: 100%; box-sizing: border-box; padding: 5px; border: 1px solid var(--border-medium-alt); border-radius: 3px; font-size: 13px;">
                        </div>
                        <div style="margin-bottom: 8px;">
                            <textarea id="description_text_{{ obj.Object }}" rows="2" placeholder="Short description for the tile..." style="width: 100%; box-sizing: border-box; padding: 5px; border: 1px solid var(--border-medium-alt); border-radius: 3px; font-size: 13px; font-family: inherit;">{{ obj.description_text or '' }}</textarea>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <input type="text" id="description_credit_{{ obj.Object }}" value="{{ obj.description_credit or '' }}" placeholder="Text Credit (e.g. Wikipedia)" style="width: 100%; box-sizing: border-box; padding: 5px; border: 1px solid var(--border-medium-alt); border-radius: 3px; font-size: 13px;">
                            </div>
                            <div style="flex: 2;">
                                <input type="text" id="description_source_link_{{ obj.Object }}" value="{{ obj.description_source_link or '' }}" placeholder="Text Source Link" style="width: 100%; box-sizing: border-box; padding: 5px; border: 1px solid var(--border-medium-alt); border-radius: 3px; font-size: 13px;">
                            </div>
                        </div>
                    </div>

                    {% if obj.catalog_info %}
                    <div class="form-group trix-group">
                        <label>Catalog Info:</label>
                        <div class="readonly-notes">
                            {{ obj.catalog_info | sanitize_html | safe }}
                        </div>
                    </div>
                    {% endif %}

                    <div class="form-group trix-group">
                        <label>Private Notes:</label>
                        <input type="hidden" id="project_{{ obj.Object }}_hidden" name="project_{{ obj.Object }}" value="{{ obj.Project | default('', True) | e }}">
                        <div class="trix-lazy-box" onclick="activateLazyTrix(this, 'project_{{ obj.Object }}_hidden', 'Personal notes... (not shared)')">
                            {% if obj.Project and obj.Project.strip() != '' %}
                                {{ obj.Project | sanitize_html | safe }}
                            {% else %}
                                <span class="trix-placeholder-text">Personal notes... (not shared)</span>
                            {% endif %}
                        </div>
                    </div>

                    {% if not SINGLE_USER_MODE %}
                    <div class="form-group trix-group">
                        <label>Shared Notes:</label>
                        <input type="hidden" id="shared_notes_{{ obj.Object }}_hidden" name="shared_notes_{{ obj.Object }}" value="{{ obj.shared_notes | default('', True) | e }}">
                        <div class="trix-lazy-box" onclick="activateLazyTrix(this, 'shared_notes_{{ obj.Object }}_hidden', 'Public notes... (will be shared)')">
                            {% if obj.shared_notes and obj.shared_notes.strip() != '' %}
                                {{ obj.shared_notes | sanitize_html | safe }}
                            {% else %}
                                <span class="trix-placeholder-text">Public notes... (will be shared)</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="share-control">
                        <input type="checkbox" name="is_shared_{{ obj.Object }}" id="is_shared_{{ obj.Object }}" {% if obj.is_shared %}checked{% endif %} {% if obj.original_user_id %}disabled{% endif %}>
                        <label for="is_shared_{{ obj.Object }}">Share this object with other users</label>
                    </div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
              <button type="submit" name="submit_objects" value="1" class="action-button">Update Objects</button>
            </div>
        </form>
    </div>

    <div id="add-object-subtab" class="detail-tab-content">
        <h3>Add New Object</h3>
        <div class="object-add-container object-grid-container block">
            <div>
              <div class="row">
                <div>
                  <label class="long-label" for="new_object">Object ID:</label>
                  <input type="text" name="new_object" id="new_object" class="long" placeholder="e.g., NGC 1234">
                </div>
                <div>
                  <label class="long-label" for="new_name">Name:</label>
                  <input type="text" name="new_name" id="new_name" class="wide" placeholder="Enter common name">
                </div>
              </div>
              <div class="row">
                <div>
                  <label class="long-label" for="new_ra">RA (Hours):</label>
                  <input type="text" name="new_ra" id="new_ra" class="long" placeholder="e.g. 12.34 or 12:30:00">
                </div>
                <div>
                  <label class="long-label" for="new_dec">DEC (Deg):</label>
                  <input type="text" name="new_dec" id="new_dec" class="long" placeholder="e.g. +40.85 or 40:51:00">
                </div>
              </div>

              <div class="inline-fields add-object-details-indent">
                <div>
                  <label class="short-label" for="new_constellation">Con:</label>
                  <input type="text" name="new_constellation" id="new_constellation" class="short" placeholder="e.g., Cyg">
                </div>
                <div>
                  <label class="short-label" for="new_type">Type:</label>
                  <input type="text" name="new_type" id="new_type" class="short" placeholder="e.g., Galaxy">
                </div>
                <div>
                  <label class="short-label" for="new_magnitude">Mag:</label>
                  <input type="number" name="new_magnitude" id="new_magnitude" class="short" step="0.01" placeholder="12.34">
                </div>
                <div>
                  <label class="short-label" for="new_size">Size:</label>
                  <input type="number" name="new_size" id="new_size" class="short" step="0.01" placeholder="5.67">
                </div>
                <div>
                  <label class="short-label" for="new_sb">SB:</label>
                  <input type="number" name="new_sb" id="new_sb" class="short" step="0.01" placeholder="22.5">
                </div>
              </div>

              <div class="share-control" style="margin-top: 10px; margin-left: 15px;">
                  <input type="checkbox" name="new_is_active" id="new_is_active" checked>
                  <label for="new_is_active" style="font-weight: normal; margin-left: 5px;">Active Project</label>
              </div>

              <div class="inspiration-container" style="background: var(--bg-white); border: 1px solid var(--text-lightest); border-radius: 4px; padding: 12px; margin-bottom: 15px;">
                  <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 5px;">
                      <label style="font-weight:bold; color:var(--text-secondary); font-size:0.85em; margin:0;">Inspiration Content (Optional)</label>
                      {{ help_badge('objects_inspiration', extra_attrs='onclick="openHelp(\'objects_inspiration\'); event.stopPropagation();"') }}
                  </div>
                  <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                      <div style="flex: 2; display: flex; gap: 5px;">
                          <input type="text" id="new_image_url" placeholder="Image URL (https://...)" style="flex-grow: 1; box-sizing: border-box; padding: 5px; border: 1px solid var(--border-medium-alt); border-radius: 3px; font-size: 13px;">
                          <button type="button" class="file-button" onclick="document.getElementById('upload_file_new').click()" title="Upload a personal image">Upload</button>
                          <input type="file" id="upload_file_new" style="display: none;" accept="image/*" onchange="uploadObjectImage(this, 'new_image_url')">
                      </div>
                      <div style="flex: 1;">
                          <input type="text" id="new_image_credit" placeholder="Img Credit" style="width: 100%; box-sizing: border-box; padding: 5px; border: 1px solid var(--border-medium-alt); border-radius: 3px; font-size: 13px;">
                      </div>
                  </div>
                  <div style="margin-bottom: 8px;">
                       <input type="text" id="new_image_source_link" placeholder="Image Source Link (e.g. APOD URL)" style="width: 100%; box-sizing: border-box; padding: 5px; border: 1px solid var(--border-medium-alt); border-radius: 3px; font-size: 13px;">
                  </div>
                  <div style="margin-bottom: 8px;">
                      <textarea id="new_description_text" rows="2" placeholder="Short description for the tile..." style="width: 100%; box-sizing: border-box; padding: 5px; border: 1px solid var(--border-medium-alt); border-radius: 3px; font-size: 13px; font-family: inherit;"></textarea>
                  </div>
                  <div style="display: flex; gap: 10px;">
                      <div style="flex: 1;">
                          <input type="text" id="new_description_credit" placeholder="Text Credit" style="width: 100%; box-sizing: border-box; padding: 5px; border: 1px solid var(--border-medium-alt); border-radius: 3px; font-size: 13px;">
                      </div>
                      <div style="flex: 2;">
                          <input type="text" id="new_description_source_link" placeholder="Text Source Link" style="width: 100%; box-sizing: border-box; padding: 5px; border: 1px solid var(--border-medium-alt); border-radius: 3px; font-size: 13px;">
                      </div>
                  </div>
              </div>

              <div>
                  <button id="submit_new_object" type="button" class="action-button">Search</button>
                  <button id="confirm_add_object" type="button" class="action-button" style="display:none;">Confirm Add</button>
                  <button id="edit_object" type="button" class="action-button" style="display:none;">Edit</button>
                  <button id="cancel_add_object" type="button" class="action-button" style="display:none; background-color: var(--accent-slate);">Cancel</button>
              </div>
            </div>

            <div>
              <div class="form-group trix-group">
                  <label for="new_project_editor">Private Notes:</label>
                  <input type="hidden" id="new_project_hidden" name="new_project">
                  <trix-editor input="new_project_hidden" id="new_project_editor" placeholder="Personal notes, framing ideas... (not shared)"></trix-editor>
              </div>

              {% if not SINGLE_USER_MODE %}
              <div class="form-group trix-group">
                  <label for="new_shared_notes_editor">Shared Notes:</label>
                  <input type="hidden" id="new_shared_notes_hidden" name="new_shared_notes">
                  <trix-editor input="new_shared_notes_hidden" id="new_shared_notes_editor" placeholder="Public notes, acquisition advice... (will be shared)"></trix-editor>
              </div>
              <div class="share-control">
                  <input type="checkbox" name="new_is_shared" id="new_is_shared">
                  <label for="new_is_shared">Share this object with other users</label>
              </div>
              {% endif %}
            </div>
        </div>
        <div id="object_result"></div>
    </div>

    <div id="import-object-subtab" class="detail-tab-content">
        <h3>Catalog Packs</h3>
        <div class="block">
            <p>
              Catalog packs are server-provided object collections you can import into your library.
              Importing is non-destructive: existing objects are never overwritten, and overlapping
              objects are skipped.
            </p>

            {% if catalog_packs %}
              <table class="config-table">
                <thead>
                  <tr>
                    <th style="min-width: 180px;">Name</th>
                    <th>Description</th>
                    <th style="min-width: 120px;">Tags</th>
                    <th>Objects</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                {% for pack in catalog_packs %}
                  <tr>
                    <td>{{ pack.name or pack.id }}</td>
                    <td>{{ pack.description }}</td>
                    <td>
                      {% if pack.tags %}
                        {% for tag in pack.tags %}
                          <span class="badge">{{ tag }}</span>
                        {% endfor %}
                      {% else %}
                        <span class="muted-text">–</span>
                      {% endif %}
                    </td>
                    <td>{{ pack.object_count }}</td>
                    <td>
                      <form method="post" action="{{ url_for('tools.import_catalog', pack_id=pack.id) }}" data-pack-name="{{ pack.name or pack.id }}" onsubmit="return confirmCatalogImport(this);">
                        <button type="submit" class="action-button">Import</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            {% else %}
              <p class="muted-text">No catalog packs are available on this server yet.</p>
            {% endif %}
          </div>
    </div>

</div>
<div id="notes-modal" class="modal-backdrop" onclick="closeNotesModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 id="notes-modal-title">Shared Notes</h3>
        <div id="notes-modal-content" class="modal-notes-content"></div>
        <button class="inline-button modal-close-btn" onclick="closeNotesModal()">Close</button>
    </div>
</div>

<div id="duplicates-modal" class="modal-backdrop" onclick="document.getElementById('duplicates-modal').classList.remove('is-visible')">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 800px;">
        <h3>Potential Duplicates</h3>
        <p style="font-size: 14px; color: var(--text-tertiary);">
            These pairs are located within 2.5 arcminutes of each other.
            Merging will move all journals, projects, and framings to the "Kept" object and delete the other.
            Please note that objects from different catalogs might have slightly different RA / DEC and will therefore not be considered as duplicates.
        </p>
        <div id="duplicates-loading" style="text-align: center; padding: 20px; display: none;">
            Scanning catalog... (this may take a few seconds)
        </div>
        <div id="duplicates-list" style="max-height: 50vh; overflow-y: auto;"></div>
          <div style="margin-top: 15px; text-align: right;">
              <button class="action-button" style="background-color: var(--primary-color);" onclick="document.getElementById('duplicates-modal').classList.remove('is-visible')">Close</button>
          </div>
      </div>
  </div>
<script src="{{ url_for('static', filename='js/objects_section.js') }}" defer></script>

</div>