{% from "macros.html" import stat_box, form_group %}

<style>
    /* Styles needed for this include file */
    .project-container { display: flex; gap: 20px; align-items: flex-start; }
    .project-side-column { flex: 0 0 320px; }
    .project-main-column { flex: 1; }

    .stat-box { padding: 15px; background-color: var(--border-light-alt3); border-radius: 6px; text-align: center; margin-bottom: 20px; }
    .stat-value { font-size: 1.6em; font-weight: 600; color: var(--text-primary); display: block; }
    .stat-label { font-size: 0.8em; color: var(--accent-gray-medium); text-transform: uppercase; }

    .final-image-container { margin-top: 20px; text-align: center; }
    .final-image-container img { max-width: 100%; height: auto; border: 1px solid var(--text-lighter); border-radius: 4px; }

    .sessions-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
    .sessions-table th, .sessions-table td { border: 1px solid var(--border-light-alt2); padding: 8px; text-align: left; }
    .sessions-table th { background-color: var(--bg-light); font-weight: 600; }
    .sessions-table tr:hover { background-color: var(--highlight-blue-alt2); cursor: pointer; }

    .notes-section { margin-top: 20px; padding: 15px; border: 1px solid var(--border-light-alt2); border-radius: 6px; background-color: var(--bg-white); }
    .notes-section h3 { font-size: 1.2em; margin-top: 0; border-bottom: 1px solid var(--bg-medium-alt); padding-bottom: 5px; margin-bottom: 10px; }
    .notes-section .notes-content { padding: 5px; min-height: 50px; }

    .form-group label { display: block; margin-bottom: 3px; font-weight: 600; font-size: 0.95em; color: var(--accent-gray-text); }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid var(--border-medium-alt); border-radius: 4px; box-sizing: border-box; font-size: 14px; }
    .form-group.full-width { grid-column: 1 / -1; }
    .form-group.trix-editor-container { margin-top: 15px; }

    #project-edit-mode { display: none; } /* Start hidden */

    /* ===================================================================
       DARK MODE OVERRIDES
       ================================================================ */

    /* Stat boxes */
    [data-theme="dark"] .stat-box {
        background-color: var(--bg-medium);
    }
    [data-theme="dark"] .stat-value {
        color: var(--text-primary);
    }
    [data-theme="dark"] .stat-label {
        color: var(--text-secondary);
    }

    /* Final image container */
    [data-theme="dark"] .final-image-container img {
        border-color: var(--border-medium);
    }

    /* Sessions table */
    [data-theme="dark"] .sessions-table th,
    [data-theme="dark"] .sessions-table td {
        border-color: var(--border-medium);
        color: var(--text-primary);
    }
    [data-theme="dark"] .sessions-table th {
        background-color: var(--bg-medium);
    }
    [data-theme="dark"] .sessions-table tr:hover {
        background-color: var(--bg-medium-alt);
    }

    /* Notes sections */
    [data-theme="dark"] .notes-section {
        background-color: var(--bg-light);
        border-color: var(--border-medium);
    }
    [data-theme="dark"] .notes-section h3 {
        color: var(--text-primary);
        border-bottom-color: var(--border-medium);
    }
    [data-theme="dark"] .notes-section .notes-content {
        color: var(--text-primary);
    }

    /* Form inputs */
    [data-theme="dark"] .form-group label {
        color: var(--text-secondary);
    }
    [data-theme="dark"] .form-group input,
    [data-theme="dark"] .form-group select,
    [data-theme="dark"] .form-group textarea {
        background-color: var(--bg-medium);
        border: 1px solid var(--border-medium);
        color: var(--text-primary);
    }
    [data-theme="dark"] .form-group input:focus,
    [data-theme="dark"] .form-group select:focus,
    [data-theme="dark"] .form-group textarea:focus {
        border-color: var(--primary-color);
        outline: none;
    }
    [data-theme="dark"] .form-group input::placeholder,
    [data-theme="dark"] .form-group textarea::placeholder {
        color: var(--text-muted);
    }

    /* Project edit mode - more specific selectors */
    [data-theme="dark"] #project-edit-mode .form-group input,
    [data-theme="dark"] #project-edit-mode .form-group select,
    [data-theme="dark"] #project-edit-mode .form-group textarea {
        background-color: var(--bg-medium) !important;
        border: 1px solid var(--border-medium) !important;
        color: var(--text-primary) !important;
    }
    [data-theme="dark"] #project-edit-mode .form-group input:focus,
    [data-theme="dark"] #project-edit-mode .form-group select:focus,
    [data-theme="dark"] #project-edit-mode .form-group textarea:focus {
        border-color: var(--primary-color) !important;
        outline: none;
    }
    [data-theme="dark"] #project-edit-mode .form-group label {
        color: var(--text-secondary) !important;
    }
    /* Select dropdown styling */
    [data-theme="dark"] #project-edit-mode .form-group select {
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20width%3D%27292.4%27%20height%3D%27292.4%27%3E%3Cpath%20fill%3D%27%23b0b0b0%27%20d%3D%27M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20128c3.6%203.6%207.8%205.4%2013%205.4s9.4-1.8%2013-5.4l128-128c3.6-3.6%205.4-7.8%205.4-13%200-5-1.8-9.2-5.4-12.8z%27%2F%3E%3C%2Fsvg%3E") !important;
        background-repeat: no-repeat !important;
        background-position: right 10px center !important;
        background-size: 10px !important;
        padding-right: 30px !important;
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        appearance: none !important;
    }
    [data-theme="dark"] #project-edit-mode .form-group select option {
        background-color: var(--bg-dark-secondary);
        color: var(--text-primary);
    }
    /* Notes section in edit mode */
    [data-theme="dark"] #project-edit-mode .notes-section {
        background-color: var(--bg-light) !important;
        border-color: var(--border-medium) !important;
    }
    [data-theme="dark"] #project-edit-mode .notes-section h3 {
        color: var(--text-primary) !important;
        border-bottom-color: var(--border-medium) !important;
    }
</style>

<div id="project-story-container">
    {% if not project_id_for_this_object %}
        <p style="text-align:center; padding: 40px; color:var(--text-quaternary);">This object is not currently linked to a Project. The **Project Details** sub-tab will only appear if the object is the primary target of an existing project.</p>
    {% else %}
        <button class="inline-button" id="edit-button-project" data-action="edit-project">Edit Project</button>

        <div id="project-view-mode" style="padding: 0; margin-top: 20px; border: none; background: none;">
            <h2 style="font-size: 1.5em; margin: 0 0 10px 0;">Project: {{ project_name_for_this_object }}</h2>
            <div class="project-container">
                <div class="project-side-column">
                    {{ stat_box(total_integration_str, 'Total Integration Time') }}
                    {{ stat_box(project.status, 'Status') }}
                    {{ stat_box(project.target_object_name or '-', 'Primary Target') }}

                    <div class="notes-section">
                        <h3>Goals & Status</h3>
                        <div class="notes-content">{{ goals_html | default('No goals set.', true) | sanitize_html | safe }}</div>
                    </div>

                    {% if project.final_image_file %}
                    <div class="final-image-container">
                        {% set image_username = current_user.username if not SINGLE_USER_MODE else 'default' %}
                        <a href="{{ url_for('core.get_uploaded_image', username=image_username, filename=project.final_image_file) }}" target="_blank">
                            <img src="{{ url_for('core.get_uploaded_image', username=image_username, filename=project.final_image_file) }}" alt="Final Project Image">
                        </a>
                        <span class="stat-label" style="margin-top:5px; display:block;">Final Image</span>
                    </div>
                    {% endif %}
                </div>

                <div class="project-main-column">
                    <div class="notes-section">
                        <h3>Project Story & Learnings</h3>
                        <div class="notes-content">{{ description_notes_html | default('No project description added.', true) | sanitize_html | safe }}</div>
                    </div>

                    <div class="notes-section">
                        <h3>Framing Notes</h3>
                        <div class="notes-content">{{ framing_notes_html | default('No framing notes added.', true) | sanitize_html | safe }}</div>
                    </div>

                    <div class="notes-section">
                        <h3>Processing Notes</h3>
                        <div class="notes-content">{{ processing_notes_html | default('No processing workflow recorded.', true) | sanitize_html | safe }}</div>
                    </div>

                    <div class="notes-section">
                        <h3>Linked Sessions ({{ sessions|length }} nights)</h3>
                        <table class="sessions-table">
                            <thead>
                                <tr>
                                    <th>Date (UTC)</th>
                                    <th>Location</th>
                                    <th>Rating</th>
                                    <th>Integ. Time</th>
                                    <th>SQM</th>
                                    <th>Seeing</th>
                                    <th>Rig Snapshot</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in sessions %}
                                <tr data-nav-url="{{ url_for("core.graph_dashboard", object_name=session.object_name, session_id=session.id) }}&tab=journal">
                                    <td>{{ session.date_utc | date_eu }}</td>
                                    <td>{{ session.location_name or '-' }}</td>
                                    <td>{{ session.session_rating_subjective or '-' }}{% if session.session_rating_subjective %} â˜…{% endif %}</td>
                                    <td>{{ session.calculated_integration_time_minutes | round(0) or '-' }} min</td>
                                    <td>{{ session.sky_sqm_observed or '-' }}</td>
                                    <td>{{ session.seeing_observed_fwhm or '-' }}{% if session.seeing_observed_fwhm %}"{% endif %}</td>
                                    <td>{{ session.rig_name_snapshot or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if not sessions %}
                            <p style="text-align:center; color:var(--text-quaternary);">No sessions have been linked to this project yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div id="project-edit-mode" style="padding: 0; margin-top: 20px; border: none; background: none;">
            <form id="project-edit-form" method="POST" action="{{ url_for('projects.project_detail', project_id=project_id_for_this_object) }}" enctype="multipart/form-data">

                <div class="project-header" style="border-bottom: none; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 1.5em; margin: 0;">Editing Project: {{ project_name_for_this_object }}</h2>
                    <div class="action-buttons">
                        <button type="submit" class="inline-button" style="background-color:var(--success-color);">Save Project</button>
                        <button type="button" class="inline-button" style="background-color:var(--accent-gray-medium);" data-action="cancel-project-edit">Cancel</button>
                    </div>
                </div>

                <div class="project-container">
                    <div class="project-side-column">
                        <div class="notes-section">
                            <h3>Metadata</h3>
                            <div class="form-group"><label for="project-name">Project Name:</label><input type="text" id="project-name" name="name" value="{{ project.name }}" required></div>
                            <div class="form-group"><label for="target-object-id">Primary Target:</label>
                                <select id="target-object-id" name="target_object_id">
                                    <option value="">-- Select Primary Target --</option>
                                    {% for obj in all_objects %}
                                    <option value="{{ obj.object_name }}" {% if obj.object_name == project.target_object_name %}selected{% endif %}>{{ obj.common_name or obj.object_name }} ({{ obj.object_name }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group"><label for="project-status">Status:</label>
                                <select id="project-status" name="status">
                                    {% for status_option in project_statuses %}
                                    <option value="{{ status_option }}" {% if status_option == project.status %}selected{% endif %}>{{ status_option }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group trix-editor-container"><label for="goals-editor-edit">Goals & Status:</label>
                                <input type="hidden" id="goals-hidden" name="goals" value="{{ goals_html | sanitize_html | safe }}">
                                <trix-editor input="goals-hidden" id="goals-editor-edit" style="min-height: 100px;"></trix-editor>
                            </div>

                            <div class="form-group full-width">
                                <h3>Final Image</h3>
                                {% if project.final_image_file %}
                                    <p style="font-size:13px;">Current file: <code>{{ project.final_image_file }}</code></p>
                                    <label style="color: var(--danger-color); cursor: pointer;"><input type="checkbox" name="delete_final_image" value="1"> Delete Current Image</label>
                                    <hr class="detail-separator">
                                {% endif %}
                                <label for="final_image">Upload New Final Image (optional, max 5MB)</label>
                                <input type="file" id="final_image" name="final_image" accept="image/jpeg, image/png, image/gif">
                            </div>
                        </div>
                    </div>

                    <div class="project-main-column">
                        <div class="notes-section form-group full-width trix-editor-container"><label for="description-editor-edit">Project Story & Learnings:</label>
                            <input type="hidden" id="description-hidden" name="description_notes" value="{{ description_notes_html | sanitize_html | safe }}">
                            <trix-editor input="description-hidden" id="description-editor-edit" style="min-height: 150px;"></trix-editor>
                        </div>

                        <div class="notes-section form-group full-width trix-editor-container"><label for="framing-editor-edit">Framing Notes (Composition/FoV):</label>
                            <input type="hidden" id="framing-hidden" name="framing_notes" value="{{ framing_notes_html | sanitize_html | safe }}">
                            <trix-editor input="framing-hidden" id="framing-editor-edit" style="min-height: 150px;"></trix-editor>
                        </div>

                        <div class="notes-section form-group full-width trix-editor-container"><label for="processing-editor-edit">Processing Notes & Workflow:</label>
                            <input type="hidden" id="processing-hidden" name="processing_notes" value="{{ processing_notes_html | sanitize_html | safe }}">
                            <trix-editor input="processing-hidden" id="processing-editor-edit" style="min-height: 150px;"></trix-editor>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    {% endif %}
</div>