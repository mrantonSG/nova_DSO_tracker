{% extends "base.html" %}

{% block title %}Nova â€“ Configuration{% endblock %}

{% block head_extra %}
  <link rel="icon" href="{{ url_for('static', filename='favicon_v2.ico') }}" type="image/x-icon">
  <meta charset="UTF-8">
  <title>Configuration Form</title>
  <style>
    body {
      padding: 20px;
      margin: 0;
      font-family: 'Roboto', sans-serif;
    }

    fieldset {
      border: none;
      padding: 0;
      margin: 0;
    }
    legend {
      font-size: 16px;
      font-weight: bold;
      padding: 0 5px;
      color: #333;
    }
    label {
      font-size: 14px;
      margin-right: 5px;
    }
    input, select, textarea {
      font-size: 14px;
      padding: 5px;
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
    }
    .block {
      border: 0px solid #ddd;
      background: #ecf1f1;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .error {
      color: #dc3545;
    }

    .message,
    .progress-message {
      color: #6795a4;
    }
    .config-section {
        padding: 1.5em;
        background-color: #f9f9f9;
        border-radius: 8px;
    }
    .config-section h2, .config-section h3 {
        color: #333;
        font-size: 16px;
        font-weight: bold;
        margin-top: 0;
        margin-bottom: 1.5em;
        border-bottom: 1px solid #ecf0f1;
        padding-bottom: 0.5em;
    }

    input.wide {
      width: 300px;
    }
    input.short {
      width: 150px;
    }
    .inline-fields label {
      display: inline-block;
      width: 20px;
      text-align: left;
      margin: 0;
      padding: 0;
    }
    .location-id {
      width: 100px;
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
    }
    .object-id {
      width: 100px;
    }

    h3, h4 {
      font-weight: normal;
    }

    input.object_field {
      width: 65px;
    }
    .field-small-numeric {
      width: 102px;
    }
    input.name_field {
      width: 250px;
    }
    input.project_field {
      width: 300px;
    }
    textarea.wide, textarea.project_field {
      width: 300px;
      height: 60px;
      box-sizing: border-box;
    }
    .inline-fields {
      display: flex;
      flex-wrap: nowrap;
      align-items: flex-start;
      gap: 15px;
      margin: 0 0 10px 0;
    }
    .inline-fields > div {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 5px;
    }
    .inline-fields input,
    .inline-fields textarea {
      margin-top: 0;
      box-sizing: border-box;
      font-size: 15px;
    }

    .locations-list, .objects-list {
      margin-top: 20px;
    }
    .short-label {
      display: inline-block;
      width: auto !important;
      margin-right: 2px !important;
      text-align: left !important;
      white-space: nowrap;
    }
    .long-label {
      display: inline-block;
      width: 70px !important;
      margin-right: 5px !important;
      text-align: left !important;
      white-space: nowrap;
    }
    .verylong-label {
      display: inline-block;
      width: 140px !important;
      margin-right: 5px !important;
      text-align: left !important;
      white-space: nowrap;
    }
    .object-add-container .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .action-button {
      padding: 5px 10px;
      font-size: 14px;
      background-color: #83b4c5;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
    }
    .action-button:hover {
      background-color: #6795a4;
    }
    .dlback-button {
      margin-top: 0;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #83b4c5;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
    }
    .dlback-button:hover {
      background-color: #6795a4 !important;
    }
    .info-container-main {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 20px;
    }

    .left-group,
    .right-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .file-button {
      padding: 5px 10px;
      font-size: 14px;
      background-color: #98A5A8;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
    }
    .file-button:hover {
      background-color: #6795a4;
    }

    .second-row-fields {
      margin-left: 117px;
    }
    .objects-list .inline-fields input[type="checkbox"],
    .block .inline-fields input[type="checkbox"] {
      transform: scale(1.5);
      transform-origin: center left;
      margin-top: 0;
      margin-right: 5px;
    }
    .add-object-details-indent {
      margin-left: 0px;
    }
    .add-object-details-indent > div {
      gap: 15px;
    }
    .tab-container {
        display: flex;
        margin-bottom: 15px;
        border-bottom: 2px solid #ccc;
    }
    .tab-button {
        padding: 10px 20px;
        cursor: pointer;
        border: 1px solid #ccc;
        border-bottom: none;
        background-color: #e9e9e9;
        margin-right: 5px;
        border-radius: 5px 5px 0 0;
        font-size: 16px;
    }
    .tab-button.active {
        background-color: #fff;
        border-color: #ccc;
        border-bottom: 2px solid #fff;
        position: relative;
        top: 1px;
    }


    .container { display: flex; gap: 2em; flex-wrap: wrap; }
    .column { background-color: #f9f9f9; padding: 1.5em; border-radius: 8px; flex: 1; min-width: 350px;}
    .column h2, .column h3 { color: #333; font-size: 16px; font-weight: bold; border-bottom: 1px solid #ecf0f1; padding-bottom: 0.5em; margin-top: 0; margin-bottom: 1em; }
    .column details > summary { cursor: pointer; font-weight: bold; }
    .column hr { border: 0; border-top: 1px solid #ecf0f1; margin: 1.5em 0; }
    .column .form-group { margin-bottom: 1em; }
    .column .form-group label { display: block; margin-bottom: 5px; font-weight: normal; font-size: 14px; }
    .column .form-group input, .column .form-group select { width: 100%; padding: 0.7em; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    .column ul { list-style-type: none; padding: 0; }
    .column button {
      background-color: #83b4c5;
      color: white;
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .column button:hover {
      background-color: #6795a4;
    }
    .column li {
      background-color: #ecf1f1;
      border: none;
      padding: 0.8em;
      margin-bottom: 0.5em;
      border-radius: 4px;
      font-size: 0.95em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .column li .item-info {
        flex-grow: 1;
    }
    .column li .item-actions {
        display: flex;
        gap: 5px;
        flex-shrink: 0;
    }
    .edit-btn, .delete-btn {
        color: white;
        border: none;
        padding: 5px 10px;
        font-size: 14px;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    .edit-btn { background-color: #778899; }
    .edit-btn:hover { background-color: #5a6875; }
    .delete-btn { background-color: #dc3545; }
    .delete-btn:hover { background-color: #c82333; }
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropdown-btn {
      padding-right: 20px;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #f1f1f1;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1;
      border-radius: 5px;
      overflow: hidden;
    }
    .dropdown-content a {
      color: black;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      font-size: 14px;
    }
    .dropdown-content a:hover {
      background-color: #ddd;
    }
    .show {
      display: block;
    }
      .sampling-info {
        font-size: 0.9em;
        margin-top: 5px;
        display: block;
        font-weight: bold;
    }
    .sampling-binning-tip {
        font-size: 0.8em;
        display: block;
        margin-top: 2px;
        font-weight: normal;
        font-style: italic;
        color: #666;
    }
    .sampling-oversampled { color: #9b59b6; }
    .sampling-slightly-oversampled { color: #3498db; }
    .sampling-good { color: #2ecc71; }
    .sampling-slightly-undersampled { color: #f39c12; }
    .sampling-undersampled { color: #e74c3c; }
    .form-group {
      margin-top: 1em;
      margin-bottom: 1em;
    }
    .form-group {
        display: grid;
        grid-template-columns: 155px auto;
        align-items: center;
        grid-row-gap: 5px;
        margin-top: 20px;
        margin-bottom: 20px;
    }
    .form-group small {
        grid-column-start: 2;
    }
    .form-group select.form-control {
        justify-self: start;
    }
    #telemetry_enabled { transform: scale(1.2); transform-origin: center left; }
    #sampling_interval {
      font-size: 15px;
    }
  </style>
{% endblock %}
</head>
<body>

{% block body %}

  <div class="info-container-main">
    <div class="left-group">
      <a href="{{ url_for('index') }}" class="dlback-button">Back to Tracker</a>
    </div>
    <div id="message-container" style="height: 24px; flex-grow: 1; text-align: center;">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <p class="{{ 'error' if category == 'error' else 'message' }} flash-transient" style="margin: 0;">{{ message }}</p>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>
<div class="right-group">
      <form method="post" action="{{ url_for('fetch_all_details') }}" id="fetch-details-form">
        <button type="submit" class="file-button" id="fetch-details-button">Fetch Missing Details</button>
      </form>

      <div class="dropdown">
        <button class="file-button dropdown-btn">Download â–¼</button>
        <div class="dropdown-content">
          <a href="{{ url_for('download_config') }}">Configuration</a>
          <a href="{{ url_for('download_journal') }}">Journal</a>
          <a href="{{ url_for('download_rig_config') }}">Rigs</a>
        </div>
      </div>

      <div class="dropdown">
        <button class="file-button dropdown-btn">Import â–¼</button>
        <div class="dropdown-content">
          <a href="#" id="import-config-btn">Configuration</a>
          <a href="#" id="import-journal-btn">Journal</a>
          <a href="#" id="import-rigs-btn">Rigs</a>
        </div>
      </div>

      <input type="file" id="config-upload" accept=".yaml" style="display:none;">
      <input type="file" id="journal-upload" accept=".yaml,.yml" style="display:none;">
      <input type="file" id="rigs-upload" accept=".yaml,.yml" style="display:none;">
    </div>
  </div>

  <div class="tab-container">
    <button class="tab-button" data-tab="general">General</button>
    <button class="tab-button" data-tab="locations">Locations</button>
    <button class="tab-button" data-tab="objects">Objects</button>
    <button class="tab-button" data-tab="rigs">Rigs</button>
  </div>

    <div id="general-tab-content">
        <div class="config-section">
          <h2>General Settings</h2>
          <form method="post">
              <div class="inline-fields">
                <div>
                  <label class="verylong-label" for="altitude_threshold">Altitude Threshold (Â°):</label>
                  <input type="number" name="altitude_threshold" id="altitude_threshold"
                         value="{{ config.get('altitude_threshold', 20) }}" min="0" max="90" required>
                </div>
                <input type="hidden" name="default_location" value="{{ config.get('default_location', '') }}">
              </div>
              <hr>
              <div class="inline-fields">
                <div>
                  <label class="verylong-label" for="min_observable_minutes">Min Observable (min):</label>
                  <input type="number" name="min_observable_minutes" id="min_observable_minutes"
                         value="{{ config.get('imaging_criteria', {}).get('min_observable_minutes', 60) }}" min="0" max="600">
                </div>
                <div>
                  <label class="verylong-label" for="min_max_altitude">Min Max Altitude (Â°):</label>
                  <input type="number" name="min_max_altitude" id="min_max_altitude"
                         value="{{ config.get('imaging_criteria', {}).get('min_max_altitude', 30) }}" min="0" max="90">
                </div>
              </div>
              <div class="inline-fields">
                <div>
                  <label class="verylong-label" for="max_moon_illumination">Max Moon Illum (%):</label>
                  <input type="number" name="max_moon_illumination" id="max_moon_illumination"
                         value="{{ config.get('imaging_criteria', {}).get('max_moon_illumination', 20) }}" min="0" max="100">
                </div>
                <div>
                  <label class="verylong-label" for="min_angular_separation">Min Moon Sep (Â°):</label>
                  <input type="number" name="min_angular_separation" id="min_angular_separation"
                         value="{{ config.get('imaging_criteria', {}).get('min_angular_distance', 30) }}" min="0" max="180">
                </div>
                <div>
                  <label class="verylong-label" for="search_horizon_months">Search months:</label>
                  <input type="number" name="search_horizon_months" id="search_horizon_months"
                         value="{{ config.get('imaging_criteria', {}).get('search_horizon_months', 6) }}" min="1" max="24">
                </div>
              </div>
              {% if SINGLE_USER_MODE %}
              <hr>
              <div class="form-group">
                <label for="sampling_interval">Calculation Precision:</label>
                <select id="sampling_interval" name="sampling_interval" class="form-control">
                  {% set current_interval = config.get('sampling_interval_minutes', 15) %}
                  <option value="10" {% if current_interval == 10 %}selected{% endif %}>High (10 min samples)</option>
                  <option value="15" {% if current_interval == 15 %}selected{% endif %}>Default (15 min samples)</option>
                  <option value="20" {% if current_interval == 20 %}selected{% endif %}>Balanced (20 min samples)</option>
                  <option value="30" {% if current_interval == 30 %}selected{% endif %}>Fast (30 min samples)</option>
                  <option value="60" {% if current_interval == 60 %}selected{% endif %}>Fastest (60 min samples)</option>
                </select>
                <small class="form-text text-muted">
                  Note: Your 'Current Altitude' is always calculated in real-time. This setting only refines the accuracy of the nightly overview values (Max Altitude, Observable Duration, etc.). 'Fast' is recommended for low-power devices.
                </small>
              </div>
              {% endif %}
              {% if SINGLE_USER_MODE %}
              <hr>
              <div class="inline-fields">
                <div>
                  <label class="verylong-label" for="telemetry_enabled">Anonymous Telemetry:</label>
                  <input type="checkbox" name="telemetry_enabled" id="telemetry_enabled"
                         {% if config.get('telemetry', {}).get('enabled', True) %}checked{% endif %}>
                </div>
                <small class="form-text text-muted">
                  Nova sends a small anonymous heartbeat (app version, system type, and counts of your data entries like objects, rigs, locations, and journals). No personal details are ever collected, and you can opt out anytime. Allowing it really helps me improve Nova.
                </small>
              </div>
              <hr>
              {% endif %}
               <button type="submit" name="submit_general" class="action-button" style="margin-top:10px;">Save Settings</button>
          </form>
        </div>
      </div>

    <div id="locations-tab-content">
        <div class="config-section">
          <h2>Locations Configuration</h2>
          <form method="post">
            <h3>Add New Location</h3>
            <div class="inline-fields">
              <div>
                <label class="short-label" for="new_location">Name:</label>
                <input type="text" name="new_location" id="new_location" placeholder="e.g., New York">
              </div>
              <div>
                <label class="short-label" for="new_lat">Lat:</label>
                <input type="text" name="new_lat" id="new_lat" placeholder="40.7128">
              </div>
              <div>
                <label class="short-label" for="new_lon">Lon:</label>
                <input type="text" name="new_lon" id="new_lon" placeholder="-74.0060">
              </div>
              <div>
                <label class="short-label" for="new_timezone">Timezone:</label>
                <input type="text" name="new_timezone" id="new_timezone" placeholder="America/New_York">
              </div>
              <div>
                <button type="submit" name="submit_new_location" value="1" class="action-button">Add</button>
              </div>
            </div>
            <hr>
            <div class="locations-list">
              {% for loc_key, loc_val in locations.items() %}
                <div class="block">
                  <div class="inline-fields">
                    <div class="location-id">
                      <strong>{{ loc_key }}</strong>
                    </div>
                    <div>
                      <label class="short-label" for="lat_{{ loc_key }}">Lat:</label>
                      <input type="text" name="lat_{{ loc_key }}" id="lat_{{ loc_key }}" value="{{ loc_val.lat }}">
                    </div>
                    <div>
                      <label class="short-label" for="lon_{{ loc_key }}">Lon:</label>
                      <input type="text" name="lon_{{ loc_key }}" id="lon_{{ loc_key }}" value="{{ loc_val.lon }}">
                    </div>
                    <div>
                      <label class="long-label" for="timezone_{{ loc_key }}">Timezone:</label>
                      <input type="text" name="timezone_{{ loc_key }}" id="timezone_{{ loc_key }}" value="{{ loc_val.timezone }}">
                    </div>
                    <div>
                      <label class="short-label" for="delete_loc_{{ loc_key }}">Del:</label> <input type="checkbox" name="delete_loc_{{ loc_key }}" id="delete_loc_{{ loc_key }}">
                    </div>
                    <div>
                      <a href="https://www.google.com/maps?q={{ loc_val.lat }},{{ loc_val.lon }}"
                         target="_blank"
                         title="View on Google Maps"
                         class="action-button"
                         style="text-decoration: none; font-size: 13px; padding: 6px 12px; margin-left: 10px;">
                         Open Map
                      </a>
                    </div>
                  </div>
                    <div class="inline-fields">
                        <div class="location-id">
                            </div>
                        <div style="display: grid; grid-template-columns: auto 1fr; align-items: start; gap: 5px;">

                            <label class="short-label" for="horizon_mask_{{ loc_key }}" style="padding-top: 5px;">Horizon Mask:</label>

                            <textarea name="horizon_mask_{{ loc_key }}"
                                      id="horizon_mask_{{ loc_key }}"
                                      rows="3"
                                      style="width: 655px; font-family: monospace; font-size: 13px;"
                                      placeholder="Optional. e.g., [[0, 35], [90, 15]]">{% set mask = loc_val.get('horizon_mask') %}{% if mask %}{{ mask | toyaml }}{% endif %}</textarea>

                            <div></div>

                            <small style="max-width: 500px; color: #666;">
                                Optional list of `[azimuth, altitude]` pairs. Use `[az, 0]` to revert to the baseline.
                            </small>
                        </div>
                    </div>
                </div>
              {% endfor %}
              <button type="submit" name="submit_locations" value="1" class="action-button">Update Locations</button>
            </div>
          </form>
        </div>
      </div>

<div id="objects-tab-content">
    <div class="config-section">
      <h2>Objects Configuration</h2>
      <h3>Add New Object</h3>
      <div class="object-add-container">
        <div class="row">
          <div>
            <label class="long-label" for="new_object">Object ID:</label>
            <input type="text" name="new_object" id="new_object" class="long" placeholder="e.g., NGC 1234">
          </div>
          <div>
            <label class="long-label" for="new_name">Name:</label>
            <input type="text" name="new_name" id="new_name" class="wide" placeholder="Enter common name">
          </div>
        </div>
        <div class="row">
          <div>
            <label class="long-label" for="new_ra">RA:</label>
            <input type="text" name="new_ra" id="new_ra" class="long" placeholder="RA from SIMBAD">
          </div>
          <div>
            <label class="long-label" for="new_dec">DEC:</label>
            <input type="text" name="new_dec" id="new_dec" class="long" placeholder="DEC from SIMBAD">
          </div>
        </div>
        <div class="inline-fields">
          <div>
            <label class="long-label" for="new_project">Notes:</label>
            <textarea name="new_project" id="new_project" class="wide" placeholder="Enter project details..."></textarea>
          </div>
        </div>
        <div class="inline-fields add-object-details-indent">
          <div>
            <label class="short-label" for="new_constellation">Con:</label>
            <input type="text" name="new_constellation" id="new_constellation" class="short" placeholder="e.g., Cyg" readonly>
          </div>
          <div>
            <label class="short-label" for="new_type">Type:</label>
            <input type="text" name="new_type" id="new_type" class="short" placeholder="e.g., Galaxy">
          </div>
          <div>
            <label class="short-label" for="new_magnitude">Mag:</label>
            <input type="number" name="new_magnitude" id="new_magnitude" class="short" step="0.01" placeholder="12.34">
          </div>
          <div>
            <label class="short-label" for="new_size">Size:</label>
            <input type="number" name="new_size" id="new_size" class="short" step="0.01" placeholder="5.67">
          </div>
          <div>
            <label class="short-label" for="new_sb">SB:</label>
            <input type="number" name="new_sb" id="new_sb" class="short" step="0.01" placeholder="22.5">
          </div>
        </div>
        <button id="submit_new_object" type="button" class="action-button">Search</button>
        <button id="confirm_add_object" type="button" class="action-button" style="display:none;">Confirm Add</button>
        <button id="edit_object" type="button" class="action-button" style="display:none;">Edit</button>
      </div>
      <div id="object_result"></div>
      <hr>
      <form method="post">
        <div class="objects-list">
          {% for obj in config.objects %}
            <div class="block">
              <div class="inline-fields">
                <div class="object-id">
                  <strong>{{ obj.Object }}</strong>
                </div>
                <div>
                  <label class="short-label" for="name_{{ obj.Object }}">Name:</label>
                  <input type="text" name="name_{{ obj.Object }}" id="name_{{ obj.Object }}" class="name_field" value="{{ obj.Name }}">
                </div>
                <div>
                  <label class="short-label" for="ra_{{ obj.Object }}">RA:</label>
                  <input type="text" name="ra_{{ obj.Object }}" id="ra_{{ obj.Object }}" class="short" value="{{ obj.RA }}">
                </div>
                <div>
                  <label class="short-label" for="dec_{{ obj.Object }}">DEC:</label>
                  <input type="text" name="dec_{{ obj.Object }}" id="dec_{{ obj.Object }}" class="short" value="{{ obj.DEC }}">
                </div>
                <div>
                  <label class="short-label" for="project_{{ obj.Object }}">Notes:</label>
                  <textarea name="project_{{ obj.Object }}" id="project_{{ obj.Object }}" class="project_field">{{ obj.Project }}</textarea>
                </div>
                <div>
                  <label class="short-label" for="delete_{{ obj.Object }}">Del:</label> <input type="checkbox" name="delete_{{ obj.Object }}" id="delete_{{ obj.Object }}">
                </div>
              </div>
              <div class="inline-fields second-row-fields">
                <div>
                  <label class="short-label" for="constellation_{{ obj.Object }}">Con:</label>
                  <input type="text" name="constellation_{{ obj.Object }}" id="constellation_{{ obj.Object }}" class="object_field" value="{{ obj.Constellation|default('') }}" readonly>
                </div>
                <div>
                  <label class="short-label" for="type_{{ obj.Object }}">Type:</label>
                  <input type="text" name="type_{{ obj.Object }}" id="type_{{ obj.Object }}" class="object_field" value="{{ obj.Type|default('') }}">
                </div>
                <div>
                  <label class="short-label" for="magnitude_{{ obj.Object }}">Mag:</label>
                  <input type="number" name="magnitude_{{ obj.Object }}" id="magnitude_{{ obj.Object }}" class="field-small-numeric" step="0.01" value="{{ obj.Magnitude|default('') }}">
                </div>
                <div>
                  <label class="short-label" for="size_{{ obj.Object }}">Size (â€²):</label>
                  <input type="number" name="size_{{ obj.Object }}" id="size_{{ obj.Object }}" class="field-small-numeric" step="0.01" value="{{ obj.Size|default('') }}">
                </div>
                <div>
                  <label class="short-label" for="sb_{{ obj.Object }}">SB:</label>
                  <input type="number" name="sb_{{ obj.Object }}" id="sb_{{ obj.Object }}" class="field-small-numeric" step="0.01" value="{{ obj.SB|default('') }}">
                </div>
              </div>
            </div>
          {% endfor %}
          <button type="submit" name="submit_objects" value="1" class="action-button">Update Objects</button>
        </div>
      </form>
    </div>
  </div>

  <div id="rigs-tab-content">
    <div class="container">
        <div class="column">
            <h2>1. Define Your Components</h2>
            <p style="font-size:14px; color: #555;">Add or update your equipment here. To edit an item, click "Edit" to load its details into the form, make your changes, and click the "Update" button.</p>
            <details open>
                <summary><h3>Telescopes (<span id="tele-count">0</span>)</h3></summary>
                <form action="{{ url_for('add_component') }}" method="post" id="form-telescope">
                    <input type="hidden" name="component_type" value="telescopes">
                    <input type="hidden" name="component_id" value="">
                    <div class="form-group"><label for="tele_name">Name:</label><input type="text" name="name" id="tele_name" required placeholder="e.g., Celestron EdgeHD 11"></div>
                    <div class="form-group"><label for="aperture">Aperture (mm):</label><input type="number" step="any" name="aperture_mm" id="aperture" required></div>
                    <div class="form-group"><label for="focal_length">Focal Length (mm):</label><input type="number" step="any" name="focal_length_mm" id="focal_length" required></div>
                    <button type="submit">Add Telescope</button>
                </form>
                <hr>
                <ul id="telescope-list"></ul>
            </details>
            <hr>

            <details open>
                <summary><h3>Cameras (<span id="cam-count">0</span>)</h3></summary>
                <form action="{{ url_for('add_component') }}" method="post" id="form-camera">
                    <input type="hidden" name="component_type" value="cameras">
                    <input type="hidden" name="component_id" value="">
                    <div class="form-group"><label for="cam_name">Name:</label><input type="text" name="name" id="cam_name" required placeholder="e.g., ZWO ASI2600MC Pro"></div>
                    <div class="form-group"><label for="sensor_w">Sensor Width (mm):</label><input type="number" step="any" name="sensor_width_mm" id="sensor_w" required></div>
                    <div class="form-group"><label for="sensor_h">Sensor Height (mm):</label><input type="number" step="any" name="sensor_height_mm" id="sensor_h" required></div>
                    <div class="form-group"><label for="pixel_s">Pixel Size (Î¼m):</label><input type="number" step="any" name="pixel_size_um" id="pixel_s" required></div>
                    <button type="submit">Add Camera</button>
                </form>
                <hr>
                <ul id="camera-list"></ul>
            </details>
            <hr>

            <details open>
                <summary><h3>Reducers / Extenders (<span id="red-count">0</span>)</h3></summary>
                <form action="{{ url_for('add_component') }}" method="post" id="form-reducer">
                    <input type="hidden" name="component_type" value="reducers_extenders">
                    <input type="hidden" name="component_id" value="">
                    <div class="form-group"><label for="red_name">Name:</label><input type="text" name="name" id="red_name" required placeholder="e.g., Celestron 0.7x Reducer"></div>
                    <div class="form-group"><label for="factor">Factor:</label><input type="number" step="any" name="factor" id="factor" required placeholder="e.g., 0.7 for reducer"></div>
                    <button type="submit">Add Reducer/Extender</button>
                </form>
                <hr>
                <ul id="reducer-list"></ul>
            </details>
        </div>

        <div class="column">
            <h2>2. Configure Your Rigs</h2>
            <p style="font-size:14px; color: #555;">Combine your components into a complete imaging rig. To edit, click "Edit" to load the rig into the form below.</p>
            <form action="{{ url_for('add_rig') }}" method="post" id="form-rig">
                <input type="hidden" name="rig_id" value="">
                <div class="form-group"><label for="rig_name">Rig Name:</label><input type="text" name="rig_name" id="rig_name" required placeholder="e.g., C11 Deep Sky Rig"></div>
                <div class="form-group">
                    <label for="tele_select">Telescope:</label>
                    <select name="telescope_id" id="tele_select" required>
                        <option value="" disabled selected>-- Select a Telescope --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cam_select">Camera:</label>
                    <select name="camera_id" id="cam_select" required>
                        <option value="" disabled selected>-- Select a Camera --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="red_select">Reducer / Extender (Optional):</label>
                    <select name="reducer_extender_id" id="red_select">
                        <option value="">-- None --</option>
                    </select>
                </div>
                <button type="submit">Create Rig</button>
            </form>
             <hr>
            <div class="form-group">
                <label for="seeing-select">Select Your Typical Seeing:</label>
                <select id="seeing-select">
                    <option value="none" >-- Select Seeing to Assess Rigs --</option>
                    <option value="1.0-2.0">Excellent Seeing (1.0" - 2.0" FWHM)</option>
                    <option value="2.0-4.0" selected >Good Seeing (2.0" - 4.0" FWHM)</option>
                    <option value="4.0-6.0">Poor Seeing (> 4.0" FWHM)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="rig-sort">Sort rigs by:</label>
                <select id="rig-sort">
                    <option value="name-asc" selected>Name (Aâ†’Z)</option>
                    <option value="name-desc">Name (Zâ†’A)</option>
                    <option value="fl-asc">Effective Focal Length (lowâ†’high)</option>
                    <option value="fl-desc">Effective Focal Length (highâ†’low)</option>
                    <option value="fr-asc">f/ratio (lowâ†’high)</option>
                    <option value="fr-desc">f/ratio (highâ†’low)</option>
                    <option value="scale-asc">Image Scale (lowâ†’high)</option>
                    <option value="scale-desc">Image Scale (highâ†’low)</option>
                    <option value="fovw-asc">FOV Width (lowâ†’high)</option>
                    <option value="fovw-desc">FOV Width (highâ†’low)</option>
                    <option value="recent-desc">Recently Added (newest first)</option>
                    <option value="recent-asc">Recently Added (oldest first)</option>
                </select>
            </div>
            <h3>Existing Rigs (<span id="rig-count">0</span>)</h3>
            <ul id="existing-rigs-list"></ul>
        </div>
    </div>
  </div>

  <br>

<script>
    // --- Global variables ---
    let rigsData = {}; // Store all rig data globally
    let rigsDataLoaded = false;
    let rigSort = localStorage.getItem('rigSort') || 'name-asc';

    // --- Rigs Tab Functions ---

    function populateComponentFormForEdit(type, id) {
        // --- NEW, ROBUST LOGIC ---
        // First, determine the correct key for the component list based on the type.
        let componentListKey;
        if (type === 'telescope') {
            componentListKey = 'telescopes';
        } else if (type === 'camera') {
            componentListKey = 'cameras';
        } else if (type === 'reducer_extender') {
            componentListKey = 'reducers_extenders';
        } else {
            // If the type is unknown, stop and log an error.
            console.error("Unknown component type provided to populateComponentFormForEdit:", type);
            return;
        }

        // Now, find the component in the correct list using the determined key.
        const component = rigsData.components[componentListKey].find(c => c.id === id);
        // --- END NEW LOGIC ---

        if (!component) {
            console.error("Could not find component with ID:", id, "in list:", componentListKey);
            return; // Exit if the component can't be found.
        }

        // Map internal type 'reducer_extender' to the form's ID 'form-reducer'
        const formType = type === 'reducer_extender' ? 'reducer' : type;
        const form = document.getElementById(`form-${formType}`);

        // Change the form's action to the update route
        form.action = "{{ url_for('update_component') }}";

        // Populate the form fields with the component's data
        form.querySelector('input[name="component_id"]').value = component.id;
        form.querySelector('input[name="name"]').value = component.name;

        if (type === 'telescope') {
            form.querySelector('input[name="aperture_mm"]').value = component.aperture_mm;
            form.querySelector('input[name="focal_length_mm"]').value = component.focal_length_mm;
        } else if (type === 'camera') {
            form.querySelector('input[name="sensor_width_mm"]').value = component.sensor_width_mm;
            form.querySelector('input[name="sensor_height_mm"]').value = component.sensor_height_mm;
            form.querySelector('input[name="pixel_size_um"]').value = component.pixel_size_um;
        } else if (type === 'reducer_extender') {
            form.querySelector('input[name="factor"]').value = component.factor;
        }

        // Update the button text and scroll the form into view
        form.querySelector('button[type="submit"]').textContent = 'Update Component';
        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function populateRigFormForEdit(id) {
        const rig = rigsData.rigs.find(r => r.rig_id === id);
        if (!rig) return;

        const form = document.getElementById('form-rig');
        form.querySelector('input[name="rig_id"]').value = rig.rig_id;
        form.querySelector('input[name="rig_name"]').value = rig.rig_name;
        form.querySelector('select[name="telescope_id"]').value = rig.telescope_id;
        form.querySelector('select[name="camera_id"]').value = rig.camera_id;
        form.querySelector('select[name="reducer_extender_id"]').value = rig.reducer_extender_id || '';
        form.querySelector('button[type="submit"]').textContent = 'Update Rig';
        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function safeNum(v, fallback = null) {
        const n = Number(v);
        return Number.isFinite(n) ? n : fallback;
    }

    function compareBy(a, b, getter, dir = 'asc') {
        const av = getter(a), bv = getter(b);
        // put null/undefined at the end regardless of sort direction
        const aNull = (av === null || av === undefined);
        const bNull = (bv === null || bv === undefined);
        if (aNull && bNull) return 0;
        if (aNull) return 1;
        if (bNull) return -1;

        if (av < bv) return dir === 'asc' ? -1 : 1;
        if (av > bv) return dir === 'asc' ? 1 : -1;
        return 0;
    }

    function sortRigs(rigs, sortValue) {
        const [key, dir] = sortValue.split('-'); // e.g. 'name-asc'
        const getterMap = {
            name: (r) => (r.rig_name || '').toLowerCase(),
            fl:   (r) => safeNum(r.effective_focal_length, null),
            fr:   (r) => safeNum(r.f_ratio, null),
            scale:(r) => safeNum(r.image_scale, null),
            fovw: (r) => safeNum(r.fov_w_arcmin, null),
            recent: (r) => {
                // try to sort by a timestamp if present, else by rig_id string
                // assuming backend might provide `created_at` (ISO) or `updated_at`
                const ts = r.created_at || r.updated_at || '';
                const tnum = Date.parse(ts);
                if (Number.isFinite(tnum)) return tnum;
                // fall back to a stable string key
                return (r.rig_id || '').toString();
            }
        };
        const getter = getterMap[key] || getterMap.name;
        const rigsCopy = rigs.slice(); // do not mutate original
        rigsCopy.sort((a, b) => compareBy(a, b, getter, dir));
        return rigsCopy;
    }

function fetchRigsData() {
  if (rigsDataLoaded) return;
  fetch('/get_rig_data')
    .then(response => response.json())
    .then(data => {
      rigsData = data;

      // use server-provided preference if present
      if (data.sort_preference && typeof data.sort_preference === 'string') {
        rigSort = data.sort_preference;
        localStorage.setItem('rigSort', rigSort);
        const sortSelectEl = document.getElementById('rig-sort');
        if (sortSelectEl) sortSelectEl.value = rigSort;
      }

      renderRigsUI();
      updateSamplingInfo();
      rigsDataLoaded = true;
    })
    .catch(error => console.error("Error fetching rigs data:", error));
}

    function renderRigsUI() {
        const data = rigsData; // Use global data
        if (!data.components) return;

        const { telescopes, cameras, reducers_extenders } = data.components;
        const { rigs } = data;
        // Determine selected sort (from UI if present, else from stored default)
        const sortSelectEl = document.getElementById('rig-sort');
        const currentSort = sortSelectEl ? (sortSelectEl.value || rigSort) : rigSort;
        if (sortSelectEl && sortSelectEl.value !== currentSort) {
            sortSelectEl.value = currentSort;
        }
        const rigsSorted = sortRigs(rigs, currentSort);

        document.getElementById('telescope-list').innerHTML = telescopes.map(t => `
            <li>
                <div class="item-info">${t.name} (${t.aperture_mm}mm / ${t.focal_length_mm}mm)</div>
                <div class="item-actions">
                    <button type="button" class="edit-btn" onclick="populateComponentFormForEdit('telescope', '${t.id}')">Edit</button>
                    <form action="{{ url_for('delete_component') }}" method="post" onsubmit="return confirm('Deleting a component is permanent and cannot be undone. Are you sure?');">
                        <input type="hidden" name="component_id" value="${t.id}">
                        <input type="hidden" name="component_type" value="telescopes">
                        <button type="submit" class="delete-btn">Delete</button>
                    </form>
                </div>
            </li>`).join('') || '<li>No telescopes defined.</li>';

        document.getElementById('camera-list').innerHTML = cameras.map(c => `
            <li>
                <div class="item-info">${c.name} (${c.pixel_size_um}Î¼m pixel)</div>
                <div class="item-actions">
                    <button type="button" class="edit-btn" onclick="populateComponentFormForEdit('camera', '${c.id}')">Edit</button>
                    <form action="{{ url_for('delete_component') }}" method="post" onsubmit="return confirm('Deleting a component is permanent and cannot be undone. Are you sure?');">
                        <input type="hidden" name="component_id" value="${c.id}">
                        <input type="hidden" name="component_type" value="cameras">
                        <button type="submit" class="delete-btn">Delete</button>
                    </form>
                </div>
            </li>`).join('') || '<li>No cameras defined.</li>';

        document.getElementById('reducer-list').innerHTML = reducers_extenders.map(r => `
            <li>
                <div class="item-info">${r.name} (${r.factor}x)</div>
                <div class="item-actions">
                    <button type="button" class="edit-btn" onclick="populateComponentFormForEdit('reducer_extender', '${r.id}')">Edit</button>
                    <form action="{{ url_for('delete_component') }}" method="post" onsubmit="return confirm('Deleting a component is permanent and cannot be undone. Are you sure?');">
                        <input type="hidden" name="component_id" value="${r.id}">
                        <input type="hidden" name="component_type" value="reducers_extenders">
                        <button type="submit" class="delete-btn">Delete</button>
                    </form>
                </div>
            </li>`).join('') || '<li>No reducers defined.</li>';

        const teleSelect = document.getElementById('tele_select');
        const camSelect = document.getElementById('cam_select');
        const redSelect = document.getElementById('red_select');
        if(teleSelect) teleSelect.innerHTML = '<option value="" disabled selected>-- Select a Telescope --</option>' + telescopes.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        if(camSelect) camSelect.innerHTML = '<option value="" disabled selected>-- Select a Camera --</option>' + cameras.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        if(redSelect) redSelect.innerHTML = '<option value="">-- None --</option>' + reducers_extenders.map(r => `<option value="${r.id}">${r.name} (${r.factor}x)</option>`).join('');

        const rigList = document.getElementById('existing-rigs-list');
        rigList.innerHTML = rigsSorted.map(rig => {
            const tele = telescopes.find(t => t.id === rig.telescope_id);
            const cam = cameras.find(c => c.id === rig.camera_id);
            const red = reducers_extenders.find(r => r.id === rig.reducer_extender_id);
            let detailsHtml = `<strong>${rig.rig_name}</strong><br><small>Telescope: ${tele ? tele.name : 'N/A'}<br>Camera: ${cam ? cam.name : 'N/A'}<br>${red ? `Reducer/Extender: ${red.name}` : ''}</small>`;
            if (rig.image_scale) {
                detailsHtml += `<hr style="margin: 0.5em 0; border-color: #f5f5f5;"><small style="color: #666;">Effective FL: ${rig.effective_focal_length.toFixed(0)} mm (f/${rig.f_ratio.toFixed(1)})<br>Image Scale: ${rig.image_scale.toFixed(2)} arcsec/pixel<br>Field of View: ${rig.fov_w_arcmin.toFixed(1)}' x ${rig.fov_h_arcmin.toFixed(1)}'</small>`;
            }
            return `<li data-rig-id="${rig.rig_id}">
                        <div class="item-info">${detailsHtml}</div>
                        <div class="item-actions">
                            <button type="button" class="edit-btn" onclick="populateRigFormForEdit('${rig.rig_id}')">Edit</button>
                            <form action="{{ url_for('delete_rig') }}" method="post" onsubmit="return confirm('Are you sure you want to delete the rig \\'${rig.rig_name}\\'?');">
                                <input type="hidden" name="rig_id" value="${rig.rig_id}">
                                <button type="submit" class="delete-btn">Delete</button>
                            </form>
                        </div>
                    </li>`;
        }).join('') || '<li>No rigs configured yet.</li>';

        document.getElementById('tele-count').innerText = telescopes.length;
        document.getElementById('cam-count').innerText = cameras.length;
        document.getElementById('red-count').innerText = reducers_extenders.length;
        document.getElementById('rig-count').innerText = rigs.length;
    }

    function updateSamplingInfo() {
            const seeingSelect = document.getElementById('seeing-select');
            const selectedSeeing = seeingSelect.value;

            const rigListItems = document.querySelectorAll('#existing-rigs-list li');

            rigListItems.forEach(item => {
                const infoContainer = item.querySelector('.item-info');
                // Remove any old sampling info and tips
                infoContainer.querySelectorAll('.sampling-info, .sampling-binning-tip').forEach(el => el.remove());

                if (selectedSeeing === 'none') return;

                const rigId = item.dataset.rigId;
                const rig = rigsData.rigs.find(r => r.rig_id === rigId);

                if (rig && rig.image_scale) {
                    const imageScale = rig.image_scale;
                    const [seeingLow, seeingHigh] = selectedSeeing.split('-').map(parseFloat);
                    const seeingAvg = (seeingLow + seeingHigh) / 2;

                    // --- Logic for Average Value ---
                    const samplingAvg = seeingAvg / imageScale;

                    // --- More Granular Logic ---
                    let text = '';
                    let colorClass = '';
                    let isOversampled = false;

                    if (samplingAvg > 4.0) {
                        text = `Oversampled: ${samplingAvg.toFixed(1)} px/FWHM`;
                        colorClass = 'sampling-oversampled';
                        isOversampled = true;
                    } else if (samplingAvg > 3.0) {
                        text = `Slightly Oversampled: ${samplingAvg.toFixed(1)} px/FWHM`;
                        colorClass = 'sampling-slightly-oversampled';
                        isOversampled = true;
                    } else if (samplingAvg >= 1.0) {
                        text = `Good Sampling: ${samplingAvg.toFixed(1)} px/FWHM`;
                        colorClass = 'sampling-good';
                    } else if (samplingAvg >= 0.67) {
                        text = `Slightly Undersampled: ${samplingAvg.toFixed(1)} px/FWHM`;
                        colorClass = 'sampling-slightly-undersampled';
                    } else {
                        text = `Undersampled: ${samplingAvg.toFixed(1)} px/FWHM`;
                        colorClass = 'sampling-undersampled';
                    }

                    // Create and append the main info element
                    const infoEl = document.createElement('span');
                    infoEl.className = `sampling-info ${colorClass}`;
                    infoEl.textContent = text;
                    infoContainer.appendChild(infoEl);

                    // --- Binning Suggestion Logic ---
                    if (isOversampled) {
                        const binningEl = document.createElement('small');
                        binningEl.className = 'sampling-binning-tip';
                        const binnedScale = (imageScale * 2).toFixed(2);
                        const binnedSampling = (samplingAvg / 2).toFixed(1);
                        binningEl.textContent = `Tip: 2x2 binning would yield ~${binnedScale}"/px (${binnedSampling} px/FWHM)`;
                        infoContainer.appendChild(binningEl);
                    }
                }
            });
        }

    // --- General Page Logic ---
    function confirmAndFetchDetails(formElement) {
        const numObjects = {{ config.objects|length if config and config.objects is defined else 0 }};
        let estimatedTime = numObjects * 0.6;
        let confirmationMessage = "Fetching all missing object details (Type, Magnitude, Size, SB) can take some time.\n";
        if (numObjects > 0) {
            confirmationMessage += `With ${numObjects} object(s), this might take around ${estimatedTime.toFixed(0)} seconds.\n`;
        }
        confirmationMessage += "Only fields currently empty or marked 'N/A' or 'Fetch Error' will be updated.\nAre you sure you want to proceed?";
        if (confirm(confirmationMessage)) {
            const messageContainer = document.getElementById('message-container');
            const button = document.getElementById('fetch-details-button');
            if (button) {
                button.disabled = true;
                button.innerText = 'Processing... Please Wait';
            }
            if (messageContainer) {
                const existingError = document.getElementById('error-msg');
                const existingFlash = document.getElementById('flash-msg');
                if (existingError) existingError.remove();
                if (existingFlash) existingFlash.remove();
                let progressText = `Fetching details for up to ${numObjects} object(s). The page will reload upon completion.`;
                messageContainer.innerHTML = `<p class="progress-message">${progressText}</p>`;
            }
            requestAnimationFrame(() => {
                requestAnimationFrame(() => formElement.submit());
            });
        }
    }

    // --- Main Initializer ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- Anonymous telemetry client ping (once per 24h in this browser) ---
        try {
          const TELEMETRY_KEY = 'novaTelemetryPingAt';
          const lastPing = parseInt(localStorage.getItem(TELEMETRY_KEY) || '0', 10);
          const now = Date.now();
          const DAY_MS = 24*60*60*1000;
          const telemetryEnabled = {{ 'true' if config.get('telemetry', {}).get('enabled', True) else 'false' }};
          if (telemetryEnabled && (!Number.isFinite(lastPing) || (now - lastPing) > DAY_MS)) {
            fetch('/telemetry/ping', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ browser_user_agent: navigator.userAgent || '', force: true })
            }).then(() => {
              localStorage.setItem(TELEMETRY_KEY, String(now));
            }).catch(() => {/* ignore errors */});
          }
        } catch (e) { /* ignore */ }
        // --- Telemetry test button logic ---
        const testTelemetryBtn = document.getElementById('test-telemetry');
        if (testTelemetryBtn) {
          testTelemetryBtn.addEventListener('click', () => {
            fetch('/telemetry/ping', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ browser_user_agent: navigator.userAgent || '', force: true })
            })
            .then(resp => resp.json())
            .then(data => {
              alert("Telemetry test sent.\nStatus: " + (data.status || 'unknown'));
            })
            .catch(err => {
              alert("Telemetry test failed: " + err.message);
            });
          });
        }
        // --- Tab Management ---
        const tabs = document.querySelectorAll('.tab-button');
        const contentPanels = {
            general: document.getElementById('general-tab-content'),
            locations: document.getElementById('locations-tab-content'),
            objects: document.getElementById('objects-tab-content'),
            rigs: document.getElementById('rigs-tab-content')
        };
        let activeTab = localStorage.getItem('activeConfigTab') || 'general';

        const seeingSelect = document.getElementById('seeing-select');
        if (seeingSelect) {
            seeingSelect.addEventListener('change', updateSamplingInfo);
        }

        function updateTabDisplay() {
            Object.values(contentPanels).forEach(panel => {
                if(panel) panel.style.display = 'none';
            });
            tabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === activeTab);
            });
            if (contentPanels[activeTab]) {
                contentPanels[activeTab].style.display = 'block';
            }
            if (activeTab === 'rigs') {
                fetchRigsData();
            }
            localStorage.setItem('activeConfigTab', activeTab);
        }
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                activeTab = tab.dataset.tab;
                updateTabDisplay();
            });
        });
        updateTabDisplay(); // Initial call

      const rigSortEl = document.getElementById('rig-sort');
      if (rigSortEl && rigSortEl.value !== rigSort) {
        rigSortEl.value = rigSort;
      }

      if (rigSortEl) {
        rigSortEl.addEventListener('change', () => {
          rigSort = rigSortEl.value;
          localStorage.setItem('rigSort', rigSort);
          fetch('/set_rig_sort_preference', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sort: rigSort })
          }).catch(err => console.error("Could not save sort preference:", err));

          if (rigsDataLoaded) {
            renderRigsUI();
            updateSamplingInfo();
          }
        });
      }

        // --- Message Fader ---
        setTimeout(() => {
            const messageContainer = document.getElementById('message-container');
            if (messageContainer && !messageContainer.querySelector('.progress-message')) {
                document.querySelectorAll(".flash-transient").forEach(el => {
                    el.style.transition = "opacity 0.5s ease";
                    el.style.opacity = "0";
                    setTimeout(() => el.remove(), 500);
                });
            }
        }, 3000);

        // --- Fetch Details Logic ---
        const fetchDetailsForm = document.getElementById('fetch-details-form');
        if (fetchDetailsForm) {
            fetchDetailsForm.addEventListener('submit', function(event) {
                event.preventDefault();
                confirmAndFetchDetails(this);
            });
        }

        // --- Add Object Form Logic ---
        const resultDiv = document.getElementById('object_result');
        const submitNewObjectBtn = document.getElementById('submit_new_object');
        const confirmAddObjectBtn = document.getElementById('confirm_add_object');
        const editObjectBtn = document.getElementById('edit_object');
        if (submitNewObjectBtn) {
            submitNewObjectBtn.addEventListener('click', function(event) {
                // ... (add object search logic is unchanged)
                event.preventDefault();
                const objectName = document.getElementById('new_object').value.trim();
                if (!objectName) { alert("Please enter an object identifier."); return; }
                resultDiv.innerHTML = '<p class="progress-message">Searching SIMBAD, please wait...</p>';
                fetch("{{ url_for('search_object') }}", {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ object: objectName })
                })
                .then(r => r.json())
                .then(data => {
                  if (data.status !== "success") throw new Error(data.message || 'SIMBAD lookup failed');
                  document.getElementById('new_name').value    = data.data["Common Name"];
                  document.getElementById('new_ra').value      = data.data["RA (hours)"];
                  document.getElementById('new_dec').value     = data.data["DEC (degrees)"];
                  document.getElementById('new_constellation').value = data.data["Constellation"] || '';
                  ['new_name', 'new_ra', 'new_dec'].forEach(id => document.getElementById(id).readOnly = true);
                  resultDiv.innerHTML = `<p class="message">Found: ${data.data["Common Name"]} (RA: ${data.data["RA (hours)"]}, DEC: ${data.data["DEC (degrees)"]})</p>`;
                  return fetch("{{ url_for('fetch_object_details') }}", {
                      method: 'POST', headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ object: objectName })
                  });
                })
                .then(r => r.json())
                .then(extra => {
                  if (extra.status === 'success') {
                      document.getElementById('new_type').value      = extra.data.Type      || '';
                      document.getElementById('new_magnitude').value = extra.data.Magnitude || '';
                      document.getElementById('new_size').value      = extra.data.Size      || '';
                      document.getElementById('new_sb').value        = extra.data.SB        || '';
                  } else { console.warn("Extra fields error:", extra.message); }
                  ['confirm_add_object', 'edit_object'].forEach(id => document.getElementById(id).style.display = 'inline-block');
                  submitNewObjectBtn.style.display = 'none';
                })
                .catch(err => { resultDiv.innerHTML = `<p class="error">Error: ${err.message}</p>`; console.error(err); });
            });
        }
        if (confirmAddObjectBtn) {
            // ... (confirm add object logic is unchanged)
            confirmAddObjectBtn.addEventListener('click', function(event) {
                event.preventDefault();
                const payload = {
                    object: document.getElementById('new_object').value.trim(),
                    name: document.getElementById('new_name').value.trim(),
                    ra: document.getElementById('new_ra').value.trim(),
                    dec: document.getElementById('new_dec').value.trim(),
                    project: document.getElementById('new_project').value.trim(),
                    type: document.getElementById('new_type').value.trim(),
                    magnitude: document.getElementById('new_magnitude').value,
                    size: document.getElementById('new_size').value,
                    constellation: document.getElementById('new_constellation').value.trim(),
                    sb: document.getElementById('new_sb').value
                };
                fetch("{{ url_for('confirm_object') }}", {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                })
                .then(response => response.json()).then(data => {
                if (data.status === "success") {
                    resultDiv.innerHTML = `<p class="message">Object added successfully. Page will reload.</p>`;
                    setTimeout(() => window.location.reload(), 1500);
                } else { throw new Error(data.message || 'Add failed'); }
                })
                .catch(err => { resultDiv.innerHTML = `<p class="error">Error: ${err.message}</p>`; console.error(err); });
            });
        }
        if (editObjectBtn) {
            // ... (edit object logic is unchanged)
            editObjectBtn.addEventListener('click', function(event) {
                event.preventDefault();
                ['new_name', 'new_ra', 'new_dec', 'new_type', 'new_magnitude', 'new_size', 'new_sb', 'new_project'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.readOnly = false;
                });
                document.getElementById('new_object').readOnly = false;
            });
        }

        // --- Dropdown Menu & Import Logic ---
        document.querySelectorAll('.dropdown-btn').forEach(button => {
            button.addEventListener('click', function(event) {
                document.querySelectorAll('.dropdown-content.show').forEach(openDropdown => {
                    if (openDropdown !== this.nextElementSibling) openDropdown.classList.remove('show');
                });
                this.nextElementSibling.classList.toggle('show');
                event.stopPropagation();
            });
        });
        window.addEventListener('click', function(event) {
            if (!event.target.matches('.dropdown-btn')) {
                document.querySelectorAll('.dropdown-content.show').forEach(openDropdown => {
                    openDropdown.classList.remove('show');
                });
            }
        });

        const importConfigBtn = document.getElementById('import-config-btn');
        const configUploadInput = document.getElementById('config-upload');
        if (importConfigBtn && configUploadInput) {
            importConfigBtn.addEventListener('click', event => {
                event.preventDefault();
                if (confirm("This will overwrite your current configuration. Your existing configuration will be backed up. Are you sure?")) {
                    configUploadInput.click();
                }
            });
            configUploadInput.addEventListener('change', function () {
                if (!this.files[0]) return;
                const formData = new FormData();
                formData.append("file", this.files[0]);
                fetch("{{ url_for('import_config') }}", { method: "POST", body: formData })
                  .then(resp => {
                      if (resp.ok && resp.redirected) window.location.href = resp.url;
                      else return resp.text().then(text => { throw new Error(text || 'Import failed') });
                  })
                  .catch(err => alert("Config import failed: " + err.message))
                  .finally(() => { this.value = ""; });
            });
        }

        const importJournalBtn = document.getElementById('import-journal-btn');
        const journalUploadInput = document.getElementById('journal-upload');
        if (importJournalBtn && journalUploadInput) {
            importJournalBtn.addEventListener('click', event => {
                event.preventDefault();
                if (confirm("This will overwrite your current journal. Your existing journal will be backed up. Are you sure?")) {
                    journalUploadInput.click();
                }
            });
            journalUploadInput.addEventListener('change', function () {
                if (!this.files[0]) return;
                const formData = new FormData();
                formData.append("file", this.files[0]);
                fetch("{{ url_for('import_journal') }}", { method: "POST", body: formData })
                  .then(resp => {
                      if (resp.ok && resp.redirected) window.location.href = resp.url;
                      else return resp.text().then(text => { throw new Error(text || 'Import failed') });
                  })
                  .catch(err => alert("Journal import failed: " + err.message))
                  .finally(() => { this.value = ""; });
            });
        }

        const importRigsBtn = document.getElementById('import-rigs-btn');
        const rigsUploadInput = document.getElementById('rigs-upload');
        if (importRigsBtn && rigsUploadInput) {
            importRigsBtn.addEventListener('click', event => {
                event.preventDefault();
                if (confirm("This will overwrite your current rigs file. The existing file will be backed up. Are you sure?")) {
                    rigsUploadInput.click();
                }
            });
            rigsUploadInput.addEventListener('change', function () {
                if (!this.files[0]) return;
                const formData = new FormData();
                formData.append("file", this.files[0]);
                fetch("{{ url_for('import_rig_config') }}", { method: "POST", body: formData })
                  .then(resp => {
                      if (resp.ok && resp.redirected) window.location.href = resp.url;
                      else return resp.json().then(err => { throw new Error(err.message || 'Import failed') });
                  })
                  .catch(err => alert("Rigs import failed: " + err.message))
                  .finally(() => { this.value = ""; });
            });
        }
    });
  </script>
{% endblock %}
</body>
</html>