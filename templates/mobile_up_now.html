{% extends "mobile_base.html" %}

{% block title %}Up Now{% endblock %}
{% block header_title %}Up Now{% endblock %}

{% block head %}
<style>
    /* --- Search Bar --- */
    .search-bar {
        padding: 10px 20px 0 20px;
    }
    .search-bar input {
        width: 100%;
        padding: 12px;
        font-size: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        box-sizing: border-box; /* Important */
    }

    /* --- Sort Bar --- */
    .sort-bar {
        display: grid; /* Use grid for 3 buttons */
        grid-template-columns: 1fr 1fr 1fr; /* 3 equal columns */
        gap: 8px; /* A little less gap */
        padding: 10px 20px 0 20px;
    }
    .sort-button {
        padding: 10px;
        font-size: 0.9rem;
        border: 1px solid var(--border-color);
        background-color: var(--card-bg);
        border-radius: 5px;
        text-align: center;
        color: var(--text-color); /* Fixes blue font color */
    }
    .sort-button.active {
        background-color: var(--primary-dark);
        color: white;
        border-color: var(--primary-dark);
    }
</style>
{% endblock %}

{% block content %}
    <div class="search-bar">
        <input type="text" id="search-input" placeholder="Search by name (e.g., M42 or Orion)...">
    </div>

    <div class="sort-bar">
        <button class="sort-button active" id="sort-alt">Sort by Altitude</button>
        <button class="sort-button" id="sort-dur">Sort by Duration</button>
        <button class="sort-button" id="filter-active">Active Only</button>
    </div>

    <ul class="item-list" id="object-list" style="margin-top: 15px;">

        {% if objects_data %}
            {% for obj in objects_data %}
                <li class="item-card"
                    data-sort-alt="{{ obj['Altitude Current'] | float }}"
                    data-sort-dur="{{ obj['Observable Duration (min)'] | int }}"
                    data-is-active="{{ 'true' if obj.ActiveProject else 'false' }}"
                    data-search-text="{{ obj['Common Name'].lower() }} {{ obj['Object'].lower() }}">

                    {% set editUrl = url_for('mobile_edit_notes', object_name=obj.Object) %}
                    <a href="{{ editUrl }}" class="edit-button">Edit</a>

                    <h3>{{ obj['Common Name'] }} ({{ obj['Object'] }})</h3>

                    <div class="item-card-grid">
                        <div><strong>Altitude:</strong> {{ obj['Altitude Current'] }}째 {{ obj['Trend'] }}</div>
                        <div><strong>Azimuth:</strong> {{ obj['Azimuth Current'] }}째</div>
                        <div><strong>Max Alt:</strong> {{ obj['Max Altitude (째)'] }}째</div>
                        {% if obj['Observable Duration (min)'] == 0 %}
                            <div><strong>Duration:</strong> Not visible</div>
                        {% else %}
                            <div><strong>Duration:</strong> {{ obj['Observable Duration (min)'] }} min</div>
                        {% endif %}
                    </div>
                </li>
            {% endfor %}
        {% endif %}
        <li class="message" id="loading-indicator" style="display: none;">
            No objects found.
        </li>
    </ul>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const list = document.getElementById('object-list');
        const sortAltButton = document.getElementById('sort-alt');
        const sortDurButton = document.getElementById('sort-dur');
        const filterActiveButton = document.getElementById('filter-active');
        const searchInput = document.getElementById('search-input'); // <-- ADDED

        // Get all list items. They are already in the DOM.
        const allItems = Array.from(list.querySelectorAll('.item-card'));
        const noObjectsMessage = document.getElementById('loading-indicator');

        let currentSort = 'alt';
        let filterActive = false;
        let currentSearch = ''; // <-- ADDED

        function renderList() {
            // 1. Apply Search Filter first
            let searchedItems = [];
            if (currentSearch === '') {
                searchedItems = [...allItems];
            } else {
                searchedItems = allItems.filter(item => {
                    // Check our new data attribute
                    return item.dataset.searchText.includes(currentSearch);
                });
            }

            // 2. Apply Active Filter to the *searched* results
            let itemsToShow = [];
            if (filterActive) {
                itemsToShow = searchedItems.filter(item => item.dataset.isActive === 'true');
            } else {
                itemsToShow = [...searchedItems];
            }

            // 3. Apply Sort to the final list
            if (currentSort === 'alt') {
                itemsToShow.sort((a, b) => {
                    return parseFloat(b.dataset.sortAlt) - parseFloat(a.dataset.sortAlt);
                });
                sortAltButton.classList.add('active');
                sortDurButton.classList.remove('active');
            } else { // 'dur'
                itemsToShow.sort((a, b) => {
                    return parseFloat(b.dataset.sortDur) - parseFloat(a.dataset.sortDur);
                });
                sortDurButton.classList.add('active');
                sortAltButton.classList.remove('active');
            }

            // 4. Update DOM (hide all, then show the ones that passed)
            allItems.forEach(item => item.style.display = 'none');

            itemsToShow.forEach(item => {
                item.style.display = 'block';
                list.appendChild(item); // This re-orders them in the list
            });

            // 5. Update the "No objects" message
            if (noObjectsMessage) {
                if (allItems.length === 0) {
                    noObjectsMessage.textContent = "No objects found. Try adding one!";
                    noObjectsMessage.style.display = 'block';
                } else if (itemsToShow.length === 0) {
                    // Show a different message if it's due to search vs. filter
                    if (searchedItems.length === 0) {
                        noObjectsMessage.textContent = "No objects match your search.";
                    } else {
                        noObjectsMessage.textContent = "No objects match your filter.";
                    }
                    noObjectsMessage.style.display = 'block';
                } else {
                    noObjectsMessage.style.display = 'none';
                }
            }

            // 6. Update filter button state
            filterActiveButton.classList.toggle('active', filterActive);
        }

        // --- Click/Input Listeners ---

        // ADDED: Listen for typing in the search box
        searchInput.addEventListener('input', () => {
            currentSearch = searchInput.value.trim().toLowerCase();
            renderList();
        });

        sortAltButton.addEventListener('click', () => {
            if (currentSort !== 'alt') {
                currentSort = 'alt';
                renderList();
            }
        });

        sortDurButton.addEventListener('click', () => {
            if (currentSort !== 'dur') {
                currentSort = 'dur';
                renderList();
            }
        });

        filterActiveButton.addEventListener('click', () => {
            filterActive = !filterActive; // Toggle the filter state
            renderList(); // Re-render the list
        });

        // --- Initial Render ---
        // Run once on load to apply default sort and hide/show message
        renderList();
    });
</script>
{% endblock %}