{% extends "mobile_base.html" %}

{% block title %}Up Now{% endblock %}
{% block header_title %}Up Now{% endblock %}

{% block head %}
<style>
    /* --- Search Bar --- */
    .search-bar {
        padding: 10px 20px 0 20px;
    }
    .search-bar input {
        width: 100%;
        padding: 12px;
        font-size: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        box-sizing: border-box;
    }

    /* --- Sort Bar --- */
    .sort-bar {
        display: flex;
        gap: 8px;
        padding: 10px 20px 0 20px;
    }
    .sort-button {
        flex: 1; /* Equal width */
        padding: 10px 5px; /* Reduced horizontal padding for small screens */
        font-size: 0.85rem; /* Slightly smaller font */
        white-space: nowrap; /* Prevent text wrap */
        overflow: hidden;
        text-overflow: ellipsis; /* Handle overflow gracefully */
        border: 1px solid var(--border-color);
        background-color: var(--card-bg);
        border-radius: 5px;
        text-align: center;
        color: var(--text-color);
    }
    .sort-button {
        padding: 10px;
        font-size: 0.9rem;
        border: 1px solid var(--border-color);
        background-color: var(--card-bg);
        border-radius: 5px;
        text-align: center;
        color: var(--text-color);
    }
    .sort-button.active {
        background-color: var(--primary-dark);
        color: var(--text-white);
        border-color: var(--primary-dark);
    }

    /* ASIAIR Button Style */
    .asiair-btn {
        background-color: var(--primary-dark);
        color: var(--text-white);
        padding: 6px 10px;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.8rem;
        font-weight: bold;
    }

    /* Container to fix overlap */
    .card-actions {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        gap: 8px;
        align-items: center;
    }

    /* Reset individual positioning */
    .item-card .edit-button {
        position: static;
        float: none;
        margin: 0;
    }
</style>
{% endblock %}

{% block content %}
    <div id="mobile-loading" style="padding: 20px; text-align: center;">
        <div style="font-weight: bold; color: var(--primary-dark); margin-bottom: 10px;">Scanning Sky...</div>
        <div style="width: 100%; height: 8px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden;">
            <div id="progress-fill" style="width: 0%; height: 100%; background: var(--primary-dark); transition: width 0.3s ease;"></div>
        </div>
        <small id="loading-text" style="display: block; margin-top: 8px; color: var(--text-muted);">Initializing...</small>
    </div>

    <div class="search-bar">
        <input type="text" id="search-input" placeholder="Search by name (e.g., M42 or Orion)...">
    </div>

    <div class="sort-bar">
        <button class="sort-button active" id="sort-alt">Altitude</button>
        <button class="sort-button" id="sort-dur">Duration</button>
        <button class="sort-button" id="filter-active">Active</button>
        <button class="sort-button" id="filter-framing">Framing</button>
    </div>

    <ul class="item-list" id="object-list" style="margin-top: 15px; display: none;">
        <li class="message" id="loading-indicator" style="display: none;">
            No objects found.
        </li>
    </ul>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const list = document.getElementById('object-list');
        const loadingContainer = document.getElementById('mobile-loading');
        const progressFill = document.getElementById('progress-fill');
        const loadingText = document.getElementById('loading-text');

        const sortAltButton = document.getElementById('sort-alt');
        const sortDurButton = document.getElementById('sort-dur');
        const filterActiveButton = document.getElementById('filter-active');
        const filterFramingButton = document.getElementById('filter-framing');
        const searchInput = document.getElementById('search-input');

        const noObjectsMessage = document.getElementById('loading-indicator');

        // Items are now stored here after fetching
        let allItems = [];

        let currentSort = 'alt';
        let filterActive = false;
        let filterFraming = false;
        let currentSearch = '';

        function renderList() {
            // 1. Apply Search Filter
            let searchedItems = [];
            if (currentSearch === '') {
                searchedItems = [...allItems];
            } else {
                searchedItems = allItems.filter(item => {
                    return item.dataset.searchText.includes(currentSearch);
                });
            }

            // 2. Apply Filters
            let itemsToShow = [...searchedItems];

            if (filterActive) {
                itemsToShow = itemsToShow.filter(item => item.dataset.isActive === 'true');
            }

            if (filterFraming) {
                itemsToShow = itemsToShow.filter(item => item.dataset.hasFraming === 'true');
            }

            // 3. Apply Sort
            if (currentSort === 'alt') {
                itemsToShow.sort((a, b) => {
                    return parseFloat(b.dataset.sortAlt) - parseFloat(a.dataset.sortAlt);
                });
                sortAltButton.classList.add('active');
                sortDurButton.classList.remove('active');
            } else { // 'dur'
                itemsToShow.sort((a, b) => {
                    return parseFloat(b.dataset.sortDur) - parseFloat(a.dataset.sortDur);
                });
                sortDurButton.classList.add('active');
                sortAltButton.classList.remove('active');
            }

            // 4. Update DOM
            allItems.forEach(item => item.style.display = 'none'); // Hide all first

            itemsToShow.forEach(item => {
                item.style.display = 'block';
                list.appendChild(item); // Re-append in order
            });

            // 5. Update Message
            if (noObjectsMessage) {
                if (allItems.length === 0) {
                    // If fetch is done but no items at all
                    noObjectsMessage.textContent = "No objects found. Try adding one!";
                    noObjectsMessage.style.display = 'block';
                } else if (itemsToShow.length === 0) {
                    if (searchedItems.length === 0) {
                        noObjectsMessage.textContent = "No objects match your search.";
                    } else {
                        noObjectsMessage.textContent = "No objects match your filter.";
                    }
                    noObjectsMessage.style.display = 'block';
                } else {
                    noObjectsMessage.style.display = 'none';
                }
            }

            // 6. Update Buttons
            filterActiveButton.classList.toggle('active', filterActive);
            filterFramingButton.classList.toggle('active', filterFraming);
        }

        // --- Event Listeners ---
        searchInput.addEventListener('input', () => {
            currentSearch = searchInput.value.trim().toLowerCase();
            renderList();
        });

        sortAltButton.addEventListener('click', () => {
            if (currentSort !== 'alt') {
                currentSort = 'alt';
                renderList();
            }
        });

        sortDurButton.addEventListener('click', () => {
            if (currentSort !== 'dur') {
                currentSort = 'dur';
                renderList();
            }
        });

        filterActiveButton.addEventListener('click', () => {
            filterActive = !filterActive;
            renderList();
        });

        filterFramingButton.addEventListener('click', () => {
            filterFraming = !filterFraming;
            renderList();
        });

        // --- Chunked Data Fetching & Caching ---
        const CHUNK_SIZE = 5;

        // Cache key includes location to ensure data matches selected site
        const activeLoc = sessionStorage.getItem('nova_mobile_location') || 'default';
        const CACHE_KEY = `nova_mobile_cache_${activeLoc}`;
        const CACHE_EXPIRY = 5 * 60 * 1000; // 5 Minutes

        async function fetchMobileData() {
            // 1. Try loading from Cache first
            const cachedRaw = sessionStorage.getItem(CACHE_KEY);
            if (cachedRaw) {
                try {
                    const cached = JSON.parse(cachedRaw);
                    // Check if cache is fresh (less than 5 mins old)
                    if (Date.now() - cached.timestamp < CACHE_EXPIRY) {
                        // Restore from cache
                        loadingContainer.style.display = 'none';
                        list.style.display = 'block';

                        cached.data.forEach(obj => createListItem(obj));
                        refreshListItemsAndSort();
                        return; // Exit early, no fetching needed
                    }
                } catch (e) { console.warn("Cache parse failed, fetching fresh."); }
            }

            // 2. Fetch Fresh Data (if no cache or expired)
            let offset = 0;
            let total = 1;
            let gatheredData = []; // Store data here to save to cache later

            loadingContainer.style.display = 'block';
            list.style.display = 'none';

            try {
                while (offset < total) {
                    const response = await fetch(`{{ url_for('api.api_mobile_data_chunk') }}?offset=${offset}&limit=${CHUNK_SIZE}`);
                    const json = await response.json();

                    if (!json.data) break;

                    total = json.total;

                    json.data.forEach(obj => {
                        createListItem(obj);
                        gatheredData.push(obj); // Add to cache array
                    });

                    offset += CHUNK_SIZE;
                    const percentage = Math.min(100, Math.round((offset / total) * 100));
                    progressFill.style.width = `${percentage}%`;
                    loadingText.textContent = `Calculated ${Math.min(offset, total)} of ${total} objects...`;
                }

                // Save to Session Storage
                try {
                    sessionStorage.setItem(CACHE_KEY, JSON.stringify({
                        timestamp: Date.now(),
                        data: gatheredData
                    }));
                } catch (e) { console.warn("Cache save failed (quota?)", e); }

                setTimeout(() => {
                    loadingContainer.style.display = 'none';
                    list.style.display = 'block';
                    refreshListItemsAndSort();
                }, 500);

            } catch (e) {
                loadingText.textContent = "Error loading data.";
                console.error(e);
            }
        }

        function createListItem(obj) {
            const li = document.createElement('li');
            li.className = 'item-card';

            li.dataset.sortAlt = parseFloat(obj['Altitude Current']) || 0;
            li.dataset.sortDur = parseInt(obj['Observable Duration (min)']) || 0;
            li.dataset.isActive = obj.ActiveProject ? 'true' : 'false';
            li.dataset.hasFraming = obj.has_framing ? 'true' : 'false';
            li.dataset.searchText = (obj['Common Name'] + ' ' + obj['Object']).toLowerCase();
            li.style.display = 'block';

            // Construct URLs
            const safeObj = encodeURIComponent(obj.Object);
            const baseEditUrl = "{{ url_for('mobile.mobile_edit_notes', object_name='__OBJ__') }}";
            const editUrl = baseEditUrl.replace('__OBJ__', safeObj);

            const baseMosaicUrl = "{{ url_for('mobile.mobile_mosaic_view', object_name='__OBJ__') }}";
            // Append source param
            const mosaicUrl = baseMosaicUrl.replace('__OBJ__', safeObj) + "?from=up_now";

            let durHtml = `<div><strong>Duration:</strong> ${obj['Observable Duration (min)']} min</div>`;
            if (obj['Observable Duration (min)'] == 0) {
                durHtml = `<div><strong>Duration:</strong> Not visible</div>`;
            }

            let actionsHtml = `<a href="${editUrl}" class="edit-button">Edit</a>`;

            // Only show ASIAIR button if framing exists
            if (obj.has_framing) {
                actionsHtml = `<a href="${mosaicUrl}" class="asiair-btn">Framing</a>` + actionsHtml;
            }

            li.innerHTML = `
                <div class="card-actions">
                    ${actionsHtml}
                </div>
                <h3 style="margin-right: 130px;">${obj['Common Name']} (${obj['Object']})</h3>
                <div class="item-card-grid">
                    <div><strong>Altitude:</strong> ${obj['Altitude Current']}째 ${obj['Trend']}</div>
                    <div><strong>Azimuth:</strong> ${obj['Azimuth Current']}째</div>
                    <div><strong>Max Alt:</strong> ${obj['Max Altitude (째)']}째</div>
                    ${durHtml}
                </div>
            `;

            list.appendChild(li);
        }

        function refreshListItemsAndSort() {
            // Grab the newly created elements from DOM and put them in our array
            const currentItems = Array.from(list.querySelectorAll('.item-card'));
            allItems = currentItems;
            renderList();
        }

        // Start the process
        fetchMobileData();
    });
</script>
{% endblock %}