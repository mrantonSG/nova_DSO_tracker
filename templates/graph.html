<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Altitude Graph - {{ object_name }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: left;
            padding: 20px;
            margin: 0;
        }
        h2 {
            margin-left: 0;
            font-size: 20px;
        }
        img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: 0px 0px 0px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        p {
            margin-left: 0;
        }
        .button-container {
            margin-top: 20px;
        }
        .inline-button {
            background-color: #83b4c5;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            padding: 10px 20px;
            font-size: 16px;
            margin-right: 10px;
        }
        .inline-button:hover {
            background-color: #6795a4;
        }
        #project-field {
            width: 100%;
            max-width: 1000px;
            height: 150px;
            box-sizing: border-box;
        }
    </style>
    <script>
      function saveProject() {
        const newProject = document.getElementById('project-field').value;
        fetch('/update_project', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ object: "{{ object_name }}", project: newProject })
        }).then(res => res.json()).then(data => {
          alert(data.status === "success" ? "Project updated successfully!" : data.error);
        });
      }

      function toggleSimbad() {
        var container = document.getElementById('simbadContainer');
        if (container.style.display === 'none' || container.style.display === '') {
          document.getElementById('simbadIframe').src = "https://simbad.u-strasbg.fr/simbad/sim-id?Ident={{ object_name }}";
          container.style.display = 'block';
        } else {
          container.style.display = 'none';
        }
      }

      function openInStellarium() {
        const stellariumStatusDiv = document.getElementById('stellarium-status');
        stellariumStatusDiv.textContent = "Sending object to Stellarium...";

        fetch("/proxy_focus", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ target: "{{ object_name }}", mode: "center" })
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === "success") {
            stellariumStatusDiv.textContent = "Stellarium view updated successfully!";
            stellariumStatusDiv.style.color = "#83b4c5";
          } else {
            stellariumStatusDiv.textContent = "Error updating Stellarium: " + data.message;
            stellariumStatusDiv.style.color = "red";
          }
        })
        .catch(error => {
          stellariumStatusDiv.textContent = "Error communicating with Stellarium.";
          stellariumStatusDiv.style.color = "red";
          console.error("Communication error:", error);
        });
      }

      document.addEventListener("DOMContentLoaded", function() {
        document.getElementById('open-in-stellarium').addEventListener('click', openInStellarium);
      });
    </script>
</head>

<body>
    <a href="{{ url_for('static', filename=filename) }}?t={{ timestamp }}" target="_blank">
        <img src="{{ url_for('static', filename=filename) }}?t={{ timestamp }}" alt="Altitude graph of {{ object_name }}">
    </a>

    <div class="button-container">
      <textarea id="project-field">{{ project }}</textarea>
      <br>
      <button class="inline-button" onclick="window.top.location.href='{{ url_for('index') }}'">Back to Tracker</button>
      <button class="inline-button" onclick="saveProject()">Save Project</button>
      <button class="inline-button" onclick="toggleSimbad()">Toggle SIMBAD Info</button>
      <button id="open-in-stellarium" class="inline-button">Open in Stellarium</button>
    </div>

    <div id="stellarium-status" style="margin-top: 10px; color: #666;"></div>

    <div id="simbadContainer" style="display:none; margin-top:20px;">
      <iframe id="simbadIframe" style="width:100%; height:1200px; border:1px solid #ddd;"></iframe>
    </div>
</body>
</html>