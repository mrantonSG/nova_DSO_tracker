{% extends "base.html" %}

{% block title %}DSO Altitude Tracker{% endblock %}

{% block head_extra %}
  <script src="{{ url_for('static', filename='js/plotly-2.27.0.min.js') }}" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">

  <script>
    // Configuration object for dashboard JavaScript
    window.NOVA_INDEX = {
      isGuest: {{ is_guest | tojson }},
      hideInvisible: {{ hide_invisible | tojson }},
      journalSessions: {{ journal_sessions | tojson | safe }},
      altitudeThreshold: {{ g.altitude_threshold | default(20) }}
    };
  </script>

  <script src="{{ url_for('static', filename='js/dashboard.js') }}" defer></script>
{% endblock %}

{% block page_title %}
    <h2>Dashboard <span id="simulated-title-text" style="display: none; color: var(--danger-color-darker); font-weight: normal;">- Simulated</span></h2>
{% endblock %}

{% block header_actions %}
    {% if SINGLE_USER_MODE or not is_guest %}
       <button class="action-button" onclick="window.location.href='{{ url_for('core.config_form') }}'">Configuration</button>
    {% endif %}
{% endblock %}

{% block header_content %}
<div class="status-strip">
    <div class="status-item" style="min-width: 150px;">
        <span class="status-label">Location</span>
        <select id="location-select"></select>
    </div>
    <div class="status-item">
        <span class="status-label">Local Time</span>
        <span class="status-value"><span id="date"></span> <span id="time" style="margin-left:5px;"></span></span>
    </div>
    <div class="status-item">
        <span class="status-label">Moon</span>
        <span class="status-value" id="phase">--%</span>
    </div>
    <div class="status-item">
        <span class="status-label">Astr. Dusk / Dawn</span>
        <span class="status-value"><span id="dusk">--:--</span> <span style="color:var(--text-light); margin:0 5px;">|</span> <span id="dawn">--:--</span></span>
    </div>
    <div class="status-item" id="simulation-controls">
        <div style="display: flex; align-items: center; gap: 8px;">
            <input type="date" id="sim-date-input" disabled style="height: 30px; font-size: 14px; padding: 2px 5px;">
            <label class="switch">
                <input type="checkbox" id="sim-mode-toggle">
                <span class="slider round"></span>
            </label>
        </div>
        <div style="display: flex; align-items: center;">
            <label for="sim-mode-toggle" class="status-label" style="cursor:pointer; margin-left: 8px;">Simulation</label>
            <span class="help-badge" data-help-topic="simulation_mode" title="About Simulation Mode" style="margin-left: 5px; cursor: pointer;">?</span>
        </div>
    </div>
    <div class="status-item" style="margin-left: auto;">
        <span class="status-label">Update</span>
        <span class="status-value" id="next-update-timer" style="color:var(--primary-color);">60s</span>
    </div>
</div>
{% endblock %}

{% block body %}
  <div id="flash-message-container" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; max-width: 500px; text-align: center;">
      {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
              {% for category, message in messages %}
                  <div class="flash-message" style="padding: 12px 20px; border-radius: 6px; color: white; font-weight: bold; background-color: {{ 'var(--danger-color)' if category == 'error' else 'var(--success-color-alt)' }}; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                      {{ message }}
                  </div>
              {% endfor %}
          {% endif %}
      {% endwith %}
  </div>


<div class="tab-container">
    <button class="tab-button active" data-tab="position">Position</button>
    <button class="tab-button" data-tab="properties">Properties</button>
    <button class="tab-button" data-tab="outlook">Outlook</button>
    <button class="tab-button" data-tab="heatmap">Heatmap</button>
    <button class="tab-button" data-tab="inspiration">Inspiration</button> <button class="tab-button" data-tab="journal">Journal</button>

    <span class="help-badge" data-help-topic="search_syntax" title="Search Syntax Guide" style="margin-left: 10px;">?</span>

    <div id="saved-views-container">
        <select id="saved-views-dropdown" class="styled-select">
            <option value="">-- Saved Views --</option>
        </select>
        <button id="save-view-btn" title="Save current filters and sorting">Save</button>
        <button id="delete-view-btn" title="Delete selected view">Delete</button>

        <label style="display:flex; align-items:center; margin-left:10px; cursor:pointer; font-size: 14px; user-select: none; color: var(--text-dark-alt);">
            <input type="checkbox" id="global-active-toggle" style="margin-right:5px;">
            Active Only
        </label>
    </div>
    <div id="remove-filters-container" style="display: none; margin-left: auto;"> <button type="button" id="remove-filters-btn">
       Remove Filter
     </button>
    </div>
</div>
<div id="list-section">
    <div class="table-wrapper" id="dso-table-wrapper">
        <table id="data-table" data-sort-order="asc">
          <thead>
            <tr> {# Main Headers for DSO Table #}
              <th data-column-key="Object" class="col-always-visible sortable"><span>Object</span><span class="subtext">&nbsp;</span><span class="sort-indicator"></span></th>
              <th data-column-key="Common Name" class="col-always-visible sortable"><span>Common Name</span><span class="subtext">&nbsp;</span><span class="sort-indicator"></span></th>
              <th data-column-key="Altitude Current" class="col-position sortable"><span>Altitude<br><span class="subtext">(Current)</span></span><span class="sort-indicator"></span></th>
              <th data-column-key="Azimuth Current" class="col-position sortable"><span>Azimuth <br><span class="subtext">(Current)</span></span><span class="sort-indicator"></span></th>
              <th data-column-key="Trend" class="col-position sortable"><span>Trend</span><span class="subtext">&nbsp;</span><span class="sort-indicator"></span></th>
              <th data-column-key="Altitude 11PM" class="col-position sortable"><span>Altitude <br><span class="subtext">(11 PM)</span></span><span class="sort-indicator"></span></th>
              <th data-column-key="Azimuth 11PM" class="col-position sortable"><span>Azimuth <br><span class="subtext">(11 PM)</span></span><span class="sort-indicator"></span></th>
              <th data-column-key="Transit Time" class="col-position sortable"><span>Transit <br><span class="subtext">(Local Time)</span></span><span class="sort-indicator"></span></th>
              <th data-column-key="Observable Duration (min)" class="col-position sortable"><span>Observable <br><span class="subtext">(minutes)</span></span><span class="sort-indicator"></span></th>
              <th data-column-key="Max Altitude (°)" class="col-position sortable"><span>Max Altitude<br><span class="subtext">observable (°)</span></span><span class="sort-indicator"></span></th>
              <th data-column-key="Angular Separation (°)" class="col-position sortable"><span>Ang. Sep. <br><span class="subtext">to moon (°)</span></span><span class="sort-indicator"></span></th>
              <th data-column-key="Constellation" class="col-properties sortable"><span>Constellation</span><span class="subtext">&nbsp;</span><span class="sort-indicator"></span></th>
              <th data-column-key="Type" class="col-properties sortable"><span>Type</span><span class="subtext">&nbsp;</span><span class="sort-indicator"></span></th>
              <th data-column-key="Magnitude" class="col-properties sortable"><span>Magnitude</span><span class="subtext">&nbsp;</span><span class="sort-indicator"></span></th>
              <th data-column-key="Size" class="col-properties sortable"><span>Size (')</span><span class="subtext">&nbsp;</span><span class="sort-indicator"></span></th>
              <th data-column-key="SB" class="col-properties sortable"><span>SB</span><span class="subtext">&nbsp;</span><span class="sort-indicator"></span></th>
              <th data-column-key="Best Month" class="col-properties sortable"><span>Best Month</span><span class="subtext">(Opp.)</span><span class="sort-indicator"></span></th>
              <th data-column-key="Max Altitude" class="col-properties sortable"><span>Max Alt</span><span class="subtext">(Culm.)</span><span class="sort-indicator"></span></th>
            </tr>
            <tr class="filter-row"> {# Filter Row for DSO Table #}
              <th data-column-key="Object" class="col-always-visible"><input type="text" placeholder="Search Object" /></th>
              <th data-column-key="Common Name" class="col-always-visible"><input type="text" placeholder="Search Common Name" /></th>
              <th data-column-key="Altitude Current" class="col-position"><input type="text" placeholder="Altitude °" /></th>
              <th data-column-key="Azimuth Current" class="col-position"><input type="text" placeholder="Azimuth °" /></th>
              <th data-column-key="Trend" class="col-position"><input type="text" placeholder="Trend" disabled style="visibility:hidden;" /></th>
              <th data-column-key="Altitude 11PM" class="col-position"><input type="text" placeholder="Altitude °" /></th>
              <th data-column-key="Azimuth 11PM" class="col-position"><input type="text" placeholder="Azimuth °" /></th>
              <th data-column-key="Transit Time" class="col-position"><input type="text" placeholder="Transit" disabled style="visibility:hidden;" /></th>
              <th data-column-key="Observable Duration (min)" class="col-position"><input type="text" placeholder="minutes" /></th>
              <th data-column-key="Max Altitude (°)" class="col-position"><input type="text" placeholder="Max Alt. °" /></th>
              <th data-column-key="Angular Separation (°)" class="col-position"><input type="text" placeholder="Ang. Sep. °" /></th>
              <th data-column-key="Constellation" class="col-properties"><input type="text" placeholder="e.g. Cyg" /></th>
              <th data-column-key="Type" class="col-properties"><input type="text" placeholder="Type (e.g. PN,SNR)" /></th>
              <th data-column-key="Magnitude" class="col-properties"><input type="text" placeholder="Mag e.g. <8" /></th>
              <th data-column-key="Size" class="col-properties"><input type="text" placeholder="Size e.g. >10" /></th>
              <th data-column-key="SB" class="col-properties"><input type="text" placeholder="SB e.g. <22" /></th>
              <th data-column-key="Best Month" class="col-properties"><input type="text" placeholder="e.g. Dec" /></th>
              <th data-column-key="Max Altitude" class="col-properties"><input type="text" placeholder="e.g. >80" /></th>
            </tr>
          </thead>
          <tbody id="data-body"></tbody>
        </table>
    </div>

    <div class="table-wrapper" id="journal-table-wrapper" style="display:none;">
        <table id="journal-data-table" data-sort-order="desc">
            <thead>
                <tr>
                    <th data-journal-column-key="object_name"><span>Object</span><span class="subtext">&nbsp;</span><span class="sort-indicator"></span></th>
                    <th data-journal-column-key="target_common_name"><span>Common Name</span><span class="subtext">&nbsp;</span><span class="sort-indicator"></span></th>
                    <th data-journal-column-key="project_name"><span>Project</span><span class="subtext">&nbsp;</span><span class="sort-indicator"></span></th>
                    <th data-journal-column-key="date_utc"><span>Date</span><span class="subtext">&nbsp;</span><span class="sort-indicator"></span></th>
                    <th data-journal-column-key="location_name"><span>Location</span><span class="subtext">&nbsp;</span><span class="sort-indicator"></span></th>
                    <th data-journal-column-key="telescope_setup_notes"><span>Telescope Setup</span><span class="subtext">&nbsp;</span><span class="sort-indicator"></span></th>
                    <th data-journal-column-key="calculated_integration_time_minutes"><span>Total Integration</span><span class="subtext">&nbsp;</span><span class="sort-indicator"></span></th>
                    <th data-journal-column-key="session_rating_subjective"><span>Session Rating</span><span class="subtext">&nbsp;</span><span class="sort-indicator"></span></th>
                </tr>
                <tr class="filter-row" id="journal-filter-row">
                    <th data-journal-column-key="object_name"><input type="text" placeholder="Object ID"/></th>
                    <th data-journal-column-key="target_common_name"><input type="text" placeholder="Search Common Name"/></th>
                    <th data-journal-column-key="project_name"><input type="text" placeholder="Project Name"/></th>
                    <th data-journal-column-key="date_utc"><input type="text" placeholder="Date" style="min-width: 0;"/></th>
                    <th data-journal-column-key="location_name"><input type="text" placeholder="Location"/></th>
                    <th data-journal-column-key="telescope_setup_notes"><input type="text" placeholder="Setup notes"/></th>
                    <th data-journal-column-key="calculated_integration_time_minutes"><input type="text" placeholder="e.g. >120"/></th>
                    <th data-journal-column-key="session_rating_subjective"><input type="text" placeholder="e.g. 4"/></th>
                </tr>
            </thead>
            <tbody id="journal-data-body">
                </tbody>
        </table>
    </div>

    <div class="table-wrapper" id="outlook-wrapper" style="display:none;">
        <table id="outlook-table">
            <thead>
                <tr>
                    <th data-outlook-column-key="object_name"><span>Object</span><span class="sort-indicator"></span></th>
                    <th data-outlook-column-key="common_name"><span>Common Name</span><span class="sort-indicator"></span></th>
                    <th data-outlook-column-key="date"><span>Date</span><span class="sort-indicator"></span></th>
                    <th data-outlook-column-key="max_alt"><span>Max Alt</span><span class="sort-indicator"></span></th>
                    <th data-outlook-column-key="obs_dur"><span>Obs. Time</span><span class="sort-indicator"></span></th>
                    <th data-outlook-column-key="rating"><span>Rating</span><span class="sort-indicator"></span></th>
                </tr>
                <tr class="filter-row" id="outlook-filter-row">
                    <th data-outlook-column-key="object_name"><input type="text" placeholder="Search Object"/></th>
                    <th data-outlook-column-key="common_name"><input type="text" placeholder="Search Common Name"/></th>
                    <th data-outlook-column-key="date"><input type="text" placeholder="Search Date"/></th>
                    <th data-outlook-column-key="max_alt"><input type="text" placeholder="e.g. >60"/></th>
                    <th data-outlook-column-key="obs_dur"><input type="text" placeholder="e.g. >300"/></th>
                    <th data-outlook-column-key="rating"><input type="text" placeholder="e.g. ★★★★★"/></th>
                </tr>
            </thead>
            <tbody id="outlook-body">
                </tbody>
        </table>
    </div>
    {% include '_heatmap_section.html' %}
    {% include '_inspiration_section.html' %}

    <div id="table-loading" style="display:none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.95); padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 2000; width: 300px; text-align: center; border: 1px solid var(--text-lighter);">
        <div style="font-weight: bold; color: var(--primary-dark); margin-bottom: 10px;" id="loading-message">Updating data...</div>

        <div style="width: 100%; height: 10px; background: var(--bg-medium-alt); border-radius: 5px; overflow: hidden;">
            <div id="loading-progress-bar" style="width: 0%; height: 100%; background: var(--primary-dark); transition: width 0.1s ease;"></div>
        </div>

        <div style="margin-top: 5px; font-size: 12px; color: var(--text-tertiary);">
            <span id="loading-count">0</span> / <span id="loading-total">0</span>
        </div>
    </div>
</div> {# End of list-section #}

<div id="graph-section" style="display: none;">
  <iframe id="graph-iframe"
          style="width: 100%; max-width:1500px; height: 1000px; border: none;"
          title="Graph">
  </iframe>
</div>

<div id="save-view-modal" class="modal-backdrop" onclick="closeSaveViewModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:3000;">
    <div class="modal-content" onclick="event.stopPropagation()" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:var(--bg-white); padding:20px; border-radius:8px; width:400px;">
        <h3 style="margin-top:0;">Save Current View</h3>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <label>Name: <input type="text" id="modal-view-name" style="width:100%; padding:5px;"></label>
            <label>Description: <textarea id="modal-view-desc" rows="3" style="width:100%; padding:5px;" placeholder="Describe what this filter does..."></textarea></label>
            {% if not SINGLE_USER_MODE %}
            <label style="display:flex; align-items:center; gap:8px;">
                <input type="checkbox" id="modal-view-shared"> Share this view with others
            </label>
            {% endif %}
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px;">
                <button onclick="confirmSaveView()" style="background:var(--success-color); color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Save</button>
                <button onclick="closeSaveViewModal()" style="background:var(--accent-gray-medium); color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
</body> </html>