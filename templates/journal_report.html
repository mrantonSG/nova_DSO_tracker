<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Report</title>
    <style>
        body {
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: #333;
            font-size: 11px;
        }
        /* UPDATED: Padding set to 15mm to match Project Report and PDF Generator math */
        .a4-page {
            width: 210mm;
            background-color: #ffffff;
            padding: 15mm;
            box-sizing: border-box;
        }
        h1, h2, h3, h4 { margin: 0; font-weight: 700; }
        p { line-height: 1.4; margin: 0; }

        /* Header */
        .header-table { width: 100%; border-collapse: collapse; margin-bottom: 5px; }
        .header-logo img { height: 35px; width: auto; }
        .header-logo-text { font-size: 22px; font-weight: 800; color: #000; letter-spacing: -0.5px; line-height: 1; }
        .header-logo-text span { font-weight: 300; color: #555; margin-left: 4px; font-size: 20px;}
        .header-title { text-align: right; font-size: 14px; color: #83b4c5; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .header-line { border: 0; border-top: 2px solid #83b4c5; margin-bottom: 15px; }

        /* Target Info */
        .target-info { text-align: center; margin-bottom: 15px; }
        .target-info h1 { font-size: 18px; color: #222; margin-bottom: 2px; }

        /* Tables */
        .session-details-table { width: 100%; font-size: 11px; border-collapse: collapse; border: 1px solid #ddd; margin-bottom: 0; }
        .session-details-table tr:first-child { background-color: #f8f9fa; }
        .session-details-table td { padding: 5px 8px; border-right: 1px solid #eee; }
        .session-details-table strong { color: #555; text-transform: uppercase; font-size: 10px; font-weight: 700; }
        .session-rating { font-size: 14px; color: #f39c12; letter-spacing: 2px; }

        /* Main Columns */
        .main-content-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .main-content-table .left-column { width: 50%; padding-right: 15px; vertical-align: top; }
        .main-content-table .right-column { width: 50%; padding-left: 15px; vertical-align: top; }

        /* Page Break Safety */
        tr { page-break-inside: avoid; break-inside: avoid; }

        /* Report Block: The Atomic Unit for PDF Splitting */
        .report-block { display: block; background-color: #fff; margin-bottom: 20px; }

        /* Spacing for PDF Headers */
        .pdf-header-clone { margin-bottom: 15px; }

        /* Titles */
        .section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #83b4c5; border-bottom: 1px solid #eee; padding-bottom: 4px; margin-bottom: 6px; margin-top: 15px; }
        .section-title:first-child { margin-top: 0; }

        /* Image & Notes */
        .session-image-container { border: 1px solid #ccc; border-radius: 3px; padding: 5px; background-color: #fff; }
        .session-image-container img { max-width: 100%; height: auto; display: block; border-radius: 2px; }
        .session-image-caption { text-align: center; font-style: italic; color: #777; margin-top: 6px; font-size: 10px; }

        .session-notes-container { border: 1px solid #eee; padding: 10px; border-radius: 3px; min-height: 150px; font-size: 11px; background: #fff; color: #333; }
        .session-notes-container p, .session-notes-container div { margin-bottom: 8px; }
        .session-notes-container img { max-width: 100% !important; max-height: 350px !important; object-fit: contain; display: block; margin: 10px 0; }
        .session-notes-container figure { max-width: 100% !important; margin: 0; }

        /* Info Boxes */
        .info-box { border: 1px solid #eee; padding: 6px 10px; border-radius: 3px; font-size: 11px; line-height: 1.5; margin-bottom: 10px; color: #333; }
        .info-box.stats { background: #f8f9fa; }
        .info-box .detail-line { display: block; }
        .info-box .detail-line strong { color: #444; font-weight: 600; width: 115px; display: inline-block; vertical-align: top; }

        /* Equipment Specifics */
        .acq-details-block strong, .setup-notes-line strong, .acq-line strong { width: 90px !important; }
        .camera-details-block .detail-line strong { width: 90px !important; }
        .acq-line { display: block; }

        /* Exposures Table */
        .exposures-table { width: 100%; font-size: 11px; border-collapse: collapse; }
        .exposures-table th { background-color: #f4f4f4; padding: 4px 6px; border: 1px solid #ddd; text-align: left; font-weight: 600; white-space: nowrap; }
        .exposures-table td { padding: 4px 6px; border: 1px solid #ddd; }
        .exposures-table th:nth-child(2), .exposures-table td:nth-child(2), .exposures-table th:nth-child(3), .exposures-table td:nth-child(3) { text-align: right; width: 50px; }

        .footer { margin-top: 25px; padding-top: 10px; border-top: 1px solid #eee; width: 100%; text-align: center; color: #aaa; font-size: 10px; }
    </style>
</head>
<body>
    <div class="a4-page" id="report-content">
        {% macro display_value(value) -%}
            {% if value is number or (value is string and value|lower != 'none' and value|length > 0) -%}
                {{ value }}
            {% else -%}
                -
            {% endif -%}
        {% endmacro -%}

        <table class="header-table">
            <tr>
                <td class="header-logo">
                    {% if logo_url %}
                        <img src="{{ logo_url }}" alt="Nova Logo">
                    {% else %}
                        <div class="header-logo-text">Nova<span>DSO Tracker</span></div>
                    {% endif %}
                </td>
                <td class="header-title">SESSION REPORT</td>
            </tr>
        </table>
        <hr class="header-line">

        <div class="target-info report-block">
            <h1>{{ display_value(object_details['Common Name']) }} {% if object_details['Object'] and object_details['Object'] != object_details['Common Name'] %}{{ display_value(object_details['Object']) }}{% endif %}</h1>
        </div>

        <div class="report-block">
            <table class="session-details-table">
                <tr>
                    <td><strong>Date</strong></td><td>{{ session.date_utc | date_eu | default('-') }}</td>
                    <td><strong>Location</strong></td><td>{{ display_value(session.location_name) }}</td>
                </tr>
                <tr>
                    <td><strong>Project</strong></td><td>{{ display_value(project_name) }}</td>
                    <td><strong>Rating</strong></td><td class="session-rating">{{ rating_stars }}</td>
                </tr>
            </table>
        </div>

        <div class="report-block">
            <table class="main-content-table">
                <tr>
                    <td class="left-column">
                        <h4 class="section-title">Session Image</h4>
                        <div class="session-image-container" style="min-height: 200px;">
                            {% if image_url %}
                                <img src="{{ image_url }}" style="max-height: 350px; object-fit: contain;">
                                <p class="session-image-caption" style="font-weight:bold; color:#555;">{{ image_source_label }}</p>
                            {% else %}
                                <div style="width: 100%; height: 200px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #ccc; font-size: 12px;">[No Image]</div>
                            {% endif %}
                            <p class="session-image-caption">Total Integration: {{ display_value(integ_str) }}</p>
                        </div>

                        <h4 class="section-title">Notes & Reflections</h4>
                        <div class="session-notes-container" style="min-height: 200px;">
                            {{ session.notes | sanitize_html | safe | default('-') }}
                        </div>
                    </td>

                    <td class="right-column">
                        <h4 class="section-title">Statistics & Conditions</h4>
                        <div class="info-box stats">
                            <div class="detail-line"><strong>Integration:</strong> {{ display_value(integ_str) }}</div>
                            <div class="detail-line"><strong>Seeing (FWHM):</strong> {{ display_value(session.seeing_observed_fwhm) }}{% if session.seeing_observed_fwhm and session.seeing_observed_fwhm|lower != 'none' %}"{% endif %}</div>
                            <div class="detail-line"><strong>Guiding (RMS):</strong> {{ display_value(session.guiding_rms_avg_arcsec) }}{% if session.guiding_rms_avg_arcsec and session.guiding_rms_avg_arcsec|lower != 'none' %}"{% endif %}</div>
                            <div class="detail-line"><strong>Sky Quality (SQM):</strong> {{ display_value(session.sky_sqm_observed) }}</div>
                        </div>

                        <div class="info-box">
                            <div class="detail-line"><strong>Moon Illum./Sep.:</strong> {{ display_value(session.moon_illumination_session) }}% / {{ display_value(session.moon_angular_separation_session) }}°</div>
                            <div class="detail-line"><strong>Transparency:</strong> {{ display_value(session.transparency_observed_scale) }}</div>
                            <div class="detail-line"><strong>Weather Notes:</strong> {{ display_value(session.weather_notes) }}</div>
                        </div>

                        <h4 class="section-title">Equipment & Acquisition</h4>
                        <div class="info-box acq">
                            {% if session.rig_name_snapshot %}
                                <div style="font-weight: 600; margin-bottom: 5px; color: #212529; border-bottom: 1px dashed #eee;">Rig: {{ display_value(session.rig_name_snapshot) }}</div>
                                <div class="acq-details-block" style="font-size: 1em; margin-bottom: 0px; line-height: 1.4;">
                                    <div class="detail-line"><strong>Telescope:</strong> {{ display_value(session.telescope_name_snapshot) }}</div>
                                    {% if session.reducer_name_snapshot %}
                                        <div class="detail-line"><strong>Reducer/Ext.:</strong> {{ display_value(session.reducer_name_snapshot) }}</div>
                                    {% endif %}
                                    <div class="detail-line"><strong>Camera:</strong> {{ display_value(session.camera_name_snapshot) }}</div>
                                </div>
                                <div class="camera-details-block">
                                    <div class="detail-line"><strong>Gain / Offset:</strong> {{ display_value(session.gain_setting) }} / {{ display_value(session.offset_setting) }}</div>
                                    <div class="detail-line"><strong>Temp (Set/Avg):</strong> {{ display_value(session.camera_temp_setpoint_c) }}°C / {{ display_value(session.camera_temp_actual_avg_c) }}°C</div>
                                </div>
                                <div class="acq-details-block" style="font-size: 1em; line-height: 1.4; margin-bottom: 8px; padding-top: 5px; border-top: 1px solid #f8f9fa;">
                                    <div class="detail-line"><strong>FL / Ratio:</strong> {{ session.rig_efl_snapshot | round(0) if session.rig_efl_snapshot is number else '-' }} mm (f/{{ session.rig_fr_snapshot | round(1) if session.rig_fr_snapshot is number else '-' }})</div>
                                    <div class="detail-line"><strong>Scale / FOV:</strong> {{ session.rig_scale_snapshot | round(2) if session.rig_scale_snapshot is number else '-' }}"/px ({{ session.rig_fov_w_snapshot | round(1) if session.rig_fov_w_snapshot is number else '-' }}' &times; {{ session.rig_fov_h_snapshot | round(1) if session.rig_fov_h_snapshot is number else '-' }}')</div>
                                </div>
                                <div class="setup-notes-line" style="font-size: 1em; margin-top: 10px;">
                                    <strong>Setup Notes:</strong> {{ display_value(session.telescope_setup_notes) }}
                                </div>
                            {% else %}
                                <div style="font-weight: 600; margin-bottom: 5px; color: #212529; border-bottom: 1px dashed #eee;">Rig/Setup: {{ display_value(session.telescope_setup_notes) }}</div>
                            {% endif %}
                            <br>
                            <div class="acq-line"><strong>Acquisition SW:</strong> {{ display_value(session.acquisition_software) }}</div>
                            <div class="acq-line"><strong>Guiding Equip.:</strong> {{ display_value(session.guiding_equipment) }}</div>
                            <div class="acq-line"><strong>Dither Details:</strong> {{ display_value(session.dither_details) }}</div>
                            <div class="acq-line"><strong>Binning:</strong> {{ display_value(session.binning_session) }}</div>
                        </div>

                        <h4 class="section-title">Calibration Strategy</h4>
                        <div class="info-box">
                            <div class="detail-line"><strong>Darks:</strong> {{ display_value(session.darks_strategy) }}</div>
                            <div class="detail-line"><strong>Flats:</strong> {{ display_value(session.flats_strategy) }}</div>
                            <div class="detail-line"><strong>Bias/Dark Flats:</strong> {{ display_value(session.bias_darkflats_strategy) }}</div>
                        </div>

                        <h4 class="section-title">Exposures</h4>
                        <table class="exposures-table">
                            <thead><tr><th>Filter</th><th>Subs</th><th>Time (sec)</th></tr></thead>
                            <tbody>
                                {% if session.number_of_subs_light or session.exposure_time_per_sub_sec %}
                                <tr><td>{{ display_value(session.filter_used_session) }}</td><td>{{ display_value(session.number_of_subs_light) }}</td><td>{{ display_value(session.exposure_time_per_sub_sec) }}</td></tr>
                                {% endif %}
                                {% set mono_filters = [('L', 'L'), ('R', 'R'), ('G', 'G'), ('B', 'B'), ('Ha', 'Ha'), ('OIII', 'OIII'), ('SII', 'SII')] %}
                                {% for key, name in mono_filters %}
                                    {% if session['filter_' ~ key ~ '_subs'] or session['filter_' ~ key ~ '_exposure_sec'] %}
                                    <tr><td>{{ name }}</td><td>{{ display_value(session['filter_' + key + '_subs']) }}</td><td>{{ display_value(session['filter_' + key + '_exposure_sec']) }}</td></tr>
                                    {% endif %}
                                {% endfor %}
                                {% if not (session.number_of_subs_light or session.filter_L_subs or session.filter_R_subs or session.filter_G_subs or session.filter_B_subs or session.filter_Ha_subs or session.filter_OIII_subs or session.filter_SII_subs) %}
                                <tr><td colspan="3" style="text-align: center;">-</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </td>
                </tr>
            </table>
        </div>

        <div class="footer report-block">Report generated by Nova DSO Tracker | {{ today_date }}</div>
    </div>
</body>
</html>