<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Nova DSO Tracker{% endblock %}</title>

    <!-- Theme Persistence Script (blocking, executes before page render) -->
    <script>
        (function() {
            try {
                // Check localStorage for saved theme preference
                var savedTheme = localStorage.getItem('theme');
                // Apply dark theme if saved, otherwise use default (light)
                if (savedTheme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else if (savedTheme === 'light') {
                    document.documentElement.setAttribute('data-theme', 'light');
                }
            } catch (e) {
                // Silently fail if localStorage is not available
                console.warn('Theme persistence: Could not access localStorage', e);
            }
        })();
    </script>

    <link rel="icon" href="{{ url_for('static', filename='favicon_v2.ico') }}" type="image/x-icon">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="preload" href="{{ url_for('static', filename='fonts/roboto-v49-latin-regular.woff2') }}" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="{{ url_for('static', filename='fonts/roboto-v49-latin-700.woff2') }}" as="font" type="font/woff2" crossorigin>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/trix@2.0.0/dist/trix.css">
    <script type="text/javascript" src="https://unpkg.com/trix@2.0.0/dist/trix.umd.min.js" defer></script>
    <script src="{{ url_for('static', filename='js/utils.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/modal-manager.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/styling-utils.js') }}" defer></script>
    {% block head_extra %}{% endblock %}
  </head>
  <body>

    {% block demo_banner %}
    {% if is_guest %}
    <div class="demo-banner">
      <strong>Demo Mode:</strong> You are viewing a read-only demo. Full functionality (like saving) is enabled for registered users.
    </div>
    {% endif %}
    {% endblock %}

    <div class="app-header">
      <div class="header-left">
          <div class="brand-group">
              <h1>
                  <span>Nova</span> DSO Tracker
                  <small>v{{ version }} <span id="update-notification"></span></small>
              </h1>
          </div>

          <div class="header-divider"></div>

          <div class="injected-title">
              {% block page_title %}{% endblock %}
          </div>
      </div>

      <div class="header-right">
          {% block header_actions %}{% endblock %}

          <button id="theme-toggle" class="theme-toggle-button" type="button" aria-label="Toggle dark/light theme" title="Toggle theme">
              <!-- Sun icon (shown in dark mode) -->
              <svg class="theme-icon theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="5"></circle>
                  <line x1="12" y1="1" x2="12" y2="3"></line>
                  <line x1="12" y1="21" x2="12" y2="23"></line>
                  <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                  <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                  <line x1="1" y1="12" x2="3" y2="12"></line>
                  <line x1="21" y1="12" x2="23" y2="12"></line>
                  <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                  <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
              </svg>
              <!-- Moon icon (shown in light mode) -->
              <svg class="theme-icon theme-icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 12.79A9 9 0 1 1 1 11.21 3 7 7 0 0 0 0 21.12 9.79z"></path>
              </svg>
          </button>

          <div class="user-menu">
            {% if is_guest %}
                Guest Mode
                <a href="{{ url_for('core.login') }}" style="margin-left: 8px; color: var(--primary-color); font-size: 12px; text-decoration: underline;">Login</a>
            {% elif not SINGLE_USER_MODE and current_user.is_authenticated %}
                {{ current_user.username }}
                <form action="{{ url_for('core.logout') }}" method="post" style="display:inline; margin-left:5px;">
                    <button type="submit" style="background:none; border:none; color:var(--primary-color); cursor:pointer; padding:0; text-decoration:underline; font-size:12px;">Logout</button>
                </form>
            {% elif SINGLE_USER_MODE %}
                &nbsp;
            {% endif %}
          </div>
      </div>
    </div>

    {% block header_content %}{% endblock %}

    {% block body %}{% endblock %}

    <script src="{{ url_for('static', filename='js/base.js') }}" defer></script>

    {% block scripts %}{% endblock %}

    <div id="universal-help-modal" aria-labelledby="help-modal-title">
        <div class="modal-content">
            <h2 id="help-modal-title" class="sr-only">Help</h2>
            <div id="help-modal-body" class="help-body"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="action-button" id="help-modal-close-btn">Close</button>
            </div>
        </div>
    </div>
  </body>
</html>