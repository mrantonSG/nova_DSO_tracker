<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Nova DSO Tracker{% endblock %}</title>

    <link rel="icon" href="{{ url_for('static', filename='favicon_v2.ico') }}" type="image/x-icon">

    <script>
        // 1. PREVENT FLASH OF LIGHT MODE
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const savedRedMode = localStorage.getItem('red-mode');
            const html = document.documentElement;

            if (savedTheme === 'dark-mode') {
                html.classList.add('dark-mode');
            }
            if (savedRedMode === 'true') {
                html.classList.add('red-mode');
            }
        })();
    </script>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="preload" href="{{ url_for('static', filename='fonts/roboto-v49-latin-regular.woff2') }}" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="{{ url_for('static', filename='fonts/roboto-v49-latin-700.woff2') }}" as="font" type="font/woff2" crossorigin>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/trix@2.0.0/dist/trix.css">
    <script type="text/javascript" src="https://unpkg.com/trix@2.0.0/dist/trix.umd.min.js" defer></script>
    <script src="{{ url_for('static', filename='js/utils.js') }}" defer></script>
    {% block head_extra %}{% endblock %}
  </head>
  <body>

    {% block demo_banner %}
    {% if is_guest %}
    <div class="demo-banner">
      <strong>Demo Mode:</strong> You are viewing a read-only demo. Full functionality (like saving) is enabled for registered users.
    </div>
    {% endif %}
    {% endblock %}

    <div class="app-header">
      <div class="header-left">
          <div class="brand-group">
              <h1>
                  <span>Nova</span> DSO Tracker
                  <small>v{{ version }} <span id="update-notification"></span></small>
              </h1>
          </div>

          <div class="header-divider"></div>

          <div class="injected-title">
              {% block page_title %}{% endblock %}
          </div>
      </div>

      <div class="header-right">
          {% block header_actions %}{% endblock %}

          <div class="user-menu">
            {% if is_guest %}
                Guest Mode
                <a href="{{ url_for('core.login') }}" style="margin-left: 8px; color: #83b4c5; font-size: 12px; text-decoration: underline;">Login</a>
            {% elif not SINGLE_USER_MODE and current_user.is_authenticated %}
                {{ current_user.username }}
                <form action="{{ url_for('core.logout') }}" method="post" style="display:inline; margin-left:5px;">
                    <button type="submit" style="background:none; border:none; color:#83b4c5; cursor:pointer; padding:0; text-decoration:underline; font-size:12px;">Logout</button>
                </form>
            {% elif SINGLE_USER_MODE %}
                &nbsp;
            {% endif %}
          </div>
          <button id="theme-toggle-btn" class="action-button" onclick="toggleTheme()" title="Toggle Dark/Light Mode">Night View</button>
          <button id="red-mode-btn" class="action-button" onclick="toggleRedMode()" title="Toggle Red/Night Vision Mode">Red View</button>
      </div>
    </div>

    {% block header_content %}{% endblock %}

    {% block body %}{% endblock %}

    <script src="{{ url_for('static', filename='js/base.js') }}" defer></script>

    {% block scripts %}{% endblock %}

    <div id="universal-help-modal" onclick="closeHelpModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="help-modal-body" class="help-body"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="action-button" onclick="closeHelpModal()">Close</button>
            </div>
        </div>
    </div>
  </body>
</html>