<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Nova DSO Tracker{% endblock %}</title>

    <link rel="icon" href="{{ url_for('static', filename='favicon_v2.ico') }}" type="image/x-icon">

    <script>
        // 1. PREVENT FLASH OF LIGHT MODE
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const savedRedMode = localStorage.getItem('red-mode');
            const html = document.documentElement;

            if (savedTheme === 'dark-mode') {
                html.classList.add('dark-mode');
            }
            if (savedRedMode === 'true') {
                html.classList.add('red-mode');
            }
        })();
    </script>

    <style>
        @font-face {
          font-family: 'Roboto';
          font-style: normal;
          font-weight: 400;
          font-display: swap;
          src: url('{{ url_for('static', filename='fonts/roboto-v49-latin-regular.woff2') }}') format('woff2');
        }

        @font-face {
          font-family: 'Roboto';
          font-style: normal;
          font-weight: 700;
          font-display: swap;
          src: url('{{ url_for('static', filename='fonts/roboto-v49-latin-700.woff2') }}') format('woff2');
        }

        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid transparent;
        }

        .header-title-group {
            display: flex;
            align-items: baseline;
            gap: 12px; /* Force consistent spacing between Nova and DSO Tracker */
        }

        .header-title-group h1, .header-title-group h3 {
            margin: 0;
        }
        .header-title-group h3 {
            /* margin-left removed in favor of gap */
            font-weight: normal;
            white-space: nowrap;
        }

        .theme-controls {
            display: flex;
            gap: 10px;
        }

        /* --- DARK MODE OVERRIDES --- */
        html.dark-mode body {
            background-color: #121212 !important;
            color: #e0e0e0 !important;
        }

        /* 1. GLOBAL CONTAINERS */
        html.dark-mode .config-section,
        html.dark-mode .content-section,
        html.dark-mode .notes-section,
        html.dark-mode .journal-project-notes-section,
        html.dark-mode .modal-content,
        html.dark-mode .column,
        html.dark-mode .block,
        html.dark-mode .selected-session-details,
        html.dark-mode .tab-content,
        html.dark-mode .readonly-notes,
        html.dark-mode #heatmap-controls,
        html.dark-mode .offline-message,
        html.dark-mode #framing-modal-content,
        html.dark-mode .insp-detail-text,
        html.dark-mode .inspiration-container {
            background-color: #1e1e1e !important;
            border-color: #333 !important;
            color: #ddd !important;
        }

        /* 2. LOADING POPUPS (Heatmap & Calculation) */
        /* Override inline white backgrounds */
        html.dark-mode #table-loading,
        html.dark-mode #heatmap-loading {
            background-color: #2c2c2c !important;
            color: #e0e0e0 !important;
            border: 1px solid #555 !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5) !important;
        }

        /* Loading Text Colors */
        html.dark-mode #loading-message,
        html.dark-mode #heatmap-loading div {
            color: #fff !important;
        }
        html.dark-mode #loading-count,
        html.dark-mode #loading-total,
        html.dark-mode #heatmap-loading-text {
            color: #aaa !important;
        }

        /* Progress Bar Track (Darken the empty part) */
        html.dark-mode #table-loading div[style*="background: #eee"],
        html.dark-mode #heatmap-loading div[style*="background: #eee"] {
            background-color: #444 !important;
        }

        /* 3. BOXES, LISTS & STATS */
        html.dark-mode .stat-box,
        html.dark-mode .summary-box,
        html.dark-mode .journal-project-stat-box,
        html.dark-mode li,
        html.dark-mode .loader-row td,
        html.dark-mode .dropdown-content {
            background-color: #2c2c2c !important;
            color: #eee !important;
            border-color: #444 !important;
        }

        /* 4. TEXT FIXES */
        html.dark-mode .stat-label,
        html.dark-mode .journal-project-stat-label,
        html.dark-mode small,
        html.dark-mode .muted-text,
        html.dark-mode label,
        html.dark-mode .brand-light {
            color: #aaa !important;
        }

        html.dark-mode .stat-value,
        html.dark-mode .journal-project-stat-value,
        html.dark-mode h1,
        html.dark-mode h2,
        html.dark-mode h3,
        html.dark-mode h4,
        html.dark-mode p,
        html.dark-mode span,
        html.dark-mode div,
        html.dark-mode .brand-strong {
            color: #e0e0e0;
            border-bottom-color: #444;
        }

        html.dark-mode .secondary-info-line-main span,
        html.dark-mode .info-values span,
        html.dark-mode #location-display,
        html.dark-mode #date-display {
            color: #fff !important;
        }

        /* 5. HELP CONTENT FIXES */
        html.dark-mode .help-body h1,
        html.dark-mode .help-body h2,
        html.dark-mode .help-body h3,
        html.dark-mode .help-body h4 {
            color: #fff !important;
            border-bottom-color: #444 !important;
        }
        html.dark-mode .help-body p,
        html.dark-mode .help-body li,
        html.dark-mode .help-body ul,
        html.dark-mode .help-body ol {
            color: #ddd !important;
        }
        html.dark-mode .help-body strong,
        html.dark-mode .help-body b {
            color: #fff !important;
            font-weight: 700;
        }
        html.dark-mode .help-body code,
        html.dark-mode .help-body pre {
            background-color: #2c2c2c !important;
            border: 1px solid #444 !important;
            color: #83b4c5 !important;
        }

        /* 6. TABLES */
        html.dark-mode table,
        html.dark-mode th,
        html.dark-mode td {
            border-color: #444 !important;
            color: #ddd !important;
        }

        html.dark-mode th,
        html.dark-mode .sessions-table th,
        html.dark-mode .config-table th,
        html.dark-mode #opportunities-table th,
        html.dark-mode .session-history-table th {
            background-color: #252525 !important;
            color: #fff !important;
        }

        html.dark-mode #opportunities-table tr:nth-child(even),
        html.dark-mode #opportunities-table tr:nth-child(odd) {
            background-color: #1e1e1e !important;
            color: #e0e0e0 !important;
        }

        html.dark-mode tr:hover,
        html.dark-mode tr.clickable-row:hover,
        html.dark-mode .sessions-table tr:hover,
        html.dark-mode #opportunities-table tr:hover,
        html.dark-mode .session-history-table tr.clickable-session-row:hover {
            background-color: #333 !important;
        }

        /* 7. TRIX EDITOR */
        html.dark-mode trix-editor,
        html.dark-mode .trix-content {
            background-color: #1e1e1e !important;
            border-color: #555 !important;
            color: #e0e0e0 !important;
        }
        html.dark-mode trix-toolbar .trix-button {
            filter: invert(1);
        }

        /* 8. FRAMING MODAL */
        html.dark-mode #framing-toolbar,
        html.dark-mode .framing-controls {
            background-color: #1e1e1e !important;
            color: #e0e0e0 !important;
            border-color: #444 !important;
        }
        html.dark-mode #framing-modal input {
            background-color: #2c2c2c !important;
            color: #fff !important;
            border: 1px solid #555 !important;
        }
        html.dark-mode .fov-chip {
            background-color: #2c2c2c !important;
            border-color: #555 !important;
            color: #e0e0e0 !important;
        }

        /* 9. HEATMAP & CHARTS */
        html.dark-mode #chart-area canvas,
        html.dark-mode #yearly-heatmap-plot {
            filter: invert(0.93) hue-rotate(180deg) !important;
            background-color: transparent !important;
        }
        html.dark-mode #chart-area {
            background-color: #1e1e1e !important;
            border-radius: 8px;
        }

        /* 10. FORMS */
        html.dark-mode input[type="text"],
        html.dark-mode input[type="number"],
        html.dark-mode input[type="password"],
        html.dark-mode input[type="date"],
        html.dark-mode select,
        html.dark-mode textarea {
            background-color: #2c2c2c !important;
            border-color: #555 !important;
            color: #fff !important;
        }
        html.dark-mode select {
             background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20width%3D%27292.4%27%20height%3D%27292.4%27%3E%3Cpath%20fill%3D%27%23bbbbbb%27%20d%3D%27M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20128c3.6%203.6%207.8%205.4%2013%205.4s9.4-1.8%2013-5.4l128-128c3.6-3.6%205.4-7.8%205.4-13%200-5-1.8-9.2-5.4-12.8z%27%2F%3E%3C%2Fsvg%3E") !important;
        }

        /* 11. TABS & LINKS */
        html.dark-mode .tab-button,
        html.dark-mode button.detail-tab-button {
            background-color: #2c2c2c !important;
            border-color: #444 !important;
            color: #aaa !important;
        }
        html.dark-mode .tab-button.active,
        html.dark-mode button.detail-tab-button.active {
            background-color: #1e1e1e !important;
            border-bottom-color: #83b4c5 !important;
            color: #83b4c5 !important;
        }
        html.dark-mode button.detail-tab-button:hover {
            color: #fff !important;
        }
        html.dark-mode a {
            color: #83b4c5 !important;
        }

        /* 12. BUTTONS & HIGHLIGHTS */
        html.dark-mode .action-button,
        html.dark-mode .dlback-button,
        html.dark-mode .file-button,
        html.dark-mode .view-button,
        html.dark-mode .inline-button,
        html.dark-mode a.action-button,
        html.dark-mode a.dlback-button {
            color: #ffffff !important;
            border-color: #555 !important;
        }

        html.dark-mode tr.active-project-row,
        html.dark-mode tr.active-project-row > td,
        html.dark-mode tr.current-session-item,
        html.dark-mode tr.current-session-item > td,
        html.dark-mode tr.current-project-item,
        html.dark-mode tr.current-project-item > th {
            background-color: #1a3b4d !important;
            border-left-color: #4da3ff !important;
            color: #ffffff !important;
        }

        html.dark-mode td.highlight {
            background-color: #1c5261 !important;
            color: #ffffff !important;
        }
        html.dark-mode td.highlight.obstructed {
            background-color: #4d4200 !important;
            color: #e0e0e0 !important;
        }

        /* 13. JOURNAL DETAILS FIX */
        html.dark-mode .detail-grid dt {
            color: #aaa !important;
        }
        html.dark-mode .detail-grid dd {
            color: #fff !important;
        }
        html.dark-mode .notes-block,
        html.dark-mode .notes-content,
        html.dark-mode .journal-project-notes-section .notes-content {
            background-color: #2c2c2c !important;
            border-color: #444 !important;
            color: #e0e0e0 !important;
        }
        html.dark-mode .session-detail-column h4,
        html.dark-mode .session-detail-column h5,
        html.dark-mode .detail-header h4 {
            color: #fff !important;
        }

        /* 14. INSPIRATION TAB & MODAL */
        html.dark-mode .astro-tile {
            background-color: #1e1e1e !important;
            border-color: #333 !important;
        }
        html.dark-mode .tile-title {
            color: #fff !important;
        }
        html.dark-mode .tile-common-name {
            color: #aaa !important;
        }
        html.dark-mode .tile-summary,
        html.dark-mode .tile-stats {
            color: #ddd !important;
        }
        html.dark-mode .tile-stat-pill {
            background-color: #2c2c2c !important;
            border-color: #444 !important;
            color: #eee !important;
        }
        html.dark-mode .tile-type {
            background-color: #2c3e50 !important;
            color: #83b4c5 !important;
        }

        /* Modal Dark Mode */
        html.dark-mode .insp-modal-content {
            background-color: #1e1e1e !important;
            color: #e0e0e0 !important;
        }
        html.dark-mode .insp-modal-title {
            color: #fff !important;
        }
        html.dark-mode .insp-modal-subtitle {
            color: #aaa !important;
        }
        html.dark-mode .insp-modal-text {
            color: #ddd !important;
        }
        html.dark-mode .insp-data-grid {
            background-color: #2c2c2c !important;
        }
        html.dark-mode .insp-data-item strong {
            color: #aaa !important;
        }
        html.dark-mode .insp-data-item span {
            color: #fff !important;
        }
        html.dark-mode .modal-attribution,
        html.dark-mode .modal-attribution a {
            color: #888 !important;
        }
        html.dark-mode .btn-close-modal {
            color: #fff !important;
            border-color: #555 !important;
        }

        /* Banner & Empty State */
        html.dark-mode .inspiration-banner {
            background-color: #1a3b4d !important;
            border-color: #1c5261 !important;
            color: #bce8f1 !important;
        }
        html.dark-mode .inspiration-banner strong {
            color: #fff !important;
        }
        html.dark-mode .inspiration-banner span {
            color: #ddd !important;
        }
        html.dark-mode .empty-state-styled {
            background-color: #1e1e1e !important;
            border-color: #444 !important;
        }
        html.dark-mode .empty-state-box {
            background-color: #2c2c2c !important;
            border-color: #444 !important;
        }
        html.dark-mode .empty-state-box strong {
            color: #fff !important;
        }
        html.dark-mode .empty-state-box ul {
            color: #ddd !important;
        }

        /* --- RED MODE (Night Vision) --- */
        html.red-mode {
            filter: sepia(100%) hue-rotate(320deg) brightness(0.6) saturate(400%) !important;
            background-color: #000 !important;
        }
        html.red-mode body {
            background-color: #000 !important;
            color: #ffcccc !important;
        }
        html.red-mode img, html.red-mode canvas, html.red-mode iframe {
            filter: brightness(0.6) !important;
        }

        /* --- GENERAL STYLES --- */
        .demo-banner {
          width: 100%;
          background-color: #fef9e7; /* Pale yellow */
          color: #333;
          text-align: center;
          padding: 12px 10px;
          font-size: 14px;
          font-weight: 600;
          border-bottom: 1px solid #e0e0e0;
          box-sizing: border-box;
        }

        #universal-help-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
            align-items: center;
            justify-content: center;
        }

        #universal-help-modal.is-visible {
            display: flex;
            opacity: 1;
        }

        #universal-help-modal .modal-content {
            position: relative;
            background: #fff;
            padding: 25px;
            width: 90%;
            max-width: 700px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-height: 85vh;
            overflow-y: auto;
            margin: 0;
            top: auto;
            left: auto;
            transform: none;
        }

        .help-body h1 { font-size: 1.5em; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 0; }
        .help-body h2 { font-size: 1.3em; margin-top: 1.5em; margin-bottom: 0.5em; color: #333; border-bottom: 1px solid #f0f0f0; }
        .help-body h3 { font-size: 1.2em; margin-top: 1.5em; margin-bottom: 0.5em; color: #444; font-weight: bold; }
        .help-body h4 { font-size: 1.1em; margin-top: 1.2em; margin-bottom: 0.5em; color: #555; font-weight: bold; }
        .help-body p { margin-bottom: 1em; line-height: 1.6; color: #333; }
        .help-body ul, .help-body ol { margin-left: 20px; margin-bottom: 1em; padding-left: 20px; list-style-position: outside; }
        .help-body ul { list-style-type: disc; }
        .help-body li { margin-bottom: 0.5em; line-height: 1.5; }
        .help-body code { background: #f4f4f4; padding: 2px 5px; border-radius: 3px; font-family: monospace; }
        .help-body pre { background: #f4f4f4; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .help-body img {
            max-width: 100%;
            max-height: 60vh;
            height: auto;
            display: block;
            margin: 10px auto;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .help-trigger { cursor: pointer; color: #83b4c5; font-size: 1.2em; margin-left: 5px; vertical-align: middle; }
        .help-trigger:hover { color: #5a8b9c; }

        .help-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 1px solid #83b4c5;
            color: #83b4c5;
            font-size: 12px;
            font-weight: bold;
            font-family: serif;
            cursor: pointer;
            margin-left: 5px;
            vertical-align: middle;
            background: transparent;
            transition: all 0.2s;
        }

        .help-badge:hover {
            background-color: #83b4c5;
            color: white;
            border-color: #83b4c5;
        }

        .action-button {
            padding: 5px 10px;
            font-size: 14px;
            background-color: #83b4c5;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        .action-button:hover {
            background-color: #6795a4;
        }

        /* Functional buttons (Night/Red View) styling to match filter button */
        #theme-toggle-btn, #red-mode-btn {
            background-color: #a1b0b4;
        }
        #theme-toggle-btn:hover, #red-mode-btn:hover {
            background-color: #849398;
        }

        /* --- NEW 2-ROW HEADER LAYOUT --- */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            background-color: #fff; /* Ensure solid background */
        }

        /* Left Side: Brand + Page Title */
        .header-left { display: flex; align-items: center; gap: 20px; }
        /* Added 'gap: 6px' to fix spacing between Nova, DSO Tracker, and Version */
        .brand-group h1 { font-size: 22px; margin: 0; color: #333; letter-spacing: -0.5px; line-height: 1; display: flex; align-items: baseline; gap: 6px; }
        .brand-group h1 span { color: #83b4c5; }
        .brand-group h1 small { color: #aaa; font-size: 11px; font-weight: normal; margin-left: 8px; letter-spacing: 0; }

        /* Vertical Divider between Brand and Page Title */
        .header-divider { height: 24px; width: 1px; background-color: #e0e0e0; }

        /* The Page Title injected by other pages */
        .injected-title h2 { margin: 0; font-size: 20px; color: #2c3e50; font-weight: 700; }
        .injected-title .subtitle { font-size: 14px; color: #7f8c8d; font-weight: 400; margin-left: 8px; }

        /* Right Side: Actions + Global Controls */
        .header-right { display: flex; align-items: center; gap: 15px; }
        .user-menu { font-size: 13px; color: #555; border-right: 1px solid #ddd; padding-right: 15px; }

        /* Status Strip (Row 2) remains similar but tighter */
        .status-strip {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 30px;
            margin-top: 15px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .status-item { display: flex; flex-direction: column; line-height: 1.2; }
        .status-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: #888; font-weight: 700; margin-bottom: 2px; }
        .status-value { font-weight: 500; color: #333; font-size: 14px; }
        .status-strip select { font-size: 14px; border: none; background: transparent; font-weight: 600; color: #333; cursor: pointer; padding: 0;}

        /* Dark Mode Updates */
        html.dark-mode .app-header { background-color: #121212; border-bottom-color: #333; }
        html.dark-mode .brand-group h1 { color: #fff; }
        html.dark-mode .header-divider { background-color: #444; }
        html.dark-mode .injected-title h2 { color: #e0e0e0; }
        html.dark-mode .status-strip { background-color: #1e1e1e; border-color: #333; }
        html.dark-mode .status-value, html.dark-mode .status-strip select { color: #ddd; }
        html.dark-mode .status-strip select option { background-color: #1e1e1e; }
        .brand-group h1 span { color: #83b4c5; }
        .brand-group small { color: #888; font-size: 12px; font-weight: normal; margin-left: 10px;}

        .header-controls { display: flex; align-items: center; gap: 15px; }
        .user-menu { font-size: 13px; color: #555; text-align: right; border-right: 1px solid #ddd; padding-right: 15px;}

        /* Row 2 & 3 Containers */
        .action-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; }
        .page-title { margin: 0; font-size: 22px; color: #2c3e50; font-weight: 700; display: flex; align-items: baseline; gap: 10px; }
        .page-subtitle { font-size: 16px; color: #7f8c8d; font-weight: 400; }

        .status-strip { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px 15px; display: flex; align-items: center; gap: 30px; margin-bottom: 25px; font-size: 14px; flex-wrap: wrap; }
        .status-item { display: flex; flex-direction: column; line-height: 1.3; }
        .status-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #888; font-weight: 600; }
        .status-value { font-weight: 500; color: #333; font-size: 15px; }
        .status-strip select { background: transparent; border: none; font-weight: bold; color: #333; font-size: 15px; padding: 0; cursor: pointer; }
        .status-strip select:focus { outline: none; }

        /* Dark Mode Overrides */
        html.dark-mode .app-header { border-bottom-color: #333; }
        html.dark-mode .brand-group h1 { color: #fff; }
        html.dark-mode .page-title { color: #fff; }
        html.dark-mode .page-subtitle { color: #aaa; }
        html.dark-mode .status-strip { background-color: #2c2c2c; border-color: #444; }
        html.dark-mode .status-value { color: #eee; }
        html.dark-mode .status-strip select { color: #eee; }
        html.dark-mode .status-strip select option { background-color: #2c2c2c; }
    </style>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="preload" href="{{ url_for('static', filename='fonts/roboto-v49-latin-regular.woff2') }}" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="{{ url_for('static', filename='fonts/roboto-v49-latin-700.woff2') }}" as="font" type="font/woff2" crossorigin>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/trix@2.0.0/dist/trix.css">
    <script type="text/javascript" src="https://unpkg.com/trix@2.0.0/dist/trix.umd.min.js"></script>
    {% block head_extra %}{% endblock %}
  </head>
  <body>

    {% block demo_banner %}
    {% if is_guest %}
    <div class="demo-banner">
      <strong>Demo Mode:</strong> You are viewing a read-only demo. Full functionality (like saving) is enabled for registered users.
    </div>
    {% endif %}
    {% endblock %}

    <div class="app-header">
      <div class="header-left">
          <div class="brand-group">
              <h1>
                  <span>Nova</span> DSO Tracker
                  <small>v{{ version }} <span id="update-notification"></span></small>
              </h1>
          </div>

          <div class="header-divider"></div>

          <div class="injected-title">
              {% block page_title %}{% endblock %}
          </div>
      </div>

      <div class="header-right">
          {% block header_actions %}{% endblock %}

          <div class="user-menu">
            {% if is_guest %}
                Guest Mode
                <a href="{{ url_for('login') }}" style="margin-left: 8px; color: #83b4c5; font-size: 12px; text-decoration: underline;">Login</a>
            {% elif not SINGLE_USER_MODE and current_user.is_authenticated %}
                {{ current_user.username }}
                <form action="{{ url_for('logout') }}" method="post" style="display:inline; margin-left:5px;">
                    <button type="submit" style="background:none; border:none; color:#83b4c5; cursor:pointer; padding:0; text-decoration:underline; font-size:12px;">Logout</button>
                </form>
            {% elif SINGLE_USER_MODE %}
                &nbsp;
            {% endif %}
          </div>
          <button id="theme-toggle-btn" class="action-button" onclick="toggleTheme()" title="Toggle Dark/Light Mode">Night View</button>
          <button id="red-mode-btn" class="action-button" onclick="toggleRedMode()" title="Toggle Red/Night Vision Mode">Red View</button>
      </div>
    </div>

    {% block header_content %}{% endblock %}

    {% block body %}{% endblock %}

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        // --- THEME INITIALIZATION ---
        const btn = document.getElementById('theme-toggle-btn');
        const html = document.documentElement;

        // 1. Check Dark Mode
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark-mode') {
            html.classList.add('dark-mode');
            if(btn) btn.textContent = 'Day View';
        } else {
            if(btn) btn.textContent = 'Night View';
        }

        // 2. Check Red Mode
        const savedRedMode = localStorage.getItem('red-mode');
        if (savedRedMode === 'true') {
            html.classList.add('red-mode');
        }

        // --- VERSION CHECK ---
        fetch('/api/latest_version')
            .then(response => response.json())
            .then(data => {
                if (data && data.new_version) {
                    const notificationSpan = document.getElementById('update-notification');
                    if (notificationSpan) {
                        const repo_url = data.url || `https://github.com/YOUR_GITHUB_USERNAME/YOUR_REPO_NAME/releases`;
                        notificationSpan.innerHTML = ` <span style="font-size: 0.8em; font-weight: normal; color: #83b4c5;">(<a href="${repo_url}" target="_blank" style="color: #83b4c5; text-decoration: none;" >Latest version: v${data.new_version}</a>)</span>`;
                    }
                }
            })
            .catch(error => console.error("Update check failed:", error));
    });

    // --- THEME TOGGLE FUNCTIONS ---
    function toggleTheme() {
        const html = document.documentElement;
        const btn = document.getElementById('theme-toggle-btn');

        html.classList.toggle('dark-mode');

        if (html.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark-mode');
            if(btn) btn.textContent = 'Day View';
        } else {
            localStorage.setItem('theme', '');
            if(btn) btn.textContent = 'Night View';
        }
        // Force charts to redraw if they exist
        window.dispatchEvent(new Event('resize'));
    }

    function toggleRedMode() {
        const html = document.documentElement;
        html.classList.toggle('red-mode');

        if (html.classList.contains('red-mode')) {
            localStorage.setItem('red-mode', 'true');
            // Ensure Dark Mode is ON when Red Mode is activated for best effect
            if (!html.classList.contains('dark-mode')) {
                toggleTheme();
            }
        } else {
            localStorage.setItem('red-mode', 'false');
        }
    }

    // --- HELP MODAL FUNCTIONS ---
    function openHelp(topicId) {
        const modal = document.getElementById('universal-help-modal');
        const body = document.getElementById('help-modal-body');

        // 1. Reset and show loading state
        body.innerHTML = '<div style="text-align:center; padding: 40px; color: #666;">Loading help content...</div>';
        modal.classList.add('is-visible');

        // 2. Fetch content
        fetch(`/api/help/${topicId}`)
            .then(response => response.json())
            .then(data => {
                if(data.html) {
                    body.innerHTML = data.html;
                } else {
                    body.innerHTML = '<p style="color:red">Error: Help content returned empty.</p>';
                }
            })
            .catch(err => {
                console.error(err);
                body.innerHTML = `<p style="color:red">Network Error: Could not load help topic '${topicId}'.</p>`;
            });
    }

    function closeHelpModal() {
        document.getElementById('universal-help-modal').classList.remove('is-visible');
    }
    </script>

    {% block scripts %}{% endblock %}

    <div id="universal-help-modal" onclick="closeHelpModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="help-modal-body" class="help-body"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="action-button" onclick="closeHelpModal()">Close</button>
            </div>
        </div>
    </div>
  </body>
</html>